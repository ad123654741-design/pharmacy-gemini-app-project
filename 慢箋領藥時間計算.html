<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…¢ç®‹é ˜è—¥æ—¥æœŸè¨ˆç®—æ©Ÿ | è¦ä»è—¥å¸«</title>
    <meta name="description" content="æ…¢æ€§ç—…é€£çºŒè™•æ–¹ç®‹é ˜è—¥æ—¥æœŸè¨ˆç®—å·¥å…·ï¼Œæ”¯æ´å‡æ—¥æé†’ã€è¡Œäº‹æ›†ä¸‹è¼‰èˆ‡æ³•è¦èªªæ˜ã€‚">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        /* Modal Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }
        /* Custom Scrollbar for Sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- å…§åµŒ SVG åœ–ç¤º ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Calculator = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const FileWarning = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 13v4"/><path d="M12 21h.01"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const Edit3 = (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12" y1="16" y2="16.01"/></IconBase>;
        const Pill = (props) => <IconBase {...props}><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Ban = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const PartyPopper = (props) => <IconBase {...props}><path d="M5.8 11.3 2 22l10.7-3.79"/><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/><path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 1.96L17.04 7a2.9 2.9 0 0 1-1.96 1.96L12.8 9.75a2.9 2.9 0 0 0-1.96 1.96l-.75 2.25c-.15.45-.63.75-1.1.75a1.1 1.1 0 0 1-1.09-1.39l.75-2.25a2.9 2.9 0 0 0-.75-3.12 2.9 2.9 0 0 0-3.12-.75l-2.25.75"/><path d="M11 11c-1.33 1.33-4 1.33-4 4"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;

        // --- è¨­å®šæ˜¥ç¯€å½ˆçª—çµ„ä»¶ ---
        const SpringSettingsModal = ({ 
            isOpen, onClose, 
            springStart, setSpringStart, 
            springEnd, setSpringEnd,
            springAdvanceDays, setSpringAdvanceDays 
        }) => {
            const [localStart, setLocalStart] = useState(springStart);
            const [localEnd, setLocalEnd] = useState(springEnd);
            const [localAdvanceDays, setLocalAdvanceDays] = useState(springAdvanceDays);
            const [errorMsg, setErrorMsg] = useState(""); 

            useEffect(() => {
                if(isOpen) {
                    setLocalStart(springStart);
                    setLocalEnd(springEnd);
                    setLocalAdvanceDays(springAdvanceDays);
                    setErrorMsg(""); 
                }
            }, [isOpen, springStart, springEnd, springAdvanceDays]);

            if (!isOpen) return null;

            const handleSave = () => {
                if (localStart && localEnd && localEnd < localStart) {
                    setErrorMsg("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œè«‹ä¿®æ­£ï¼");
                    return;
                }
                setSpringStart(localStart);
                setSpringEnd(localEnd);
                setSpringAdvanceDays(Number(localAdvanceDays));
                onClose();
            };

            const handleClear = () => {
                setLocalStart("");
                setLocalEnd("");
                setLocalAdvanceDays(10); // é‡ç½®ç‚ºé è¨­10å¤©(å¦‚æœéœ€è¦å®Œå…¨æ¸…ç©ºå¯è¦–éœ€æ±‚èª¿æ•´ï¼Œä½†10å¤©æ˜¯å¥ä¿å¸¸æ…‹)
                setErrorMsg("");
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 space-y-6 animate-fadeIn">
                        <div className="flex items-center justify-between border-b pb-3">
                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <Settings className="text-teal-600" /> æ˜¥ç¯€æœŸé–“æå‰é ˜è—¥è¨­å®š
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        <div className="space-y-4">
                            <p className="text-sm text-slate-600 leading-relaxed bg-blue-50 p-3 rounded-lg border border-blue-100">
                                æ ¹æ“šå¥ä¿ç½²è¦å®šï¼Œè‹¥æ…¢ç®‹ç”¨è—¥å±†æ»¿æ—¥ï¼ˆåƒå®Œæ—¥æœŸï¼‰è½åœ¨æ˜¥ç¯€æœŸé–“ï¼Œå¯æå‰é ˜è—¥ã€‚ä»Šå¹´åº¦æ”¾å¯¬ç‚º <strong>{localAdvanceDays} å¤©</strong>ã€‚
                            </p>
                            <div className="space-y-2">
                                <label className="block text-sm font-medium text-slate-700">æå‰é ˜è—¥å¤©æ•¸ (é è¨­14å¤©)</label>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="number" 
                                        value={localAdvanceDays} 
                                        onChange={(e) => setLocalAdvanceDays(e.target.value)} 
                                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                                    />
                                    <span className="text-slate-500 text-sm whitespace-nowrap">å¤©</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium text-slate-700">æ˜¥ç¯€é–‹å§‹æ—¥æœŸ</label>
                                    <input 
                                        type="date" 
                                        value={localStart} 
                                        onChange={(e) => setLocalStart(e.target.value)} 
                                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium text-slate-700">æ˜¥ç¯€çµæŸæ—¥æœŸ</label>
                                    <input 
                                        type="date" 
                                        value={localEnd} 
                                        onChange={(e) => setLocalEnd(e.target.value)} 
                                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex items-center justify-between pt-2">
                            <button 
                                onClick={handleClear}
                                className="text-slate-500 hover:text-red-600 hover:bg-slate-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1 font-medium text-sm"
                            >
                                <Trash2 size={16} /> æ¸…é™¤è¨­å®š
                            </button>
                            <div className="flex flex-col items-end gap-2">
                                {errorMsg && (
                                    <span className="text-red-600 font-bold text-sm animate-pulse">{errorMsg}</span>
                                )}
                                <button 
                                    onClick={handleSave}
                                    className="bg-teal-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-teal-700 transition-colors shadow-md"
                                >
                                    è¨­å®šå®Œæˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- æ³•è¦èˆ‡æ³¨æ„äº‹é …çµ„ä»¶ ---
        const RegulationsSection = ({ className }) => (
            <section className={`bg-white/80 backdrop-blur-sm rounded-2xl p-6 text-slate-700 space-y-5 text-base leading-relaxed border border-slate-200 shadow-sm ${className}`}>
                <div className="flex items-center gap-2 text-slate-800 font-bold border-b border-slate-300 pb-3 mb-2">
                    <BookOpen size={20} />
                    <h3 className="text-lg">ç›¸é—œæ³•è¦èˆ‡æ³¨æ„äº‹é …</h3>
                </div>
                <div className="grid grid-cols-1 gap-y-6">
                    <div>
                        <h4 className="font-bold text-slate-800 mb-1 text-base">ğŸ“… è™•æ–¹ç®‹æœ‰æ•ˆæœŸé™ (é†«ç™‚è¾¦æ³•ç¬¬22æ¢)</h4>
                        <p>æ…¢ç®‹æ•ˆæœŸä»¥ <strong>3 å€‹æœˆ</strong>ç‚ºé™ã€‚æ¯æ¬¡èª¿åŠ‘ç”¨è—¥é‡ä»¥ <strong>28-30 å¤©</strong>ç‚ºåŸå‰‡ã€‚é€¾æœŸå³å¤±æ•ˆã€‚</p>
                    </div>
                    <div>
                        <h4 className="font-bold text-slate-800 mb-1 text-base">ğŸ’Š æå‰é ˜è—¥è¦å®š (é†«ç™‚è¾¦æ³•ç¬¬24æ¢)</h4>
                        <p>é ˜è—¥æ™‚é–“ç‚ºï¼šå‰æ¬¡çµ¦è—¥æœŸé–“å±†æ»¿å‰ <strong>10 å¤©å…§</strong>ã€‚</p>
                    </div>
                    <div>
                        <h4 className="font-bold text-slate-800 mb-1 text-base">âœˆï¸ å‡ºåœ‹é é ˜è—¥å“ (é†«ç™‚è¾¦æ³•ç¬¬24æ¢)</h4>
                        <p>é å®šå‡ºåœ‹ã€è¿”é›¢å³¶æˆ–é æ´‹æ¼èˆ¹ä½œæ¥­ï¼Œå¾—å‡ºå…·è­‰æ˜æ–‡ä»¶ï¼Œ<strong>ä¸€æ¬¡é ˜å–å…¨éƒ¨ç”¨è—¥é‡</strong>ã€‚</p>
                    </div>
                    <div>
                        <h4 className="font-bold text-slate-800 mb-1 text-base">âš ï¸ éºå¤±è£œç™¼è¦å®š (é†«ç™‚è¾¦æ³•ç¬¬26æ¢)</h4>
                        <p>æ…¢ç®‹éºå¤±<strong>ä¸å¾—è£œç™¼</strong>ï¼Œéœ€é‡æ–°æ›è™Ÿå°±é†«é–‹ç«‹æ–°è™•æ–¹ã€‚</p>
                    </div>
                </div>
                <div className="bg-white p-4 rounded-lg border border-slate-200 text-sm mt-4">
                    <p className="text-slate-500">â€» ä»¥ä¸Šè³‡è¨Šæ•´ç†è‡ªã€Šå…¨æ°‘å¥åº·ä¿éšªé†«ç™‚è¾¦æ³•ã€‹ï¼Œè‹¥æœ‰ä¿®æ³•æˆ–ç•°å‹•ï¼Œè«‹ä»¥è¡›ç”Ÿç¦åˆ©éƒ¨ä¸­å¤®å¥åº·ä¿éšªç½²æœ€æ–°å…¬å‘Šç‚ºæº–ã€‚</p>
                </div>
            </section>
        );

        function App() {
            const getTaiwanToday = () => {
                try {
                    return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
                } catch (e) {
                    return new Date().toISOString().slice(0, 10);
                }
            };

            const [startDate, setStartDate] = useState(getTaiwanToday());
            const [daysPerPrescription, setDaysPerPrescription] = useState(28);
            const [totalRefills, setTotalRefills] = useState(3);
            const [results, setResults] = useState([]);
            const [actualPickupDates, setActualPickupDates] = useState({});
            const [expiryDate, setExpiryDate] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            
            const [inputErrors, setInputErrors] = useState({});

            // æ˜¥ç¯€è¨­å®šç‹€æ…‹ (é è¨­ä»Šå¹´åº¦æ—¥æœŸèˆ‡ 14 å¤©)
            const [showSpringModal, setShowSpringModal] = useState(false);
            const [springStart, setSpringStart] = useState('2026-02-14');
            const [springEnd, setSpringEnd] = useState('2026-02-22');
            const [springAdvanceDays, setSpringAdvanceDays] = useState(14);

            useEffect(() => {
                setActualPickupDates({});
                setInputErrors({});
            }, [startDate]);

            const formatDate = (dateString) => {
                if (!dateString) return '';
                try {
                    const d = new Date(dateString);
                    if (isNaN(d.getTime())) return '';
                    const year = d.getUTCFullYear();
                    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(d.getUTCDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                } catch (e) {
                    return '';
                }
            };

            const getExpiryWarning = (dateString) => {
                if (!dateString) return null;
                try {
                    const d = new Date(dateString);
                    if (isNaN(d.getTime())) return null;
                    const prevDateTimestamp = d.getTime() - 24 * 60 * 60 * 1000;
                    const prevDate = new Date(prevDateTimestamp);
                    return formatDate(prevDate.toISOString().slice(0, 10));
                } catch (e) {
                    return null;
                }
            };

            const isWeekend = (dateString) => {
                if (!dateString) return false;
                try {
                    const day = new Date(dateString).getUTCDay();
                    return day === 0 || day === 6;
                } catch (e) {
                    return false;
                }
            };

            const handleActualDateChange = (refillId, newDate, limitDate) => {
                if (!newDate) {
                    setActualPickupDates(prev => ({ ...prev, [refillId]: newDate }));
                    setInputErrors(prev => ({ ...prev, [refillId]: null }));
                    return;
                }

                if (limitDate && newDate <= limitDate) {
                    setInputErrors(prev => ({
                        ...prev,
                        [refillId]: `æ‚¨è¼¸å…¥çš„æ—¥æœŸ (${formatDate(newDate)}) æœªè¶…éå»ºè­°é ˜è—¥æœŸé™ï¼Œä¸éœ€è¦é †å»¶å–”ï¼`
                    }));
                    
                    setActualPickupDates(prev => ({ ...prev, [refillId]: '' }));
                    return;
                }

                setInputErrors(prev => ({ ...prev, [refillId]: null }));
                setActualPickupDates(prev => ({ ...prev, [refillId]: newDate }));
            };

            useEffect(() => {
                if (!startDate) return;
                try {
                    const oneDayMs = 24 * 60 * 60 * 1000;
                    const startTimestamp = new Date(startDate).getTime();
                    if (isNaN(startTimestamp)) return;

                    const totalDays = daysPerPrescription * totalRefills;
                    const expiryTimestamp = startTimestamp + (totalDays * oneDayMs);
                    const expiryDateStr = new Date(expiryTimestamp).toISOString().slice(0, 10);
                    setExpiryDate(expiryDateStr);
                    
                    const deadlineTimestamp = expiryTimestamp - oneDayMs;
                    const deadlineDateStr = new Date(deadlineTimestamp).toISOString().slice(0, 10);
                    
                    const validLimitTimestamp = deadlineTimestamp; 

                    const calcResults = [];
                    
                    const actualDateInput1 = actualPickupDates[1];
                    let effectiveStartTimestamp1 = startTimestamp;
                    
                    if (actualDateInput1) {
                        const actualTs = new Date(actualDateInput1).getTime();
                        if (!isNaN(actualTs)) {
                            effectiveStartTimestamp1 = actualTs;
                        }
                    }
                    
                    const medsEndTimestamp1 = effectiveStartTimestamp1 + (daysPerPrescription * oneDayMs);

                    calcResults.push({
                        id: 1,
                        title: 'ç¬¬ 1 æ¬¡é ˜è—¥ (å°±è¨ºæ—¥)',
                        pickupStart: startDate,
                        pickupEnd: startDate,
                        medsEnd: new Date(medsEndTimestamp1).toISOString().slice(0, 10),
                        canDownload: false,
                        isEditable: true,
                        actualDate: actualDateInput1 || '',
                        isDelayed: !!actualDateInput1,
                        isOverdue: false,
                        isSpringEarly: false,
                        isCapped: false
                    });

                    let currentBaseTimestamp = effectiveStartTimestamp1;

                    for (let i = 1; i < totalRefills; i++) {
                        const refillId = i + 1;
                        
                        const idealNextCycleStartTimestamp = currentBaseTimestamp + (daysPerPrescription * oneDayMs);
                        
                        // é è¨­é‚è¼¯ï¼šè—¥åƒå®Œå‰10å¤©
                        let pickupStartTimestamp = idealNextCycleStartTimestamp - (10 * oneDayMs);
                        const pickupEndTimestamp = idealNextCycleStartTimestamp;
                        
                        const idealMedsEndStr = new Date(idealNextCycleStartTimestamp).toISOString().slice(0, 10);
                        let isSpringEarly = false;

                        // æ˜¥ç¯€åˆ¤æ–·ï¼šè‹¥è—¥å“ç”¨å®Œæ—¥è½åœ¨æ˜¥ç¯€æœŸé–“ï¼Œæ”¹ç”¨ springAdvanceDays (ä¾‹å¦‚14å¤©)
                        if (springStart && springEnd) {
                            if (idealMedsEndStr >= springStart && idealMedsEndStr <= springEnd) {
                                const springStartTs = new Date(springStart).getTime();
                                if (!isNaN(springStartTs)) {
                                    // ä½¿ç”¨è‡ªè¨‚çš„æå‰å¤©æ•¸
                                    pickupStartTimestamp = springStartTs - (springAdvanceDays * oneDayMs);
                                    isSpringEarly = true;
                                }
                            }
                        }

                        let pickupStartStr = new Date(pickupStartTimestamp).toISOString().slice(0, 10);
                        let pickupEndStr = new Date(pickupEndTimestamp).toISOString().slice(0, 10);

                        const isOverdue = pickupStartTimestamp > deadlineTimestamp;

                        let isCapped = false;
                        if (!isOverdue && pickupEndStr > deadlineDateStr) {
                            pickupEndStr = deadlineDateStr;
                            isCapped = true;
                        }

                        const actualDateInput = actualPickupDates[refillId];
                        let effectiveStartTimestamp = idealNextCycleStartTimestamp;
                        
                        if (actualDateInput) {
                            const actualTs = new Date(actualDateInput).getTime();
                            if (!isNaN(actualTs)) {
                                effectiveStartTimestamp = actualTs;
                            }
                        }

                        const medsEndTimestamp = effectiveStartTimestamp + (daysPerPrescription * oneDayMs);
                        const finalMedsEndStr = new Date(medsEndTimestamp).toISOString().slice(0, 10);

                        calcResults.push({
                            id: refillId,
                            title: `ç¬¬ ${refillId} æ¬¡é ˜è—¥`,
                            pickupStart: pickupStartStr,
                            pickupEnd: pickupEndStr,
                            medsEnd: finalMedsEndStr,
                            canDownload: !isOverdue,
                            isEditable: true,
                            actualDate: actualDateInput || '',
                            isDelayed: !!actualDateInput,
                            isOverdue: isOverdue,
                            isSpringEarly: isSpringEarly,
                            isCapped: isCapped
                        });
                        
                        currentBaseTimestamp = effectiveStartTimestamp;
                    }
                    setResults(calcResults);
                } catch (e) {
                    console.error("Calc error", e);
                }
            }, [startDate, daysPerPrescription, totalRefills, actualPickupDates, springStart, springEnd, springAdvanceDays]);

            const downloadICS = (item) => {
                try {
                    const targetDate = item.actualDate || item.pickupStart;
                    if (!targetDate) return;
                    const eventStart = targetDate.replace(/-/g, '');
                    const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyChronicPrescriptionCalculator//TW\nBEGIN:VEVENT\nUID:${new Date().getTime()}-${item.id}@calculator\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\nDTSTART;VALUE=DATE:${eventStart}\nDTEND;VALUE=DATE:${eventStart}\nSUMMARY:æ…¢ç®‹é ˜è—¥ (${item.title})\nDESCRIPTION:é ˜è—¥å€é–“ï¼š${item.pickupStart} è‡³ ${item.pickupEnd}ã€‚\nBEGIN:VALARM\nTRIGGER:-PT15H\nDESCRIPTION:Reminder\nACTION:DISPLAY\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR`;
                    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.setAttribute('download', `æ…¢ç®‹é ˜è—¥_${targetDate}.ics`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {}
            };

            const copyToClipboard = () => {
                try {
                    const lines = [`ğŸ’Š æ…¢ç®‹é ˜è—¥æ™‚ç¨‹è¡¨`, `å°±è¨ºæ—¥: ${formatDate(startDate)}`, `------------------------`];
                    if(springStart && springEnd) {
                        lines.push(`ğŸ§§ æ˜¥ç¯€å‡æœŸ: ${formatDate(springStart)}~${formatDate(springEnd)}`);
                    }
                    results.forEach(r => {
                        if (r.id === 1) {
                            if (r.isDelayed) {
                                lines.push(`${r.title}: ${formatDate(r.actualDate)} (å·²é ˜/å»¶å¾Œ)`);
                            } else {
                                lines.push(`${r.title}: ${formatDate(r.pickupStart)} (å·²é ˜)`);
                            }
                        } else {
                            if (r.isOverdue) {
                                lines.push(`${r.title}: âš ï¸ å»ºè­°é ˜è—¥æ™‚é–“å·²è¶…éè™•æ–¹ç®‹æ•ˆæœŸï¼Œéœ€é‡æ–°çœ‹è¨ºã€‚`);
                            } else {
                                let note = "";
                                if (r.isSpringEarly) note += "(æ˜¥ç¯€æå‰)";
                                if (r.isDelayed) note += "(é †å»¶)";
                                if (r.isCapped) note += "(å—é™æ•ˆæœŸ)";
                                
                                lines.push(`${r.title}: ${formatDate(r.pickupStart)} ~ ${formatDate(r.pickupEnd)} ${note}`);
                            }
                        }
                    });
                    lines.push(`------------------------`);
                    const w = getExpiryWarning(expiryDate);
                    if (w) {
                        lines.push(`âš ï¸ è™•æ–¹ç®‹æœ‰æ•ˆæœŸé™(æœ€å¾Œé ˜è—¥æ—¥): é€¾ ${w} ç„¡æ•ˆ`);
                    } else {
                        lines.push(`âš ï¸ è™•æ–¹ç®‹æœ‰æ•ˆæœŸé™: ${formatDate(expiryDate)} æ­¢`);
                    }
                    lines.push(`ç”±ã€Œæ…¢ç®‹é ˜è—¥æ—¥æœŸè¨ˆç®—æ©Ÿã€è£½ä½œ`);
                    
                    const text = lines.join('\n');
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; 
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if(successful) {
                             setCopySuccess(true);
                             setTimeout(() => setCopySuccess(false), 2000);
                        }
                    } catch (err) {
                        console.error('Unable to copy', err);
                    }
                    document.body.removeChild(textArea);
                } catch (e) {
                    console.error("Copy logic error", e);
                }
            };

            return (
                <div className="min-h-screen text-slate-800 font-sans pb-10">
                    <SpringSettingsModal 
                        isOpen={showSpringModal} 
                        onClose={() => setShowSpringModal(false)}
                        springStart={springStart}
                        setSpringStart={setSpringStart}
                        springEnd={springEnd}
                        setSpringEnd={setSpringEnd}
                        springAdvanceDays={springAdvanceDays}
                        setSpringAdvanceDays={setSpringAdvanceDays}
                    />

                    <header className="bg-teal-600 text-white p-4 shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/20 p-2 rounded-lg">
                                    <Calculator size={28} />
                                </div>
                                <h1 className="text-2xl font-bold tracking-wide">æ…¢ç®‹é ˜è—¥æ—¥æœŸè¨ˆç®—æ©Ÿ</h1>
                            </div>
                            <div className="text-sm text-teal-50 flex flex-col md:items-end gap-1 font-mono opacity-90">
                                <p>è£½ä½œè€… : è¦ä»è—¥å¸«</p>
                                <p>æ›´æ–°æ—¥æœŸ : 2026/01/16</p>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 lg:p-8 space-y-8">
                        
                        <div className="flex flex-col lg:flex-row gap-8 items-start">
                            {/* å·¦å´æ¬„ä½ (Sticky) */}
                            <div className="w-full lg:w-1/3 space-y-6 lg:sticky lg:top-24 lg:max-h-[calc(100vh-8rem)] lg:overflow-y-auto custom-scrollbar lg:pr-2">
                                <section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-6">
                                    <div className="flex justify-between items-center border-b border-slate-100 pb-3 gap-2">
                                        <div className="flex items-center gap-2 text-teal-700 font-semibold">
                                            <Calendar className="w-6 h-6" />
                                            <h2 className="text-xl">è¨­å®šè™•æ–¹ç®‹è³‡è¨Š</h2>
                                        </div>
                                        <button 
                                            onClick={() => setShowSpringModal(true)}
                                            className="text-slate-500 hover:text-teal-600 hover:bg-slate-50 transition-all flex items-center gap-1 text-xs sm:text-sm px-2 py-1.5 rounded border border-slate-200 bg-white"
                                            title="è¨­å®šæ˜¥ç¯€å‡æœŸ"
                                        >
                                            <Settings size={14} /> æ˜¥ç¯€æå‰é ˜è—¥è¨­å®š
                                        </button>
                                    </div>

                                    {springStart && springEnd && (
                                        <div className="bg-red-50 text-red-700 text-sm px-3 py-2 rounded-lg flex items-center gap-2 border border-red-100">
                                            <PartyPopper size={16} />
                                            <span>æ˜¥ç¯€å‡æœŸï¼š{formatDate(springStart)} ~ {formatDate(springEnd)} (æå‰{springAdvanceDays}å¤©)</span>
                                        </div>
                                    )}

                                    <div className="space-y-5">
                                        <div className="space-y-2">
                                            <label className="block text-base font-medium text-slate-700">å°±è¨ºæ—¥æœŸ (ç¬¬ 1 æ¬¡é ˜è—¥)</label>
                                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-300 rounded-xl text-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all" />
                                        </div>

                                        <div className="space-y-2">
                                            <label className="block text-base font-medium text-slate-700">æ¯æ¬¡è—¥é‡å¤©æ•¸</label>
                                            <div className="flex gap-2">
                                                {[28, 29, 30].map(days => (
                                                    <button key={days} onClick={() => setDaysPerPrescription(days)} className={`flex-1 py-3 px-2 rounded-xl text-base font-medium transition-colors ${daysPerPrescription === days ? 'bg-teal-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>{days} å¤©</button>
                                                ))}
                                                <input type="number" value={daysPerPrescription} onChange={(e) => setDaysPerPrescription(Number(e.target.value))} className="w-20 p-2 text-center text-lg bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none" placeholder="è‡ªè¨‚" />
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <label className="block text-base font-medium text-slate-700">è™•æ–¹ç®‹ç¸½é ˜è—¥æ¬¡æ•¸</label>
                                            <div className="flex gap-2">
                                                {[2, 3].map(count => (
                                                    <button key={count} onClick={() => setTotalRefills(count)} className={`flex-1 py-3 px-4 rounded-xl text-base font-medium transition-colors ${totalRefills === count ? 'bg-teal-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>{count} æ¬¡</button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="bg-orange-50 border border-orange-100 rounded-xl p-4 flex flex-col gap-2">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-orange-100 p-2 rounded-full text-orange-600"><FileWarning size={20} /></div>
                                                <p className="text-sm font-bold text-orange-500 uppercase tracking-wide">è™•æ–¹ç®‹æœ‰æ•ˆæœŸé™(æœ€å¾Œé ˜è—¥æ—¥)</p>
                                            </div>
                                            
                                            {expiryDate && getExpiryWarning(expiryDate) ? (
                                                <p className="text-3xl font-bold text-orange-800 pl-2">
                                                    é€¾ {getExpiryWarning(expiryDate)} ç„¡æ•ˆ
                                                </p>
                                            ) : (
                                                <p className="text-3xl font-bold text-orange-800 pl-2">
                                                    {formatDate(expiryDate)} æ­¢
                                                </p>
                                            )}
                                            <div className="mt-2 text-right">
                                                <span className="text-xs text-orange-600 bg-white px-2 py-1 rounded border border-orange-200 font-medium">ç¸½è¨ˆ {daysPerPrescription * totalRefills} å¤©</span>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <button onClick={copyToClipboard} className={`w-full flex items-center justify-center gap-2 py-4 px-6 rounded-xl font-bold text-lg shadow-sm transition-all ${copySuccess ? 'bg-green-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:text-teal-700'}`}>
                                    {copySuccess ? <Check size={24} /> : <Copy size={24} />} {copySuccess ? 'å·²è¤‡è£½æ–‡å­—' : 'è¤‡è£½æ™‚ç¨‹è¡¨'}
                                </button>

                                {/* é›»è…¦ç‰ˆé¡¯ç¤ºæ³•è¦æ–¼å·¦å´ */}
                                <RegulationsSection className="hidden lg:block" />
                            </div>

                            {/* å³å´æ¬„ä½ï¼šçµæœé¡¯ç¤º */}
                            <div className="w-full lg:w-2/3 space-y-6">
                                <div className="flex items-center gap-2 text-slate-700 font-semibold px-2">
                                    <Clock className="w-6 h-6" />
                                    <h2 className="text-xl">å»ºè­°é ˜è—¥æ™‚ç¨‹è¡¨</h2>
                                </div>
                                
                                <div className="space-y-5">
                                    {results.map((item, index) => {
                                        const startIsWeekend = isWeekend(item.pickupStart);
                                        const isPast = item.pickupStart < getTaiwanToday();
                                        const isToday = item.pickupStart === getTaiwanToday();
                                        // ä¿®æ”¹åˆ¤å®šé‚è¼¯ï¼šåªæœ‰ç•¶æ¬¡æ•¸å°æ–¼ç¸½æ¬¡æ•¸æ™‚ï¼Œæ‰é¡¯ç¤ºè¼¸å…¥æ¡† (æœ€å¾Œä¸€æ¬¡ä¸é¡¯ç¤º)
                                        const showActualInput = item.isEditable && item.id < totalRefills;

                                        return (
                                            <div key={item.id} className={`relative overflow-hidden rounded-2xl border transition-all ${
                                                index === 0 && !item.isDelayed ? 'bg-slate-50/80 border-slate-200' : 
                                                item.isOverdue ? 'bg-red-50 border-red-200' : 
                                                item.isCapped ? 'bg-orange-50 border-orange-200' :
                                                item.isSpringEarly ? 'bg-red-50 border-red-200' :
                                                'bg-white border-slate-200 shadow-sm'
                                            }`}>
                                                <div className={`absolute left-0 top-0 bottom-0 w-2 ${
                                                    index === 0 && !item.isDelayed ? 'bg-slate-400' : 
                                                    item.isOverdue ? 'bg-red-500' : 
                                                    item.isCapped ? 'bg-orange-500' :
                                                    item.isSpringEarly ? 'bg-red-500' :
                                                    'bg-teal-500'
                                                }`}></div>
                                                
                                                <div className="p-6 pl-8">
                                                    <div className="flex justify-between items-start mb-5">
                                                        <div className="flex items-center gap-3">
                                                            <span className={`px-3 py-1.5 rounded-lg text-sm font-bold ${
                                                                index === 0 && !item.isDelayed ? 'bg-slate-200 text-slate-700' : 
                                                                item.isOverdue ? 'bg-red-100 text-red-700' : 
                                                                item.isCapped ? 'bg-orange-100 text-orange-700' :
                                                                item.isSpringEarly ? 'bg-red-100 text-red-700' :
                                                                'bg-teal-100 text-teal-900'
                                                            }`}>
                                                                {item.title}
                                                            </span>
                                                            {isToday && <span className="text-sm font-bold text-red-500 animate-pulse">ä»Šå¤©ï¼</span>}
                                                            
                                                            {item.isSpringEarly && (
                                                                <span className="text-sm font-medium text-red-700 bg-red-100 px-2 py-1 rounded border border-red-200 flex items-center gap-1">
                                                                    <PartyPopper size={14} /> æ˜¥ç¯€æå‰ ({springAdvanceDays}å¤©)
                                                                </span>
                                                            )}

                                                            {item.isDelayed && !item.isOverdue && !item.isSpringEarly && !item.isCapped && (
                                                                <span className="text-sm font-medium text-amber-700 bg-amber-50 px-2 py-1 rounded border border-amber-100 flex items-center gap-1">
                                                                    <RotateCcw size={14} /> ä¸‹æ¬¡å·²é †å»¶
                                                                </span>
                                                            )}
                                                        </div>
                                                        {item.canDownload && (<button onClick={() => downloadICS(item)} className="text-slate-400 hover:text-teal-600 transition-colors p-1" title="åŠ å…¥è¡Œäº‹æ›†"><Download size={24} /></button>)}
                                                    </div>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-y-8 gap-x-10">
                                                        <div className="space-y-3">
                                                            <div className="space-y-2">
                                                                <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">å»ºè­°é ˜è—¥æœŸé–“</p>
                                                                <div className="flex flex-col sm:flex-row sm:items-baseline sm:gap-3 flex-wrap">
                                                                    <span className={`text-3xl font-bold font-mono ${isPast ? 'text-slate-500' : item.isOverdue ? 'text-red-600 line-through' : item.isSpringEarly ? 'text-red-700' : item.isCapped ? 'text-orange-700' : 'text-teal-700'}`}>{formatDate(item.pickupStart)}</span>
                                                                    {index !== 0 && !item.isOverdue && (
                                                                        <div className="flex items-baseline gap-3">
                                                                            <span className="text-xl text-slate-400">è‡³</span>
                                                                            <span className={`text-3xl font-bold font-mono ${item.isSpringEarly ? 'text-red-700' : item.isCapped ? 'text-orange-700' : 'text-teal-700'}`}>
                                                                                {formatDate(item.pickupEnd)}
                                                                            </span>
                                                                            {item.isCapped && <span className="text-xs font-bold text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded">(å—é™æ–¼æ•ˆæœŸ)</span>}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                {item.isOverdue ? (
                                                                    <p className="text-sm text-red-700 font-bold flex items-center gap-1.5 mt-2 bg-red-100 p-2 rounded">
                                                                        <Ban size={16} /> å»ºè­°é ˜è—¥å€é–“å·²è¶…éè™•æ–¹ç®‹æ•ˆæœŸï¼Œéœ€é‡æ–°çœ‹è¨ºé–‹ç«‹è™•æ–¹ã€‚
                                                                    </p>
                                                                ) : item.isCapped ? (
                                                                    <p className="text-sm text-orange-700 font-medium flex items-center gap-1.5 bg-orange-50 p-2 rounded border border-orange-100">
                                                                        <AlertTriangle size={16} /> æ³¨æ„ï¼šé ˜è—¥æˆªæ­¢æ—¥å·²å—é™æ–¼è™•æ–¹ç®‹æ•ˆæœŸï¼Œè«‹å‹™å¿…æ–¼æœŸé™å‰é ˜å–ã€‚
                                                                    </p>
                                                                ) : item.isSpringEarly ? (
                                                                    <p className="text-sm text-red-700 font-medium flex items-center gap-1.5 bg-red-50 p-2 rounded border border-red-100">
                                                                        <PartyPopper size={16} /> å› æ‡‰æ˜¥ç¯€å‡æœŸ ({formatDate(springStart)}~{formatDate(springEnd)})ï¼Œå¯æå‰ {springAdvanceDays} å¤©é ˜è—¥ã€‚
                                                                    </p>
                                                                ) : (
                                                                    startIsWeekend && (<p className="text-sm text-red-600 font-medium flex items-center gap-1.5"><AlertCircle size={16} /> é€±æœ«æˆ–åœ‹å®šå‡æ—¥è«‹ç¢ºèªè—¥å±€æœ‰ç‡Ÿæ¥­</p>)
                                                                )}
                                                            </div>

                                                            {showActualInput && !item.isOverdue && (
                                                                <div className="mt-5 pt-4 border-t border-slate-100">
                                                                    <label className="flex items-center gap-2 text-sm font-bold text-indigo-700 mb-2 cursor-pointer group"><Edit3 size={16} /> æ™šé ˜äº†å—ï¼Ÿè¼¸å…¥å¯¦éš›é ˜è—¥æ—¥ï¼š</label>
                                                                    <div className="flex flex-col gap-2">
                                                                        <div className="flex items-center gap-2">
                                                                            <input 
                                                                                type="date" 
                                                                                value={item.actualDate} 
                                                                                onChange={(e) => handleActualDateChange(item.id, e.target.value, item.pickupEnd)} 
                                                                                className="text-base p-2 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-900 focus:ring-2 focus:ring-indigo-300 outline-none w-full sm:w-auto" 
                                                                            />
                                                                            {item.actualDate && (<button onClick={() => handleActualDateChange(item.id, '')} className="text-sm text-slate-500 hover:text-red-600 underline">é‡ç½®</button>)}
                                                                        </div>
                                                                        {inputErrors[item.id] && (
                                                                            <p className="text-sm text-red-500 flex items-center gap-1 animate-fadeIn">
                                                                                <AlertCircle size={14} /> {inputErrors[item.id]}
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {item.isDelayed && (<div className="hidden block text-sm text-slate-500 mt-1">å¯¦éš›é ˜è—¥æ—¥ï¼š{formatDate(item.actualDate)}</div>)}
                                                        </div>

                                                        <div className="space-y-3 relative md:pl-8 md:border-l md:border-slate-100">
                                                            <div>
                                                                <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">è—¥å“é è¨ˆç”¨å®Œæ—¥</p>
                                                                <div className="flex items-center gap-2 mt-2">
                                                                    <Pill className={`w-5 h-5 ${item.isOverdue ? 'text-red-300' : 'text-slate-400'}`} />
                                                                    <span className={`text-3xl font-bold font-mono ${item.isOverdue ? 'text-red-400' : 'text-slate-700'}`}>{formatDate(item.medsEnd)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ³•è¦æ–¼åº•éƒ¨ (é›»è…¦ç‰ˆéš±è—) */}
                        <RegulationsSection className="block lg:hidden mt-8" />

                        <footer className="text-center text-slate-500 text-sm py-6 leading-relaxed">
                            <p>æ­¤è¨ˆç®—çµæœåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é ˜è—¥æ—¥æœŸè«‹ä»¥è™•æ–¹ç®‹æˆ–è—¥å¸«èªªæ˜ç‚ºæº–ã€‚</p>
                        </footer>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
