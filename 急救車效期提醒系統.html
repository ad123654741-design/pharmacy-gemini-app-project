<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>急救車效期提醒系統</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    @keyframes segment-load {
      0% { width: 0%; opacity: 0.5; }
      10% { width: 5%; opacity: 1; }
      70% { width: 80%; opacity: 1; }
      100% { width: 100%; opacity: 1; }
    }
    
    /* === 精緻藥品動態特效 (穩定版) === */
    /* 輕柔懸浮 */
    @keyframes gentle-float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes gentle-float-reverse {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(10px); }
    }
    /* 呼吸光暈 */
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.2; transform: scale(0.9); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
    /* 穩定旋轉 (不位移) */
    @keyframes steady-rock {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }

    .loading-bar-box {
      width: 280px;
      height: 32px; 
      border: 2px solid #64748b; /* slate-500 */
      padding: 3px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.6);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .loading-bar-fill {
      height: 100%;
      background-image: repeating-linear-gradient(
        90deg,
        #34d399 0px, /* emerald-400 */
        #34d399 8px,
        transparent 8px,
        transparent 12px
      );
      width: 0;
      animation: segment-load 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      box-shadow: 0 0 8px rgba(52, 211, 153, 0.5);
      border-radius: 2px;
    }

    /* 其他樣式保持不變 */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 150px;
      overflow-y: auto;
      background-color: white;
      border-radius: 0 0 4px 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
      color: #1f2937;
      font-size: 0.875rem;
    }
    .autocomplete-item:hover {
      background-color: #e9e9e9;
    }
    .pie-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    @media print {
        @page { margin: 1cm; }
        body { 
          font-family: system-ui, sans-serif; 
          padding-bottom: 50px; 
          background-color: white; 
          color: black;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        .no-print { display: none !important; }
        .page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            border-top: 1px solid #ccc;
            padding-top: 5px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const Icons = {
      Truck: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"></path><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"></path><circle cx="7" cy="18" r="2"></circle><circle cx="17" cy="18" r="2"></circle></svg>,
      Layout: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>,
      List: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
      PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
      Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
      PlusCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>,
      XCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>,
      Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
      Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>,
      AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>,
      Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
      Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>,
      Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
      Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
      Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>,
      Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"></path><path d="M4 19c0-5.523 4.477-10 10-10 1.95 0 3.766.559 5.313 1.526"></path><path d="M20 19c0-3.037-2.463-5.5-5.5-5.5-1.077 0-2.083.313-2.935.856"></path><path d="M22 19c0-7.18-5.82-13-13-13-1.859 0-3.633.388-5.253 1.092"></path></svg>,
      ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      Mail: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>,
      Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
      Bell: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>,
      BellOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13.73 21a2 2 0 0 1-3.46 0"></path><path d="M18.63 13A17.89 17.89 0 0 1 18 8"></path><path d="M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14"></path><path d="M18 8a6 6 0 0 0-9.33-5"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>,
      AmbulanceBig: () => <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-rose-500"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"></path><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"></path><circle cx="7" cy="18" r="2"></circle><circle cx="17" cy="18" r="2"></circle><path d="M10 2v4h4V2z"></path><path d="M7 2h2"></path><path d="M15 2h2"></path></svg>,
      Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
      Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
      Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
      Clipboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
      ClipboardCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="m9 14 2 2 4-4"/></svg>,
      Tool: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
      Stats: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
      
      // === "Medical Composition" Icon (精緻可愛急救箱組合 - 絕對置中版) ===
      MedicalComposition: () => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200" className="w-full max-w-[400px] h-auto overflow-visible">
            {/* Background Glow (Centered at 200, 100) */}
            <circle cx="200" cy="100" r="100" fill="url(#blue-glow)" className="animate-[pulse-glow_4s_ease-in-out_infinite]" opacity="0.3" />
            <defs>
              <radialGradient id="blue-glow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.5" />
                <stop offset="100%" stopColor="#3b82f6" stopOpacity="0" />
              </radialGradient>
            </defs>
            
            {/* Decor Particles */}
            <g transform="translate(90, 40)"><circle cx="0" cy="0" r="3" fill="#60a5fa" className="animate-[gentle-float_3s_ease-in-out_infinite]" opacity="0.6" /></g>
            <g transform="translate(310, 160)"><circle cx="0" cy="0" r="2" fill="#f472b6" className="animate-[gentle-float_4s_ease-in-out_infinite_1s]" opacity="0.6" /></g>

            {/* --- First Aid Kit (Absolute Center) --- */}
            {/* Box is 90 wide. Center X = 200. Start X = 200 - 45 = 155. */}
            <g transform="translate(155, 65)">
               <g className="animate-[gentle-float_6s_ease-in-out_infinite]">
                  {/* Handle */}
                  <path d="M30,0 L60,0 Q65,0 65,10 L65,15 L25,15 L25,10 Q25,0 30,0 Z" fill="none" stroke="#475569" strokeWidth="4" />
                  {/* Body */}
                  <rect x="0" y="15" width="90" height="70" rx="12" fill="#f8fafc" stroke="#475569" strokeWidth="3" />
                  {/* Cross */}
                  <rect x="40" y="30" width="10" height="30" rx="1" fill="#ef4444" />
                  <rect x="30" y="40" width="30" height="10" rx="1" fill="#ef4444" />
                  {/* Clasps */}
                  <rect x="15" y="15" width="8" height="6" rx="1" fill="#94a3b8" stroke="#475569" strokeWidth="2" />
                  <rect x="67" y="15" width="8" height="6" rx="1" fill="#94a3b8" stroke="#475569" strokeWidth="2" />
               </g>
            </g>

            {/* --- Pill (Far Left) --- */}
            {/* Position at x=60, y=90 */}
            <g transform="translate(60, 90)">
                <g className="animate-[gentle-float-reverse_5s_ease-in-out_infinite]" style={{ transformOrigin: '25px 11px' }}>
                     <g transform="rotate(-20)">
                        <rect x="0" y="0" width="50" height="22" rx="11" fill="#fef08a" stroke="#475569" strokeWidth="2" />
                        <path d="M25,0 L25,22" stroke="#475569" strokeWidth="2" />
                        <path d="M11,0 L25,0 L25,22 L11,22 Q0,22 0,11 Q0,0 11,0 Z" fill="#ef4444" opacity="0.8"/>
                        <path d="M5,6 Q5,6 45,6" stroke="white" strokeWidth="2" strokeLinecap="round" opacity="0.6" />
                     </g>
                </g>
            </g>

            {/* --- Vial (Right) --- */}
            {/* Position at x=300, y=80 */}
            <g transform="translate(300, 80)">
                <g className="animate-[gentle-float_7s_ease-in-out_infinite_0.5s]" style={{ transformOrigin: '10px 22px' }}>
                     <g transform="rotate(15)">
                        <rect x="0" y="8" width="20" height="36" fill="#bfdbfe" stroke="#475569" strokeWidth="2" rx="2" />
                        <rect x="0" y="0" width="20" height="8" fill="#64748b" stroke="#475569" strokeWidth="2" rx="1" />
                        <rect x="4" y="20" width="12" height="12" fill="white" opacity="0.6" />
                        <line x1="6" y1="24" x2="16" y2="24" stroke="#475569" strokeWidth="1" />
                        <line x1="6" y1="28" x2="16" y2="28" stroke="#475569" strokeWidth="1" />
                     </g>
                </g>
            </g>
        </svg>
      )
    };

    // ... existing SystemModal component ...
    const SystemModal = ({ config, onClose }) => {
      if (!config) return null;
      return (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className={`px-5 py-3 border-b flex justify-between items-center ${config.type === 'error' ? 'bg-rose-100 border-rose-200 text-rose-700' : 'bg-slate-100 border-slate-200 text-slate-700'}`}>
              <h3 className="font-bold text-lg flex items-center gap-2">
                {config.type === 'error' ? <Icons.AlertTriangle /> : (config.icon || <Icons.AmbulanceBig className="w-5 h-5" />)} 
                {config.title}
              </h3>
              <button onClick={onClose}><Icons.XCircle className="w-5 h-5 opacity-50 hover:opacity-100" /></button>
            </div>
            <div className="p-5 text-gray-700 whitespace-pre-wrap leading-relaxed">
              {config.customBody ? config.customBody : config.message}
            </div>
            <div className="p-4 bg-gray-50 border-t flex gap-3 justify-end">
              {config.onConfirm ? (
                <>
                  <button onClick={onClose} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold hover:bg-gray-100">取消</button>
                  <button onClick={() => { config.onConfirm(); onClose(); }} className="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-sm">確認執行</button>
                </>
              ) : (
                <button onClick={onClose} className="w-full px-4 py-2 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-700">關閉</button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ... existing AutoCompleteInput ...
    const AutoCompleteInput = ({ value, onChange, options = [], placeholder }) => {
      const [suggestions, setSuggestions] = useState([]);
      const [showSuggestions, setShowSuggestions] = useState(false);
      const inputRef = useRef(null);

      useEffect(() => {
        const handleClickOutside = (event) => {
          if (inputRef.current && !inputRef.current.contains(event.target)) {
            setShowSuggestions(false);
          }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, []);

      const handleChange = (e) => {
        const val = e.target.value;
        onChange(e);
        if (val.length > 0) {
          const filtered = options.filter(
            (item) => item.toUpperCase().indexOf(val.toUpperCase()) > -1
          );
          setSuggestions(filtered);
          setShowSuggestions(true);
        } else {
          setShowSuggestions(false);
        }
      };

      const handleSuggestionClick = (suggestion) => {
        onChange({ target: { value: suggestion } });
        setSuggestions([]);
        setShowSuggestions(false);
      };

      return (
        <div className="relative" ref={inputRef}>
          <input
            type="text"
            placeholder={placeholder}
            value={value}
            onChange={handleChange}
            onFocus={(e) => handleChange(e)}
            className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none"
          />
          {showSuggestions && suggestions.length > 0 && (
            <ul className="autocomplete-items">
              {suggestions.map((suggestion, index) => (
                <li
                  key={index}
                  onClick={() => handleSuggestionClick(suggestion)}
                  className="autocomplete-item"
                >
                  {suggestion}
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    };

    // ... existing SmartExpiryInput ...
    const SmartExpiryInput = ({ value, onChange }) => {
      const [y, setY] = useState('');
      const [m, setM] = useState('');
      const [d, setD] = useState('');
      const refY = useRef(null);
      const refM = useRef(null);
      const refD = useRef(null);

      useEffect(() => {
        if (!value) { setY(''); setM(''); setD(''); return; }
        const parts = value.split('-');
        setY(parts[0] || ''); setM(parts[1] || ''); setD(parts[2] || '');
      }, [value]);

      const triggerChange = (newY, newM, newD) => {
        let finalStr = `${newY}`;
        if (newM) finalStr += `-${newM}`;
        if (newD) finalStr += `-${newD}`;
        onChange(finalStr);
      };

      const handleYearChange = (e) => {
        const val = e.target.value.slice(0, 4);
        setY(val); triggerChange(val, m, d);
        if (val.length === 4) refM.current.focus();
      };
      
      const handleMonthChange = (e) => {
        let val = e.target.value.slice(0, 2);
        if (val.length === 2 && parseInt(val) > 12) val = '12';
        setM(val); triggerChange(y, val, d);
        if (val.length === 2) refD.current.focus();
      };
      
      const handleDayChange = (e) => {
        let val = e.target.value.slice(0, 2);
        if (val.length === 2 && parseInt(val) > 31) val = '31';
        setD(val); triggerChange(y, m, val);
      };

      const handleKeyDown = (e, currentVal, prevRef) => {
        if (e.key === 'Backspace' && currentVal === '' && prevRef) {
          e.preventDefault(); 
          prevRef.current.focus();
        }
      };

      return (
        <div className="flex items-center gap-1">
          <div className="relative group">
            <input ref={refY} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="YYYY" value={y} onChange={handleYearChange} className="w-14 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">年</span>
          </div>
          <div>
          <span className="text-gray-400 font-bold">-</span>
          </div>
          <div className="relative group">
            <input ref={refM} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="MM" value={m} onChange={handleMonthChange} onKeyDown={(e)=>handleKeyDown(e,m,refY)} className="w-10 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">月</span>
          </div>
          <div>
          <span className="text-gray-400 font-bold">-</span>
          </div>
          <div className="relative group">
            <input ref={refD} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="DD" value={d} onChange={handleDayChange} onKeyDown={(e)=>handleKeyDown(e,d,refM)} className="w-10 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all placeholder-gray-300" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">日</span>
          </div>
        </div>
      );
    };
    
    // === Analysis Modal Component ===
    const AnalysisModal = ({ trays, activeTrayId, onClose, reportMode }) => {
        const targetTrayId = String(activeTrayId);
        let items = [];
        
        trays.forEach(tray => {
            if (reportMode === 'current' && String(tray.id) !== targetTrayId) return;
            if (!tray.slots) return;
            
            tray.slots.forEach(slot => {
                if (!slot.batches) return;
                slot.batches.forEach(batch => {
                    // Reusing logic but avoiding getStatus hoisting issue by redefining simple checker
                    const strExpiry = String(batch.expiry || '').trim();
                    let type = 'ok';
                    if (strExpiry) {
                        const parts = strExpiry.split('-');
                        if(parts.length >= 2) {
                             const expY = parseInt(parts[0], 10);
                             const expM = parseInt(parts[1], 10);
                             const expD = parts[2] ? parseInt(parts[2], 10) : null;
                             const today = new Date();
                             today.setHours(0,0,0,0);
                             let isExpired = false;
                             if(expD !== null && !isNaN(expD)) {
                                 if(new Date(expY, expM-1, expD) < today) isExpired = true;
                             } else {
                                 if(((expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1))) < 0) isExpired = true;
                             }
                             if(isExpired) type = 'expired';
                             else if(((expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1))) < 6) type = 'warning';
                        }
                    }

                    if (reportMode === 'all_abnormal') {
                        if (type === 'expired' || type === 'warning') {
                            items.push({ ...batch, slotName: slot.name, trayName: tray.name, status: type });
                        }
                    } else {
                        items.push({ ...batch, slotName: slot.name, trayName: tray.name, status: type });
                    }
                });
            });
        });

        const stats = { ok: 0, warning: 0, expired: 0 };
        items.forEach(i => {
            if (i.status === 'ok') stats.ok++;
            else if (i.status === 'warning') stats.warning++;
            else if (i.status === 'expired') stats.expired++;
        });

        const total = stats.ok + stats.warning + stats.expired;
        const pExpired = total > 0 ? (stats.expired / total) * 100 : 0;
        const pWarning = total > 0 ? (stats.warning / total) * 100 : 0;
        const pOk = total > 0 ? (stats.ok / total) * 100 : 0;

        const stop1 = pExpired;
        const stop2 = pExpired + pWarning;
        const gradient = `conic-gradient(#e11d48 0% ${stop1}%, #f59e0b ${stop1}% ${stop2}%, #059669 ${stop2}% 100%)`;

        let title = '';
        if (reportMode === 'current') title = `效期分析 - ${trays.find(t=>String(t.id)===targetTrayId)?.name}`;
        else if (reportMode === 'all_data') title = '效期分析 - 全院資料';
        else title = '效期分析 - 全院異常';

        const abnormalItems = items.filter(i => i.status === 'expired' || i.status === 'warning');
        
        const trayCounts = {};
        const drugCounts = {};
        
        abnormalItems.forEach(i => {
             trayCounts[i.trayName] = (trayCounts[i.trayName] || 0) + 1;
             drugCounts[i.slotName] = (drugCounts[i.slotName] || 0) + 1;
        });
        
        const sortedTrays = Object.entries(trayCounts).sort((a,b) => b[1] - a[1]);
        const sortedDrugs = Object.entries(drugCounts).sort((a,b) => b[1] - a[1]).slice(0, 5); // Top 5
        const maxTrayCount = sortedTrays.length > 0 ? sortedTrays[0][1] : 1;

        const handleExport = () => {
             const printWindow = window.open('', '_blank');
             printWindow.document.write(`
                <html>
                  <head>
                    <title>${title}</title>
                    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
                    <style>
                      @media print {
                          body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                          .no-print { display: none !important; }
                      }
                      body { font-family: system-ui, sans-serif; padding: 20px; }
                      .pie-chart { width: 250px; height: 250px; border-radius: 50%; margin: 0 auto; }
                      .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
                    </style>
                  </head>
                  <body>
                    <div style="max-width: 1000px; margin: 0 auto;">
                       <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center;">${title}</h1>
                       <div style="display: flex; gap: 40px; margin-bottom: 30px; justify-content: center; align-items: center;">
                           <div style="text-align: center;">
                               <div class="pie-chart" style="background: ${gradient}"></div>
                               <div style="font-size: 18px; font-weight: bold; margin-top: 10px;">總批號數: ${total}</div>
                           </div>
                           <div style="font-size: 14px;">
                              <div style="margin: 10px 0;"><span class="legend-dot" style="background: #e11d48;"></span>危險: ${stats.expired} (${Math.round(pExpired)}%)</div>
                              <div style="margin: 10px 0;"><span class="legend-dot" style="background: #f59e0b;"></span>預警: ${stats.warning} (${Math.round(pWarning)}%)</div>
                              <div style="margin: 10px 0;"><span class="legend-dot" style="background: #059669;"></span>安全: ${stats.ok} (${Math.round(pOk)}%)</div>
                           </div>
                       </div>
                       
                       <div style="display: flex; gap: 20px;">
                           <div style="flex: 1; border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px;">
                               <h3 style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">異常熱點分析 (按藥盤)</h3>
                               ${sortedTrays.length === 0 ? '<div style="color:#888; text-align:center;">無異常</div>' : sortedTrays.map(([name, count]) => `
                                   <div style="margin-bottom: 8px;">
                                       <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                                           <span>${name}</span>
                                           <span>${count}</span>
                                       </div>
                                       <div style="background:#f3f4f6; height:8px; border-radius:4px; overflow:hidden;">
                                           <div style="background:#e11d48; width:${(count/maxTrayCount)*100}%; height:100%;"></div>
                                       </div>
                                   </div>
                               `).join('')}
                           </div>
                           <div style="flex: 1; border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px;">
                               <h3 style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">高風險藥品 Top 5</h3>
                               <table style="width:100%; font-size: 12px; text-align: left;">
                                   ${sortedDrugs.length === 0 ? '<tr><td style="color:#888; text-align:center;">無異常</td></tr>' : sortedDrugs.map(([name, count], idx) => `
                                       <tr style="border-bottom: 1px solid #f3f4f6;">
                                           <td style="padding: 5px 0; width: 20px; color: #666;">${idx+1}.</td>
                                           <td style="padding: 5px 0;">${name}</td>
                                           <td style="padding: 5px 0; text-align: right; color: #e11d48; font-weight: bold;">${count}</td>
                                       </tr>
                                   `).join('')}
                               </table>
                           </div>
                       </div>

                       <div style="margin-top: 30px; color: #666; font-size: 12px; text-align: right;">列印時間: ${new Date().toLocaleString()}</div>
                    </div>
                    <script>setTimeout(() => window.print(), 500);<\/script>
                  </body>
                </html>
             `);
             printWindow.document.close();
        };

        return (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-in fade-in zoom-in duration-200">
                <div id="analysis-content" className="bg-slate-800 w-full max-w-6xl rounded-2xl shadow-2xl p-6 md:p-8 border border-slate-700 flex flex-col md:flex-row gap-8 overflow-y-auto max-h-[95vh] relative">
                    {/* Updated Header with side-by-side buttons */}
                    <div className="flex justify-between items-center border-b border-slate-700 pb-4 mb-4 w-full md:hidden">
                        <h3 className="text-xl font-bold text-white">{title}</h3>
                        <div className="flex items-center gap-4">
                            <button onClick={handleExport} className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center gap-1 no-print"><Icons.Download /> 匯出</button>
                            <button onClick={onClose} className="text-slate-400 hover:text-white no-print"><Icons.XCircle className="w-8 h-8"/></button>
                        </div>
                    </div>
                    
                    {/* Left Column: Pie Chart */}
                    <div className="w-full md:w-1/3 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-slate-700 pb-6 md:pb-0 md:pr-6">
                        <div className="relative w-56 h-56 shrink-0 mb-6">
                            <div className="w-full h-full rounded-full shadow-lg" style={{ background: gradient }}></div>
                            <div className="absolute inset-0 m-auto w-40 h-40 bg-slate-800 rounded-full flex flex-col items-center justify-center">
                                <span className="text-3xl font-bold text-white">{total}</span>
                                <span className="text-xs text-slate-400 mt-1">總批號數</span>
                            </div>
                        </div>
                        <div className="w-full space-y-3">
                             <div className="flex justify-between items-center text-sm">
                                <span className="flex items-center text-rose-400 font-bold"><span className="pie-legend-dot bg-rose-600"></span>危險 (&lt;6月/過期)</span>
                                <span className="text-white font-mono">{stats.expired} ({Math.round(pExpired)}%)</span>
                             </div>
                             <div className="flex justify-between items-center text-sm">
                                <span className="flex items-center text-amber-400 font-bold"><span className="pie-legend-dot bg-amber-500"></span>預警 (6月-1年)</span>
                                <span className="text-white font-mono">{stats.warning} ({Math.round(pWarning)}%)</span>
                             </div>
                             <div className="flex justify-between items-center text-sm">
                                <span className="flex items-center text-emerald-400 font-bold"><span className="pie-legend-dot bg-emerald-600"></span>安全 (&gt;1年)</span>
                                <span className="text-white font-mono">{stats.ok} ({Math.round(pOk)}%)</span>
                             </div>
                        </div>
                    </div>

                    {/* Right Column: Detailed Analytics */}
                    <div className="flex-1 w-full space-y-6">
                        <div className="hidden md:flex justify-between items-center border-b border-slate-700 pb-4">
                            <h3 className="text-2xl font-bold text-white">{title}</h3>
                            <div className="flex items-center gap-4">
                                <button onClick={handleExport} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 text-sm no-print"><Icons.Download /> 匯出報告</button>
                                <button onClick={onClose} className="text-slate-400 hover:text-white no-print"><Icons.XCircle className="w-8 h-8"/></button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Bar Chart: By Tray */}
                            <div className="bg-slate-700/30 p-4 rounded-xl border border-slate-600">
                                <h4 className="text-slate-300 font-bold mb-4 flex items-center gap-2"><Icons.Stats /> 異常熱點 (按藥盤)</h4>
                                <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    {sortedTrays.length === 0 ? <div className="text-slate-500 text-center py-4">無異常</div> : 
                                      sortedTrays.map(([name, count]) => (
                                        <div key={name}>
                                            <div className="flex justify-between text-xs text-slate-300 mb-1">
                                                <span>{name}</span>
                                                <span className="font-mono">{count}</span>
                                            </div>
                                            <div className="w-full bg-slate-600 rounded-full h-2">
                                                <div className="bg-rose-500 h-2 rounded-full transition-all duration-500" style={{width: `${(count/maxTrayCount)*100}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* List: Top Drugs */}
                            <div className="bg-slate-700/30 p-4 rounded-xl border border-slate-600">
                                <h4 className="text-slate-300 font-bold mb-4 flex items-center gap-2"><Icons.AlertTriangle /> 高風險藥品 Top 5</h4>
                                <div className="space-y-2">
                                    {sortedDrugs.length === 0 ? <div className="text-slate-500 text-center py-4">無異常</div> :
                                      sortedDrugs.map(([name, count], idx) => (
                                        <div key={name} className="flex justify-between items-center text-sm p-2 rounded hover:bg-slate-700/50">
                                            <div className="flex items-center gap-2">
                                                <span className="text-slate-500 font-mono w-4">{idx+1}.</span>
                                                <span className="text-slate-200 truncate max-w-[120px]">{name}</span>
                                            </div>
                                            <span className="bg-rose-900/50 text-rose-400 px-2 py-0.5 rounded font-mono font-bold text-xs">{count}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="text-right text-slate-500 text-xs mt-4">
                            * 統計範圍包含「過期」與「近效期」項目
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // === 主應用程式 ===
    const App = () => {
      const [mode, setMode] = useState('view');
      const GRID_COLS = 40;
      const GRID_ROWS = 30;
      const DEFAULT_GS_URL = "https://script.google.com/macros/s/AKfycbw9P7K5tSHkAI-KOQKEuEqyIYszLUVfLiUOZDcZSTMZr9k96ME2r_NHETo1RgNSpbQZjA/exec";
      
      const [gsUrl, setGsUrl] = useState(() => localStorage.getItem('gs_url') || DEFAULT_GS_URL);
      const [syncStatus, setSyncStatus] = useState('idle'); 
      const [mailConfig, setMailConfig] = useState(() => {
        try { return JSON.parse(localStorage.getItem('ecart_mail_config')) || { email: '', apiUrl: '' }; } 
        catch (e) { return { email: '', apiUrl: '' }; }
      });
      
      const [showMailModal, setShowMailModal] = useState(false);
      const [isMailTesting, setIsMailTesting] = useState(false);
      const [drugList, setDrugList] = useState([]);
      const [showPasscodeModal, setShowPasscodeModal] = useState(false);
      const [passcodeInput, setPasscodeInput] = useState('');
      const [modalConfig, setModalConfig] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [reportMode, setReportMode] = useState('current');
      
      // Feature: Paste Mode & Clipboard
      const [clipboard, setClipboard] = useState(null); 
      const [pasteMode, setPasteMode] = useState(false);
      
      // Feature: Analysis Modal
      const [showAnalysis, setShowAnalysis] = useState(false);

      const [trays, setTrays] = useState(() => {
        const saved = localStorage.getItem('ecart_data_cache');
        return saved ? JSON.parse(saved) : [{ id: '1', name: '第一層', slots: [] }];
      });
      const [activeTrayId, setActiveTrayId] = useState(trays[0].id);
      
      const [selectedSlot, setSelectedSlot] = useState(null);
      const [editForm, setEditForm] = useState(null);
      const [trayMenuOpen, setTrayMenuOpen] = useState(false);
      const [trayEditForm, setTrayEditForm] = useState({ name: '' });
      const [isDeleteConfirming, setIsDeleteConfirming] = useState(false);
      const [isTraySelectorOpen, setIsTraySelectorOpen] = useState(false);
      const [isDrawing, setIsDrawing] = useState(false);
      const [dragStart, setDragStart] = useState(null);
      const [dragCurrent, setDragCurrent] = useState(null);
      
      // New: Advanced Settings Menu
      const [showAdvancedMenu, setShowAdvancedMenu] = useState(false);
      
      const gridContainerRef = useRef(null);
      const fileInputRef = useRef(null); // For import

      const activeTray = trays.find(t => String(t.id) === String(activeTrayId)) || trays[0];

      // ... existing fetch/save logic ...
      const fetchFromSheet = async (url = gsUrl) => {
        if (!url) { setIsLoading(false); return; }
        setSyncStatus('syncing');
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) {
            setTrays(data);
            localStorage.setItem('ecart_data_cache', JSON.stringify(data));
            if (!data.find(t => String(t.id) === String(activeTrayId))) {
              setActiveTrayId(data[0].id);
            }
            setSyncStatus('success');
          } else {
            setSyncStatus('success');
          }
          fetch(url + "?action=getDrugs").then(r => r.json()).then(list => { if(Array.isArray(list)) setDrugList(list); }).catch(e => console.warn(e));
        } catch (e) {
          console.error("Load failed", e);
          setSyncStatus('error');
        } finally {
          setTimeout(() => setSyncStatus('idle'), 2000);
          setTimeout(() => setIsLoading(false), 1500);
        }
      };

      const saveToSheet = async (newData) => {
        setTrays(newData);
        localStorage.setItem('ecart_data_cache', JSON.stringify(newData));
        if (!gsUrl) return;
        setSyncStatus('syncing');
        try {
          await fetch(gsUrl, { method: 'POST', body: JSON.stringify(newData), headers: { 'Content-Type': 'text/plain' } });
          setSyncStatus('success');
        } catch (e) {
          console.error("Save failed", e);
          setSyncStatus('error');
        } finally {
          setTimeout(() => setSyncStatus('idle'), 2000);
        }
      };

      useEffect(() => { if (gsUrl) fetchFromSheet(); else setIsLoading(false); }, []);

      // ... existing Auth & Helper functions ...
      const handleAdminAccess = () => { setPasscodeInput(''); setShowPasscodeModal(true); };
      const verifyPasscode = () => {
        if (passcodeInput === '789') { setMode('admin'); setShowPasscodeModal(false); setSelectedSlot(null); } 
        else { setModalConfig({ title: "錯誤", message: "通行碼錯誤", type: 'error' }); }
      };

      const getStatus = (expiry) => {
        const strExpiry = String(expiry || '').trim();
        if (!strExpiry) return { type: 'empty', bg: 'bg-slate-700', border: 'border-slate-600', text: 'text-slate-400', label: '未設定' };
        const parts = strExpiry.split('-');
        if (parts.length < 2) return { type: 'empty', bg: 'bg-slate-700', border: 'border-slate-600', text: 'text-slate-400', label: '未設定' };
        const expY = parseInt(parts[0], 10);
        const expM = parseInt(parts[1], 10);
        const expD = parts[2] ? parseInt(parts[2], 10) : null;
        if (isNaN(expY) || isNaN(expM)) return { type: 'empty', bg: 'bg-slate-700', border: 'border-slate-600', text: 'text-slate-400', label: '未設定' };
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let isExpired = false;
        if (expD !== null && !isNaN(expD)) {
            const expiryDate = new Date(expY, expM - 1, expD);
            if (expiryDate < today) isExpired = true;
        } else {
            const currentMonthDiff = (expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1));
            if (currentMonthDiff < 0) isExpired = true;
        }
        if (isExpired) return { type: 'expired', bg: 'bg-rose-600', border: 'border-rose-600', text: 'text-white', label: '過期' };
        const diffMonths = (expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1));
        if (diffMonths < 6) return { type: 'warning', bg: 'bg-amber-500', border: 'border-amber-500', text: 'text-white', label: '近效期' };
        return { type: 'ok', bg: 'bg-emerald-600', border: 'border-emerald-600', text: 'text-white', label: '正常' };
      };

      const getSlotOverallStatus = (batches) => {
        if (!batches || batches.length === 0) return 'border-slate-600 bg-slate-800';
        let worstPriority = 0; 
        let resultClass = 'border-slate-600 bg-slate-800';
        batches.forEach(b => {
          const s = getStatus(b.expiry);
          let p = 0;
          if (s.type === 'expired') p = 3; else if (s.type === 'warning') p = 2; else if (s.type === 'ok') p = 1;
          if (p > worstPriority) {
            worstPriority = p;
            if (s.type === 'expired') resultClass = 'border-rose-500 bg-rose-900/40';
            else if (s.type === 'warning') resultClass = 'border-yellow-500 bg-yellow-900/40';
            else if (s.type === 'ok') resultClass = 'border-emerald-500 bg-slate-700';
          }
        });
        return resultClass;
      };

      const getSortedBatches = (batches) => {
        if (!batches) return [];
        return [...batches].sort((a, b) => {
          const dateA = a.expiry || '9999-99-99';
          const dateB = b.expiry || '9999-99-99';
          if (dateA < dateB) return -1;
          if (dateA > dateB) return 1;
          return 0;
        });
      };
      
      const getTotalQty = (batches) => batches ? batches.reduce((acc, b) => acc + (parseInt(b.qty)||0), 0) : 0;
      
      const calculateExpiryStats = () => {
        let stats = { ok: 0, warning: 0, expired: 0 };
        activeTray.slots.forEach(slot => {
            if(slot.batches) {
                slot.batches.forEach(b => {
                    const s = getStatus(b.expiry);
                    if (s.type === 'ok') stats.ok++;
                    else if (s.type === 'warning') stats.warning++;
                    else if (s.type === 'expired') stats.expired++;
                });
            }
        });
        return stats;
      };

      // Backup & Restore
      const handleExportJSON = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trays));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "emergency_cart_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        setShowAdvancedMenu(false);
      };

      // 修正：資料還原功能
      const handleImportJSON = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json) && json.length > 0 && json[0].slots) {
                    if(confirm("確定要還原此備份檔嗎？目前的資料將被覆蓋。")) {
                        // 1. 更新 LocalStorage (同步)
                        localStorage.setItem('ecart_data_cache', JSON.stringify(json));
                        
                        // 2. 更新 React State
                        setTrays(json);
                        
                        // 3. 上傳雲端 (非同步)
                        if (gsUrl) {
                             fetch(gsUrl, { method: 'POST', body: JSON.stringify(json), headers: { 'Content-Type': 'text/plain' } });
                        }
                        
                        // 4. 強制重整頁面
                        alert("還原成功！系統將自動重新整理。");
                        window.location.reload();
                    }
                } else {
                    alert("無效的備份檔案格式：請確認檔案是否正確。");
                }
            } catch (err) {
                alert("檔案讀取失敗：" + err.message);
            }
        };
        reader.readAsText(file);
        event.target.value = null; // reset
        setShowAdvancedMenu(false);
      };

      // Copy Paste Logic
      const handleCopyBatch = (batch) => {
        setClipboard({ expiry: batch.expiry, qty: batch.qty, ignoreAlert: false }); 
        setPasteMode(true); 
      };

      const handlePasteBatch = (targetSlot) => {
        if (!clipboard) return;
        const newBatch = {
            id: Date.now(),
            expiry: clipboard.expiry,
            qty: clipboard.qty,
            ignoreAlert: false
        };
        const updatedSlots = activeTray.slots.map(s => {
            if (s.id === targetSlot.id) {
                return { ...s, batches: [newBatch, ...(s.batches || [])] };
            }
            return s;
        });
        const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t);
        saveToSheet(newData);
        
        const div = document.createElement('div');
        div.textContent = `已貼上效期 ${clipboard.expiry}`;
        div.className = "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-4 py-2 rounded-lg z-50 animate-bounce";
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
      };

      // ... existing UI helpers ...
      const getTrayOverallStatus = (tray) => { 
        let status = 'ok'; if (!tray.slots) return 'ok';
        let hasExpired = false; let hasWarning = false;
        for (const slot of tray.slots) { if (slot.batches) { for (const batch of slot.batches) { const s = getStatus(batch.expiry); if (s.type === 'expired') hasExpired = true; else if (s.type === 'warning') hasWarning = true; } } }
        if (hasExpired) return 'expired'; if (hasWarning) return 'warning'; return 'ok';
      };
      
      const getAllHospitalItems = () => { 
        const items = [];
        trays.forEach(tray => { 
          if (!tray.slots) return; 
          tray.slots.forEach(slot => { 
            if (!slot.batches) return; 
            slot.batches.forEach(batch => { 
              const s = getStatus(batch.expiry); 
              // Removed filter to include ALL items
              items.push({ ...batch, slotName: slot.name, highAlert: slot.highAlert, requiredQty: slot.requiredQty, trayName: tray.name, statusObj: s }); 
            }); 
          }); 
        });
        return items.sort((a, b) => { if (a.trayName !== b.trayName) return a.trayName.localeCompare(b.trayName); return (a.expiry || '9999').localeCompare(b.expiry || '9999'); });
      };

      const getAllAbnormalItems = () => { 
        const items = [];
        trays.forEach(tray => { 
          if (!tray.slots) return; 
          tray.slots.forEach(slot => { 
            if (!slot.batches) return; 
            slot.batches.forEach(batch => { 
              const s = getStatus(batch.expiry); 
              if (s.type === 'expired' || s.type === 'warning') {
                items.push({ ...batch, slotName: slot.name, highAlert: slot.highAlert, requiredQty: slot.requiredQty, trayName: tray.name, statusObj: s }); 
              }
            }); 
          }); 
        });
        return items.sort((a, b) => { if (a.trayName !== b.trayName) return a.trayName.localeCompare(b.trayName); return (a.expiry || '9999').localeCompare(b.expiry || '9999'); });
      };
      
      const handleExportReport = () => {
        let titleSuffix = reportMode === 'current' ? activeTray.name : (reportMode === 'all_abnormal' ? '全院異常效期彙整' : '全院資料總表');

        let htmlContent = `<html><head><title>${titleSuffix} - 庫存清單</title><style>@media print { @page { margin: 1cm; } body { font-family: system-ui, sans-serif; padding-bottom: 50px; } .page-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 40px; border-top: 1px solid #ccc; padding-top: 5px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; background: white; } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } thead { display: table-header-group; } tfoot { display: table-footer-group; } } body { font-family: system-ui, sans-serif; padding: 20px; } h1 { text-align: center; margin-bottom: 20px; } table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; line-height: 1.6; } th { background-color: #f3f4f6; font-weight: bold; } .high-alert { color: #e11d48; font-weight: bold; font-size: 10px; border: 1px solid #e11d48; padding: 2px 5px; border-radius: 4px; margin-left: 4px; display: inline-block; white-space: nowrap; vertical-align: middle; } .expired { color: #be123c; font-weight: bold; } .warning { color: #a16207; font-weight: bold; } .text-right { text-align: right; } .text-center { text-align: center; } .total-col { background-color: #f8fafc; font-weight: bold; } </style></head><body><h1>${titleSuffix} - 庫存清單</h1><table><thead><tr>${(reportMode === 'all_data' || reportMode === 'all_abnormal') ? '<th width="15%">來源藥車</th>' : ''}<th width="30%">藥品名稱</th>${reportMode === 'current' ? '<th width="8%" class="text-right">應備</th><th width="8%" class="text-right total-col">現有</th>' : ''}<th width="10%" class="text-right">批號數量</th><th width="20%">效期</th><th width="10%" class="text-center">狀態</th></tr></thead><tbody>`;
        if (reportMode === 'current') { activeTray.slots.forEach(slot => { const sortedBatches = getSortedBatches(slot.batches); const totalQty = getTotalQty(slot.batches); const requiredQty = slot.requiredQty || 0; const rowSpan = sortedBatches.length > 0 ? sortedBatches.length : 1; const nameCell = `<td rowspan="${rowSpan}">${slot.name} ${slot.highAlert ? '<span class="high-alert">High Alert</span>' : ''}</td>`; const reqCell = `<td rowspan="${rowSpan}" class="text-right">${requiredQty}</td>`; const isQtyMismatch = totalQty !== requiredQty; const totalStyle = isQtyMismatch ? 'color: #e11d48;' : 'color: #059669;'; const totalCell = `<td rowspan="${rowSpan}" class="text-right total-col" style="${totalStyle}">${totalQty}</td>`; if (!sortedBatches || sortedBatches.length === 0) { htmlContent += `<tr>${nameCell} ${reqCell} ${totalCell}<td class="text-right">0</td> <td>-</td> <td class="text-center">無庫存</td></tr>`; } else { sortedBatches.forEach((batch, idx) => { const s = getStatus(batch.expiry); const statusClass = s.type === 'expired' ? 'expired' : (s.type === 'warning' ? 'warning' : ''); htmlContent += `<tr>`; if (idx === 0) htmlContent += nameCell + reqCell + totalCell; htmlContent += `<td class="text-right">${batch.qty}</td><td class="${statusClass}">${batch.expiry || '未設定'}</td><td class="text-center ${statusClass}">${s.label}</td></tr>`; }); } }); } else { 
            const items = reportMode === 'all_abnormal' ? getAllAbnormalItems() : getAllHospitalItems();
            if (items.length === 0) { htmlContent += `<tr><td colspan="6" class="text-center" style="padding: 20px;">無資料</td></tr>`; } else { items.forEach(item => { const statusClass = item.statusObj.type === 'expired' ? 'expired' : (item.statusObj.type === 'warning' ? 'warning' : ''); htmlContent += `<tr><td>${item.trayName}</td><td>${item.slotName} ${item.highAlert ? '<span class="high-alert">High Alert</span>' : ''}</td><td class="text-right">${item.qty}</td><td class="${statusClass}">${item.expiry || '未設定'}</td><td class="text-center ${statusClass}">${item.statusObj.label}</td></tr>`; }); } 
        }
        htmlContent += `</tbody></table><div class="page-footer"><span>列印時間: ${new Date().toLocaleString()} | ${titleSuffix}</span><div style="display:flex; gap:20px;"><span>藥師簽章: _______________</span><span>核對日期: _______________</span></div></div></body></html>`;
        const printWindow = window.open('', '_blank'); if (!printWindow) { alert('請允許彈出式視窗以匯出報表'); return; } printWindow.document.write(htmlContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
      };

      // === 郵件處理邏輯 ===
      const saveMailConfig = () => {
        localStorage.setItem('ecart_mail_config', JSON.stringify(mailConfig));
        setModalConfig({ title: "設定", message: "設定已儲存" });
      };

      const sendMail = async (type = 'test', items = []) => {
        if (!mailConfig.apiUrl || !mailConfig.email) {
          setModalConfig({ title: "設定錯誤", message: "請先完成郵件設定 (URL 與 Email)", type: 'error' });
          return;
        }
        
        setIsMailTesting(true);
        try {
          const response = await fetch(mailConfig.apiUrl, {
            method: 'POST',
            mode: 'no-cors', // Google Script 的特性
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: type,
              to: mailConfig.email,
              items: items
            })
          });
          
          setModalConfig({ 
             title: type === 'test' ? "測試發送" : "警報發送", 
             message: type === 'test' ? "測試請求已發送！\n請檢查您的信箱 (若未收到請檢查垃圾郵件或 Script 部署權限)。" : "警報清單已發送！",
             type: 'success'
          });
          
        } catch (error) {
          console.error("Mail Error:", error);
          setModalConfig({ title: "發送失敗", message: "請檢查 URL 是否正確或網路連線", type: 'error' });
        } finally {
          setIsMailTesting(false);
        }
      };

      const checkAndSendAlert = () => {
        try {
          // 防呆：檢查 trays 資料是否存在
          if (!trays || !Array.isArray(trays)) {
             setModalConfig({ title: "資料異常", message: "無法讀取藥盤資料，請重整頁面後再試。", type: 'error' });
             return;
          }

          let alertItems = [];
          
          // 使用更安全的迴圈方式：層層檢查 null/undefined
          trays.forEach(tray => {
            if (!tray || !tray.slots || !Array.isArray(tray.slots)) return;

            tray.slots.forEach(slot => {
               if (!slot || !slot.batches || !Array.isArray(slot.batches)) return;

               slot.batches.forEach(batch => {
                 // 修正關鍵：如果 batch 本身是 null/undefined，直接跳過，防止存取屬性時崩潰
                 if (!batch) return;
                 // 檢查是否被設定為忽略通知
                 if (batch.ignoreAlert) return;

                 const s = getStatus(batch.expiry);
                 if (s.type === 'warning' || s.type === 'expired') {
                   alertItems.push({
                     trayName: tray.name || '未命名藥盤',
                     name: slot.name || '未命名藥品',
                     expiry: batch.expiry || '未知效期',
                     qty: batch.qty || 0,
                     status: s.label
                   });
                 }
               });
            });
          });

          if (alertItems.length > 0) {
            // 使用自定義 Modal 取代 window.confirm
            setModalConfig({
              title: "掃描完成",
              message: `共發現 ${alertItems.length} 項異常藥品 (過期或近效期)。\n是否立即發送清單至 ${mailConfig.email}？`,
              type: 'info',
              onConfirm: () => sendMail('alert', alertItems)
            });
          } else {
            setModalConfig({ title: "掃描完成", message: "目前所有藥品效期皆正常，無需發送警報。", type: 'info' });
          }
        } catch (e) {
          console.error("Check Alert Error:", e);
          setModalConfig({ title: "發生錯誤", message: "檢查過程發生錯誤：" + e.message + "\n請截圖聯繫管理員。", type: 'error' });
        }
      };

      // ... other helper functions ...
      const addTray = () => { const newId = Date.now().toString(); const newTray = { id: newId, name: `新藥盤 ${trays.length + 1}`, slots: [] }; const newData = [...trays, newTray]; saveToSheet(newData); setActiveTrayId(newId); setIsTraySelectorOpen(false); };
      const duplicateTrayStructure = () => { const newId = Date.now().toString(); const newSlots = activeTray.slots.map(s => ({ ...s, id: `s-${newId}-${Math.random().toString(36).substr(2, 9)}`, batches: [] })); const newTray = { id: newId, name: `${activeTray.name} (複製)`, slots: newSlots }; const newData = [...trays, newTray]; saveToSheet(newData); setActiveTrayId(newId); setTrayMenuOpen(false); };
      const executeDeleteTray = () => { const targetTrayId = activeTray.id; if (trays.length <= 1) return; const newData = trays.filter(t => String(t.id) !== String(targetTrayId)); saveToSheet(newData); if (newData.length > 0) { setActiveTrayId(newData[0].id); } setIsDeleteConfirming(false); setTrayMenuOpen(false); };
      const renameActiveTray = () => { if (!trayEditForm.name.trim()) return; const targetId = String(activeTray.id); const newData = trays.map(t => String(t.id) === targetId ? { ...t, name: trayEditForm.name } : t); saveToSheet(newData); setTrayMenuOpen(false); };
      const openTrayMenu = () => { setTrayEditForm({ name: activeTray.name }); setIsDeleteConfirming(false); setTrayMenuOpen(true); };
      const isOverlapping = (rect1, rect2) => { return (rect1.x < rect2.x + rect2.w && rect1.x + rect1.w > rect2.x && rect1.y < rect2.y + rect2.h && rect1.y + rect1.h > rect2.y); };
      const getGridCoordinates = (e) => { if (!gridContainerRef.current) return null; const container = gridContainerRef.current; const computedStyle = window.getComputedStyle(container); const paddingLeft = parseFloat(computedStyle.paddingLeft); const paddingTop = parseFloat(computedStyle.paddingTop); const contentWidth = container.clientWidth - paddingLeft - parseFloat(computedStyle.paddingRight); const contentHeight = container.clientHeight - paddingTop - parseFloat(computedStyle.paddingBottom); const cellW = contentWidth / GRID_COLS; const cellH = contentHeight / GRID_ROWS; const x = Math.floor((e.nativeEvent.offsetX - paddingLeft) / cellW); const y = Math.floor((e.nativeEvent.offsetY - paddingTop) / cellH); if (x < 0 || x >= GRID_COLS || y < 0 || y >= GRID_ROWS) return null; return { x, y }; };
      
      const handlePointerDown = (e) => { if (mode !== 'admin') return; const coords = getGridCoordinates(e); if (!coords) return; const clickedSlot = activeTray.slots.find(s => coords.x >= s.x && coords.x < s.x + s.w && coords.y >= s.y && coords.y < s.y + s.h); if (clickedSlot) return; e.currentTarget.setPointerCapture(e.pointerId); setIsDrawing(true); setDragStart(coords); setDragCurrent(coords); setSelectedSlot(null); };
      const handlePointerMove = (e) => { if (!isDrawing) return; const coords = getGridCoordinates(e); if (coords) setDragCurrent(coords); };
      const handlePointerUp = (e) => { if (!isDrawing) return; setIsDrawing(false); e.currentTarget.releasePointerCapture(e.pointerId); if (!dragStart || !dragCurrent) return; const x = Math.min(dragStart.x, dragCurrent.x); const y = Math.min(dragStart.y, dragCurrent.y); const w = Math.abs(dragStart.x - dragCurrent.x) + 1; const h = Math.abs(dragStart.y - dragCurrent.y) + 1; const newRect = { x, y, w, h }; if (activeTray.slots.some(slot => isOverlapping(newRect, slot))) { alert("區域重疊"); return; } const newSlot = { id: `s-${Date.now()}`, ...newRect, name: '新區域', highAlert: false, requiredQty: 0, batches: [] }; const updatedSlots = [...activeTray.slots, newSlot]; const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t); saveToSheet(newData); setSelectedSlot(newSlot); setEditForm({ ...newSlot }); };
      const openEditModal = (slot) => { setSelectedSlot(slot); const sortedBatches = slot.batches ? [...slot.batches].sort((a, b) => { const dateA = a.expiry || '9999'; const dateB = b.expiry || '9999'; if (dateA < dateB) return -1; if (dateA > dateB) return 1; return 0; }) : []; setEditForm({ ...slot, batches: sortedBatches.map(b => ({...b})) }); };
      const saveForm = () => { const updatedSlots = activeTray.slots.map(s => s.id === selectedSlot.id ? { ...s, ...editForm } : s); const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t); saveToSheet(newData); setSelectedSlot(null); };
      const deleteCurrentSlot = () => { const updatedSlots = activeTray.slots.filter(s => s.id !== selectedSlot.id); const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t); saveToSheet(newData); setSelectedSlot(null); };
      const getPreviewStyle = () => { if (!isDrawing || !dragStart || !dragCurrent) return {}; const x = Math.min(dragStart.x, dragCurrent.x); const y = Math.min(dragStart.y, dragCurrent.y); const w = Math.abs(dragStart.x - dragCurrent.x) + 1; const h = Math.abs(dragStart.y - dragCurrent.y) + 1; return { gridColumn: `${x+1}/span ${w}`, gridRow: `${y+1}/span ${h}`, backgroundColor: 'rgba(59,130,246,0.5)', border: '1px dashed #60a5fa', zIndex: 20, pointerEvents: 'none' }; };
      
      const addBatch = () => setEditForm(prev => ({...prev, batches: [{id: Date.now(), expiry: '', qty: 1}, ...(prev.batches||[])]}));
      const removeBatch = (id) => setEditForm(prev => ({...prev, batches: prev.batches.filter(b => b.id !== id)}));
      const updateBatch = (id, field, val) => setEditForm(prev => ({...prev, batches: prev.batches.map(b => b.id === id ? {...b, [field]: val} : b)}));
      const toggleBatchMute = (batchId) => { setEditForm(prev => ({ ...prev, batches: prev.batches.map(b => b.id === batchId ? { ...b, ignoreAlert: !b.ignoreAlert } : b) })); };

      if (isLoading) {
        return (
          <div className="h-screen w-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex flex-col items-center justify-center z-50 relative overflow-hidden">
             {/* ... Loading screen content ... */}
             <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-3xl animate-pulse"></div>
              <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-600/10 rounded-full blur-3xl animate-pulse delay-1000"></div>
              <div className="mb-8 relative"> 
                  <div className="absolute inset-0 bg-rose-500 blur-2xl opacity-20"></div>
                  <Icons.MedicalComposition />
              </div>
              <h2 className="text-xl md:text-2xl font-bold text-white mb-4 tracking-wider relative z-10 text-center flex flex-col md:flex-row items-center justify-center gap-2 md:gap-0">
                <span>臺北榮民總醫院玉里分院</span>
                <span className="hidden md:block mx-2">|</span>
                <span>急救車效期提醒系統</span>
              </h2>
              <div className="loading-bar-box relative z-10">
                  <div className="loading-bar-fill"></div>
              </div>
              <p className="text-slate-400 text-sm mt-4 relative z-10">系統載入中，請稍候...</p>
          </div>
        )
      }

      return (
        <div className="h-screen w-screen flex flex-col">
          {/* Header */}
          <header className="bg-slate-800 border-b border-slate-700 p-0 flex justify-between items-stretch shrink-0 h-12 z-30 relative">
            <div className="flex-1 flex overflow-hidden px-2 gap-2 items-center">
              <div className="flex items-center text-blue-400 font-bold px-3 select-none mr-2 shrink-0">
                <Icons.Truck /> 
                <span className="ml-2 text-sm md:text-lg hidden md:inline">臺北榮民總醫院玉里分院 | 急救車效期提醒系統</span>
                <span className="ml-2 text-sm md:hidden">急救車系統</span>
                {syncStatus === 'syncing' && <span className="ml-2 text-[10px] text-yellow-400 animate-pulse">● 同步中</span>}
                {syncStatus === 'success' && <span className="ml-2 text-[10px] text-emerald-400">● 已儲存</span>}
                {syncStatus === 'error' && <span className="ml-2 text-[10px] text-rose-400">● 失敗</span>}
              </div>
              
              {clipboard && (
                  <button 
                    onClick={() => setPasteMode(!pasteMode)}
                    className={`ml-2 px-3 py-1 rounded text-xs font-bold flex items-center gap-1 transition-all hidden md:flex ${pasteMode ? 'bg-yellow-500 text-slate-900 animate-pulse' : 'bg-slate-700 text-slate-400'}`}
                  >
                    {pasteMode ? <Icons.ClipboardCheck /> : <Icons.Clipboard />}
                    {pasteMode ? '貼上模式' : '複製待命'}
                  </button>
              )}

              <button onClick={() => setIsTraySelectorOpen(!isTraySelectorOpen)} className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold text-sm md:text-base transition-colors border border-slate-600 ml-auto md:ml-0 truncate max-w-[150px] md:max-w-none">
                <span className="truncate">{activeTray.name}</span><Icons.ChevronDown />
              </button>

              <button onClick={openTrayMenu} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-full transition-colors ml-1" title="編輯目前藥盤"><Icons.Edit /></button>
            </div>
            
            <div className="flex items-center px-2 md:px-4 bg-slate-900 border-l border-slate-800 shadow-[-10px_0_10px_rgba(0,0,0,0.5)] z-20 gap-1 md:gap-2 shrink-0">
               {/* Advanced Settings Button - Only visible in Admin Mode */}
               {mode === 'admin' && (
                   <div className="relative mr-1 md:mr-2 border-r border-slate-700 pr-1 md:pr-2">
                     <button onClick={() => setShowAdvancedMenu(!showAdvancedMenu)} className="px-2 md:px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition text-slate-300 bg-slate-800 hover:bg-slate-700 border border-slate-600" title="進階設定">
                        <Icons.Tool /> <span className="hidden md:inline">進階設定</span>
                     </button>
                     {/* Advanced Menu Dropdown */}
                     {showAdvancedMenu && (
                        <div className="absolute top-full right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden z-50 animate-in fade-in zoom-in-95 duration-100">
                             <button onClick={() => { setShowMailModal(true); setShowAdvancedMenu(false); }} className="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-slate-50 border-b border-gray-100 flex items-center gap-2"><Icons.Mail /> 郵件通知設定</button>
                             <button onClick={handleExportJSON} className="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-slate-50 border-b border-gray-100 flex items-center gap-2"><Icons.Download /> 資料備份 (匯出)</button>
                             <button onClick={() => fileInputRef.current.click()} className="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-slate-50 flex items-center gap-2"><Icons.Upload /> 資料還原 (匯入)</button>
                        </div>
                     )}
                     {/* Backdrop for closing advanced menu */}
                     {showAdvancedMenu && <div className="fixed inset-0 z-40" onClick={() => setShowAdvancedMenu(false)}></div>}
                     <input type="file" accept=".json" ref={fileInputRef} style={{display: 'none'}} onChange={handleImportJSON} />
                   </div>
               )}
               
               <div className="flex bg-black/40 rounded p-0.5 border border-slate-700 gap-0.5">
                <button onClick={()=>{setMode('view');setSelectedSlot(null);}} className={`px-2 md:px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='view'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`} title="盤點"><Icons.Layout /> <span className="hidden md:inline">盤點</span></button>
                <button onClick={()=>{setMode('list');setSelectedSlot(null);}} className={`px-2 md:px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='list'?'bg-purple-600 text-white':'text-slate-400 hover:text-white'}`} title="清單"><Icons.List /> <span className="hidden md:inline">清單</span></button>
                {/* 移除最外面多餘的統計選單 */}
                <button onClick={handleAdminAccess} className={`px-2 md:px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='admin'?'bg-amber-600 text-white':'text-slate-400 hover:text-white'}`} title="設定"><Icons.Settings /> <span className="hidden md:inline">設定</span></button>
              </div>
            </div>

            {/* Always rendered file input for restore - 移至最外層確保存在 */}
            <input type="file" accept=".json" ref={fileInputRef} style={{display: 'none'}} onChange={handleImportJSON} />

            {isTraySelectorOpen && (
              <div className="absolute top-full left-0 w-full bg-slate-800/95 backdrop-blur-md border-b border-slate-600 shadow-2xl z-50 p-4 animate-in fade-in slide-in-from-top-2 duration-200">
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-3">
                    <h3 className="text-slate-300 text-sm font-bold uppercase tracking-wider">切換藥盤</h3>
                    <button onClick={() => setIsTraySelectorOpen(false)} className="text-slate-400 hover:text-white"><Icons.XCircle /></button>
                  </div>
                  <div className="grid grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2">
                    {trays.map(tray => {
                      const status = getTrayOverallStatus(tray);
                      let baseClasses = "p-2 rounded-lg text-center font-bold text-sm transition-all truncate relative overflow-visible";
                      let colorClasses = "";
                      const isActive = String(activeTrayId) === String(tray.id);
                      if (status === 'expired') { colorClasses = isActive ? "bg-blue-600 text-white border-4 border-rose-600 shadow-[0_0_15px_rgba(225,29,72,0.6)] z-10" : "bg-slate-700 text-slate-300 hover:text-white border-4 border-rose-600"; } 
                      else if (status === 'warning') { colorClasses = isActive ? "bg-blue-600 text-white border-4 border-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.6)] z-10" : "bg-slate-700 text-slate-300 hover:text-white border-4 border-amber-500"; } 
                      else { colorClasses = isActive ? "bg-blue-600 border border-blue-500 text-white shadow-lg scale-[1.02]" : "bg-slate-700 border border-slate-600 text-slate-300 hover:bg-slate-600 hover:text-white"; }
                      return ( <button key={tray.id} onClick={() => { setActiveTrayId(tray.id); setIsTraySelectorOpen(false); }} className={`${baseClasses} ${colorClasses}`} title={tray.name}>{tray.name}</button>);
                    })}
                    <button onClick={addTray} className="p-2 rounded-lg border border-dashed border-slate-500 text-slate-400 hover:text-white hover:border-slate-300 hover:bg-slate-700/50 flex items-center justify-center gap-1 font-bold text-sm transition-all"><Icons.PlusCircle /> <span className="hidden sm:inline">新增</span></button>
                  </div>
                </div>
              </div>
            )}
            {isTraySelectorOpen && ( <div className="fixed inset-0 top-[48px] z-40" onClick={() => setIsTraySelectorOpen(false)}></div> )}
          </header>

          {/* Workspace */}
          <div className="flex-1 overflow-auto bg-slate-950 relative cursor-grab active:cursor-grabbing p-1 md:p-4">
            {mode === 'list' ? (
              <div className="w-full h-full min-w-[800px] flex flex-col bg-slate-900 rounded-lg border-2 border-slate-800 shadow-2xl overflow-hidden relative">
                {/* Top Toolbar for List Mode */}
                <div className="bg-slate-800 border-b border-slate-700 p-3 flex justify-between items-center gap-2">
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2">
                        <span className="text-slate-300 font-bold text-sm hidden md:inline">檢視模式:</span>
                        <div className="flex bg-slate-700 rounded-lg p-1 gap-1">
                        <button onClick={() => setReportMode('current')} className={`px-3 py-1 text-xs font-bold rounded transition-colors ${reportMode === 'current' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:text-white hover:bg-slate-600'}`}>當前藥盤</button>
                        <button onClick={() => setReportMode('all_data')} className={`px-3 py-1 text-xs font-bold rounded transition-colors ${reportMode === 'all_data' ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:text-white hover:bg-slate-600'}`}>全院資料</button>
                        <button onClick={() => setReportMode('all_abnormal')} className={`px-3 py-1 text-xs font-bold rounded transition-colors flex items-center gap-1 ${reportMode === 'all_abnormal' ? 'bg-rose-600 text-white' : 'text-slate-300 hover:text-white hover:bg-slate-600'}`}><Icons.AlertTriangle /> 全院異常</button>
                        </div>
                    </div>
                  </div>
                  
                  <div className="flex gap-2">
                      <button 
                        onClick={() => setShowAnalysis(true)} 
                        className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded shadow-lg transition-colors border border-blue-500"
                      >
                        <Icons.PieChart /> <span className="hidden md:inline">統計分析</span>
                      </button>
                      <button 
                        onClick={handleExportReport} 
                        className={`flex items-center gap-2 px-3 py-1.5 text-white text-xs font-bold rounded shadow-lg transition-colors border ${reportMode === 'all_abnormal' ? 'bg-rose-600 hover:bg-rose-700 border-rose-500' : (reportMode === 'all_data' ? 'bg-emerald-600 hover:bg-emerald-700 border-emerald-500' : 'bg-emerald-600 hover:bg-emerald-700 border-emerald-500')}`}
                      >
                        <Icons.Download /> <span className="hidden md:inline">{reportMode === 'all_abnormal' ? '匯出異常清單' : (reportMode === 'all_data' ? '匯出全院清單' : '匯出報表')}</span>
                      </button>
                  </div>
                </div>

                <div className="overflow-auto flex-1"> 
                  <table className="w-full text-left text-sm text-slate-400">
                    <thead className="text-xs uppercase text-slate-200 sticky top-0 z-10 shadow-md">
                      <tr>
                        {(reportMode === 'all_data' || reportMode === 'all_abnormal') && (<th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10">來源藥車</th>)}
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10">藥品名稱</th>
                        {reportMode === 'current' && (<><th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10 text-right">應備量</th><th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10 text-right">數量</th></>)}
                        {(reportMode === 'all_data' || reportMode === 'all_abnormal') && (<th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10 text-right">數量</th>)}
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10">效期 (YYYY-MM-DD)</th>
                        <th className="px-4 py-3 font-bold border-b border-slate-700 text-center bg-slate-800 sticky top-0 z-10">狀態</th>
                      </tr>
                    </thead>
                    <tbody className="">
                      {reportMode === 'current' ? (
                        // ... existing current tray logic ...
                        activeTray.slots.map(slot => {
                          const sortedBatches = getSortedBatches(slot.batches);
                          const totalQty = getTotalQty(slot.batches);
                          const requiredQty = slot.requiredQty || 0;
                          
                          if (!sortedBatches || sortedBatches.length === 0) {
                             return (
                               <tr key={slot.id} className={`hover:bg-slate-800/50 transition-colors border-t border-slate-600`}>
                                 <td className="px-4 py-3 font-medium text-white">
                                   <div className="flex flex-wrap items-center gap-2"><span className="leading-snug">{slot.name}</span>{slot.highAlert && <span className="whitespace-nowrap text-[10px] bg-rose-600 text-white px-1.5 py-0.5 rounded font-bold">High Alert</span>}</div>
                                 </td>
                                 <td className="px-4 py-3 font-mono text-right text-slate-500">{requiredQty}</td>
                                 <td className="px-4 py-3 font-mono text-right text-slate-500">0</td>
                                 <td className="px-4 py-3 font-mono text-slate-500">-</td>
                                 <td className="px-4 py-3 text-center"><span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-black border-2 tracking-wide bg-slate-800 text-slate-500 border-slate-700 shadow-sm">無庫存</span></td>
                               </tr>
                             );
                          }
                          return sortedBatches.map((batch, index) => {
                            const s = getStatus(batch.expiry);
                            return (
                              <tr key={`${slot.id}-${batch.id}`} className={`hover:bg-slate-800/50 transition-colors ${index === 0 ? 'border-t border-slate-600' : 'border-t border-slate-800'}`}>
                                <td className="px-4 py-3 font-medium text-white">
                                  {index === 0 && (<div className="flex flex-wrap items-center gap-2"><span className="leading-snug">{slot.name}</span>{slot.highAlert && <span className="whitespace-nowrap text-[10px] bg-rose-600 text-white px-1.5 py-0.5 rounded font-bold">High Alert</span>}</div>)}
                                </td>
                                <td className="px-4 py-3 font-mono text-right text-white font-bold">{index === 0 ? requiredQty : ''}</td>
                                <td className="px-4 py-3 font-mono text-right text-white font-bold">{batch.qty}</td>
                                <td className="px-4 py-3 font-mono text-slate-300">{batch.expiry || '未設定'}</td>
                                <td className="px-4 py-3 text-center">
                                  <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold border-2 tracking-wide ${s.bg} ${s.text} ${s.border} bg-opacity-100 shadow-sm justify-center min-w-[3rem]`}>{s.label}</span>
                                </td>
                              </tr>
                            );
                          });
                        })
                      ) : (
                        // === Updated: All Hospital Data Logic OR All Abnormal Logic ===
                        (() => {
                           const items = reportMode === 'all_abnormal' ? getAllAbnormalItems() : getAllHospitalItems();
                           if (items.length === 0) {
                              return <tr><td colSpan="5" className="px-4 py-10 text-center text-slate-500 font-bold"><Icons.Check /> 無資料</td></tr>;
                           }
                           return items.map((item, idx) => (
                            <tr key={idx} className="hover:bg-slate-800/50 transition-colors border-t border-slate-700">
                              <td className="px-4 py-3 font-bold text-blue-400">{item.trayName}</td>
                              <td className="px-4 py-3 font-medium text-white"><div className="flex flex-wrap items-center gap-2"><span className="leading-snug">{item.slotName}</span>{item.highAlert && <span className="whitespace-nowrap text-[10px] bg-rose-600 text-white px-1.5 py-0.5 rounded font-bold">High Alert</span>}</div></td>
                              <td className="px-4 py-3 font-mono text-right text-white font-bold">{item.qty}</td>
                              <td className="px-4 py-3 font-mono text-slate-300">{item.expiry || '未設定'}</td>
                              <td className="px-4 py-3 text-center"><span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold border-2 tracking-wide ${item.statusObj.bg} ${item.statusObj.text} ${item.statusObj.border} bg-opacity-100 shadow-sm justify-center min-w-[3rem]`}>{item.statusObj.label}</span></td>
                            </tr>
                          ));
                        })()
                      )}
                    </tbody>
                  </table>
                  {reportMode === 'current' && activeTray.slots.length === 0 && (
                    <div className="flex flex-col items-center justify-center py-20 text-slate-600">
                      <Icons.Layout />
                      <p className="mt-2 text-sm">此藥盤尚無內容</p>
                    </div>
                  )}
                </div>
              </div>
            ) : (
               /* ... Grid Mode ... */
              <div className="w-full h-full min-w-[800px] min-h-[600px] flex flex-col">
                 <div ref={gridContainerRef} className={`relative flex-1 bg-slate-900 rounded-lg border-2 border-slate-800 shadow-2xl overflow-hidden ${mode==='admin'?'cursor-crosshair ring-1 ring-amber-500/30': (pasteMode ? 'cursor-copy ring-2 ring-yellow-500/50' : '')}`}
                  style={{ 
                    display: 'grid', 
                    gridTemplateColumns: `repeat(${GRID_COLS}, minmax(0, 1fr))`, 
                    gridTemplateRows: `repeat(${GRID_ROWS}, minmax(0, 1fr))`, 
                    gap: '1px', 
                    padding: '2px', 
                    touchAction: mode === 'admin' ? 'none' : 'auto',
                    backgroundImage: `linear-gradient(to right, rgba(30, 41, 59, 0.5) 1px, transparent 1px), linear-gradient(to bottom, rgba(30, 41, 59, 0.5) 1px, transparent 1px)`,
                    backgroundSize: `calc(100% / ${GRID_COLS}) calc(100% / ${GRID_ROWS})`
                  }}
                  onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp}
                >
                  {isDrawing && <div style={getPreviewStyle()} className="rounded"></div>}

                  {activeTray.slots.map(slot => {
                    const borderClass = getSlotOverallStatus(slot.batches);
                    const totalQty = getTotalQty(slot.batches);
                    const requiredQty = slot.requiredQty || 0;
                    const isQtyMatch = totalQty === parseInt(requiredQty);
                    const qtyColorClass = isQtyMatch ? 'text-emerald-400' : 'text-rose-400';
                    const sortedBatches = getSortedBatches(slot.batches);
                    return (
                      <div key={slot.id} onPointerDown={(e)=>e.stopPropagation()} 
                           onClick={(e)=>{
                               e.stopPropagation(); 
                               if(pasteMode && clipboard) {
                                   handlePasteBatch(slot);
                               } else {
                                   openEditModal(slot);
                               }
                           }}
                        className={`relative rounded-sm flex flex-col p-1 transition-all group border ${borderClass} ${mode==='admin'?'hover:opacity-80': (pasteMode ? 'hover:bg-yellow-900/30 hover:border-yellow-500' : 'hover:brightness-110 hover:z-10 shadow-sm')}`}
                        style={{ gridColumn: `${slot.x+1}/span ${slot.w}`, gridRow: `${slot.y+1}/span ${slot.h}`, overflow: 'hidden' }}
                      >
                        <div className="absolute top-0 right-0 flex flex-col items-end z-10">
                           <div className={`bg-slate-900 ${qtyColorClass} text-xs px-2 py-0.5 rounded-bl font-mono font-bold border-l border-b border-slate-600 shadow-md`}>
                             {totalQty}/{requiredQty}
                           </div>
                           {slot.highAlert && <div className="bg-rose-600 text-white text-[10px] px-1.5 py-0.5 rounded-bl font-bold shadow-sm whitespace-nowrap">高警訊</div>}
                        </div>
                        <div className={`text-slate-200 font-bold leading-tight break-words overflow-hidden mb-1 ${slot.h > 2 ? 'text-xs md:text-sm pt-1' : 'text-[9px] md:text-[10px]'}`}>{slot.name}</div>
                        <div className="flex-1 overflow-hidden flex flex-col gap-0.5">
                          {sortedBatches.map((batch) => {
                            const s = getStatus(batch.expiry);
                            return (
                              <div key={batch.id} className={`flex justify-between items-center text-[8px] md:text-[9px] px-1 rounded-sm ${s.bg} ${s.text} bg-opacity-90`}>
                                <span className="font-mono tracking-tighter truncate">{batch.expiry}</span>
                                <span className="font-bold ml-1">x{batch.qty}</span>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-2 flex justify-between items-center text-[10px] text-slate-500 px-2 h-6 shrink-0">
                  <div>{activeTray.name} - GS模式</div>
                  <div className="flex items-center gap-2">
                    <span>{mode==='view' ? (pasteMode ? '📋 貼上模式：點擊格子貼上效期' : '提示：點擊藥品以管理庫存') : '提示：按住並拖曳畫出新格子'}</span>
                    <span className="border-l border-slate-600 pl-2 ml-1 text-slate-600">製作者 : 林其仁藥師、陳梓騏藥師</span>
                    <span className="border-l border-slate-600 pl-2 ml-1 text-slate-600">版本日期 : 2026/02/08</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* System Message Modal */}
          <SystemModal config={modalConfig} onClose={() => setModalConfig(null)} />
          {/* Analysis Modal */}
          {showAnalysis && (
            <AnalysisModal 
                trays={trays} 
                activeTrayId={activeTrayId} 
                onClose={() => setShowAnalysis(false)} 
                reportMode={reportMode}
            />
          )}
          {/* ... existing Modals ... */}
          {showPasscodeModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden p-6 text-center">
                <div className="mx-auto w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-4"><Icons.Lock /></div>
                <h3 className="text-lg font-bold text-gray-800 mb-2">管理員驗證</h3>
                <p className="text-sm text-gray-500 mb-4">請輸入通行碼以進入設定模式</p>
                <input type="password" pattern="[0-9]*" inputMode="numeric" autoFocus className="w-full p-3 border border-gray-300 rounded-lg text-center text-2xl font-bold tracking-widest mb-4 focus:ring-2 focus:ring-blue-500 outline-none" value={passcodeInput} onChange={(e) => setPasscodeInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && verifyPasscode()}/>
                <div className="flex gap-2"><button onClick={() => setShowPasscodeModal(false)} className="flex-1 py-2 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-100">取消</button><button onClick={verifyPasscode} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">確認</button></div>
              </div>
            </div>
          )}
          {showMailModal && (
             <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
               <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col">
                  <div className="px-5 py-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.Mail /> 郵件通知設定</h3>
                    <button onClick={() => setShowMailModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.XCircle /></button>
                  </div>
                  <div className="p-6 space-y-4 text-gray-800">
                     <p className="text-sm text-gray-500"><span className="text-rose-600 font-bold">注意：</span>此設定僅供手動測試使用。若要設定<span className="font-bold">每日自動檢查</span>，請務必在 Google Apps Script 程式碼中直接填寫 Email。</p>
                     <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">收件人 Email</label><input type="email" value={mailConfig.email} onChange={e => setMailConfig({...mailConfig, email: e.target.value})} placeholder="example@hospital.org.tw" className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                     <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Google Script 發信程式 URL</label><textarea value={mailConfig.apiUrl} onChange={e => setMailConfig({...mailConfig, apiUrl: e.target.value})} placeholder="請貼上您部署的 Google Apps Script 網址 (https://script.google.com/...)" className="w-full p-2.5 border border-gray-300 rounded text-xs font-mono text-gray-600 h-20 focus:ring-2 focus:ring-blue-500 outline-none resize-none" /></div>
                     <div className="flex gap-2 pt-2"><button onClick={() => sendMail('test')} disabled={isMailTesting || !mailConfig.email || !mailConfig.apiUrl} className={`flex-1 py-2 rounded-lg font-bold border flex items-center justify-center gap-2 ${isMailTesting ? 'bg-gray-100 text-gray-400' : 'border-slate-300 text-slate-700 hover:bg-slate-50'}`}>{isMailTesting ? '發送中...' : <><Icons.Send /> 測試發信</>}</button><button onClick={saveMailConfig} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"><Icons.Save /> 儲存設定</button></div>
                     <hr className="border-gray-200" />
                     <button onClick={checkAndSendAlert} className="w-full py-3 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 flex items-center justify-center gap-2 shadow-sm"><Icons.AlertTriangle /> 立即檢查並發送異常報告</button>
                  </div>
               </div>
             </div>
          )}
          {trayMenuOpen && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-sm rounded-xl shadow-xl overflow-hidden">
                <div className="px-4 py-3 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.Settings /> 藥盤設定</h3>
                  <button onClick={() => setTrayMenuOpen(false)} className="text-gray-400 hover:text-gray-600"><Icons.XCircle /></button>
                </div>
                {isDeleteConfirming ? (
                  <div className="p-6 text-center space-y-4">
                    <div className="mx-auto w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-600"><Icons.AlertTriangle className="w-6 h-6" /></div>
                    <div><h4 className="text-lg font-bold text-gray-900">確定刪除此藥盤？</h4><p className="text-sm text-gray-500 mt-1">「{activeTray.name}」將被永久刪除，且無法復原。</p></div>
                    <div className="flex gap-3 pt-2"><button onClick={() => setIsDeleteConfirming(false)} className="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-100">取消</button><button onClick={executeDeleteTray} className="flex-1 py-2 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700">確認刪除</button></div>
                  </div>
                ) : (
                  <div className="p-4 space-y-4 text-gray-800">
                    <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">藥盤名稱</label><input type="text" value={trayEditForm.name} onChange={e => setTrayEditForm({...trayEditForm, name: e.target.value})} className="w-full p-2 border rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                    <hr className="border-gray-100"/>
                    <div className="space-y-2">
                      <button onClick={renameActiveTray} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-2"><Icons.Save /> 儲存名稱</button>
                      <button onClick={duplicateTrayStructure} className="w-full py-2 bg-emerald-600 text-white rounded font-bold hover:bg-emerald-700 flex items-center justify-center gap-2"><Icons.Copy /> 複製結構</button>
                      <button onClick={() => setIsDeleteConfirming(true)} disabled={trays.length <= 1} className={`w-full py-2 border rounded font-bold flex items-center justify-center gap-2 ${trays.length <= 1 ? 'border-gray-200 text-gray-300 cursor-not-allowed' : 'border-rose-200 text-rose-600 hover:bg-rose-50'}`}><Icons.Trash2 /> 刪除</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Slot Edit Modal with Copy Button */}
          {selectedSlot && editForm && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div className="px-5 py-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                   <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">{editForm.name || '未命名'}{editForm.highAlert && <span className="text-xs bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full border border-rose-200">高警訊</span>}</h3>
                   <button onClick={() => setSelectedSlot(null)} className="p-1.5 hover:bg-gray-200 rounded-full text-gray-500"><Icons.XCircle /></button>
                </div>
                <div className="p-6 overflow-y-auto bg-gray-50 space-y-6 flex-1 text-gray-800">
                  {mode === 'admin' && ( <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-4"> <div className="flex justify-between items-center"><label className="text-xs font-bold text-gray-500 uppercase">基本設定</label></div> <div className="flex gap-4"> <div className="flex-1"> <label className="text-xs font-bold text-gray-500 uppercase block mb-1">藥品名稱</label> <AutoCompleteInput placeholder="輸入藥品名稱" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} options={drugList} /> </div> <div className="w-24"> <label className="text-xs font-bold text-gray-500 uppercase block mb-1">應備量</label> <input type="number" placeholder="0" value={editForm.requiredQty || 0} onChange={e => setEditForm({...editForm, requiredQty: parseInt(e.target.value) || 0})} className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none text-center" /> </div> </div> <label className="flex items-center gap-2 cursor-pointer select-none"> <input type="checkbox" checked={editForm.highAlert} onChange={e => setEditForm({...editForm, highAlert: e.target.checked})} className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500" /> <span className="text-sm font-medium text-gray-700">標記為 High Alert (高警訊)</span> </label> </div> )}
                  <div className="space-y-3">
                    <div className="flex justify-between items-end">
                      <label className="text-sm font-bold text-gray-700 flex items-center gap-2"><Icons.Layers /> 庫存效期清單</label>
                      <button onClick={addBatch} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full font-bold hover:bg-blue-700 flex items-center gap-1 shadow-sm transition-colors"><Icons.PlusCircle /> 新增效期</button>
                    </div>
                    {(!editForm.batches || editForm.batches.length === 0) ? (
                      <div className="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 text-sm bg-white"><Icons.Calendar /> 點擊上方按鈕新增第一筆庫存</div>
                    ) : (
                      editForm.batches.map((b) => {
                        const s = getStatus(b.expiry);
                        return (
                          <div key={b.id} className={`group relative flex flex-wrap md:flex-nowrap items-end gap-2 p-3 rounded-lg border-2 shadow-sm transition-colors bg-white ${s.border}`}>
                            <div className="flex-none">
                              <label className="text-[10px] font-bold text-gray-400 block mb-3 uppercase">效期 (Year-Month-Day)</label>
                              <SmartExpiryInput value={b.expiry} onChange={val => updateBatch(b.id, 'expiry', val)} />
                            </div>
                            <div className="w-20 flex-none">
                               <label className="text-[10px] font-bold text-gray-400 block mb-3 uppercase">數量</label>
                               <input type="number" value={b.qty} onChange={e => updateBatch(b.id, 'qty', e.target.value)} className="w-full h-9 text-center bg-gray-50 border border-gray-300 rounded font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                            <div className="pb-1 mr-auto">
                              <div className={`px-2 py-1 rounded-full text-[10px] font-bold border-2 tracking-wide ${s.bg} ${s.text} ${s.border} bg-opacity-100 shadow-sm justify-center min-w-[3rem] text-center`}>{s.label}</div>
                            </div>
                            {/* Copy Button */}
                            <div className="pb-0.5">
                                <button onClick={() => handleCopyBatch(b)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="複製效期"><Icons.Copy /></button>
                            </div>
                            {/* Mute Button */}
                            <div className="pb-0.5">
                                <button onClick={() => toggleBatchMute(b.id)} className={`p-2 rounded-full transition-colors ${b.ignoreAlert ? 'text-slate-400 bg-slate-100' : 'text-blue-400 hover:bg-blue-50'}`} title={b.ignoreAlert ? "開啟通知" : "關閉通知"}>
                                    {b.ignoreAlert ? <Icons.BellOff /> : <Icons.Bell />}
                                </button>
                            </div>
                            <div className="pb-0.5">
                              <button onClick={() => removeBatch(b.id)} className="p-2 text-gray-400 hover:text-rose-600 hover:bg-rose-50 rounded-full transition-colors"><Icons.Trash2 /></button>
                            </div>
                          </div>
                        )
                      })
                    )}
                  </div>
                </div>
                <div className="p-5 bg-white border-t border-gray-200 flex gap-3">
                  {mode === 'admin' && <button onClick={deleteCurrentSlot} className="px-5 py-2.5 border border-rose-200 text-rose-600 rounded-lg font-bold hover:bg-rose-50 transition-colors"><Icons.Trash2 /></button>}
                  <button onClick={saveForm} className="flex-1 py-2.5 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 flex justify-center items-center gap-2 transition-transform active:scale-[0.98]"><Icons.Save /> {mode === 'admin' ? '儲存設定' : '確認更新'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
