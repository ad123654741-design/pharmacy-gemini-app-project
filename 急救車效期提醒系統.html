<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>急救車效期提醒系統</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    /* 修正：分段式進度條樣式 */
    @keyframes segment-load {
      0% { width: 0%; opacity: 0.5; }
      10% { width: 5%; opacity: 1; }
      70% { width: 80%; opacity: 1; }
      100% { width: 100%; opacity: 1; }
    }
    
    .loading-bar-box {
      /* 明確指定容器尺寸，避免塌陷 */
      width: 280px;
      height: 32px; 
      border: 2px solid #64748b; /* slate-500 */
      padding: 3px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.6);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .loading-bar-fill {
      height: 100%;
      /* 使用重複線性漸層創造分段格狀效果：色塊8px + 透明間距4px */
      background-image: repeating-linear-gradient(
        90deg,
        #34d399 0px, /* emerald-400 */
        #34d399 8px,
        transparent 8px,
        transparent 12px
      );
      width: 0;
      animation: segment-load 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      box-shadow: 0 0 8px rgba(52, 211, 153, 0.5);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 圖示 ---
    const Icons = {
      Truck: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"></path><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"></path><circle cx="7" cy="18" r="2"></circle><circle cx="17" cy="18" r="2"></circle></svg>,
      Layout: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>,
      List: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
      Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
      PlusCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>,
      XCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>,
      Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
      Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>,
      AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>,
      Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
      Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>,
      Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
      Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
      Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>,
      Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"></path><path d="M4 19c0-5.523 4.477-10 10-10 1.95 0 3.766.559 5.313 1.526"></path><path d="M20 19c0-3.037-2.463-5.5-5.5-5.5-1.077 0-2.083.313-2.935.856"></path><path d="M22 19c0-7.18-5.82-13-13-13-1.859 0-3.633.388-5.253 1.092"></path></svg>,
      ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      // New Mail Icon
      Mail: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>,
      Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
      // New icon for splash screen
      AmbulanceBig: () => <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-rose-500"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"></path><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"></path><circle cx="7" cy="18" r="2"></circle><circle cx="17" cy="18" r="2"></circle><path d="M10 2v4h4V2z"></path><path d="M7 2h2"></path><path d="M15 2h2"></path></svg>
    };

    // === 系統訊息視窗 (取代原生的 alert/confirm) ===
    const SystemModal = ({ config, onClose }) => {
      if (!config) return null;
      return (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className={`px-5 py-3 border-b flex justify-between items-center ${config.type === 'error' ? 'bg-rose-100 border-rose-200 text-rose-700' : 'bg-slate-100 border-slate-200 text-slate-700'}`}>
              <h3 className="font-bold text-lg flex items-center gap-2">
                {config.type === 'error' ? <Icons.AlertTriangle /> : <Icons.AmbulanceBig className="w-5 h-5" />} 
                {config.title}
              </h3>
              <button onClick={onClose}><Icons.XCircle className="w-5 h-5 opacity-50 hover:opacity-100" /></button>
            </div>
            <div className="p-5 text-gray-700 whitespace-pre-wrap leading-relaxed">
              {config.message}
            </div>
            <div className="p-4 bg-gray-50 border-t flex gap-3 justify-end">
              {config.onConfirm ? (
                <>
                  <button onClick={onClose} className="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold hover:bg-gray-100">取消</button>
                  <button onClick={() => { config.onConfirm(); onClose(); }} className="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-sm">確認執行</button>
                </>
              ) : (
                <button onClick={onClose} className="w-full px-4 py-2 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-700">關閉</button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // === 智慧效期輸入元件 ===
    const SmartExpiryInput = ({ value, onChange }) => {
      const [y, setY] = useState('');
      const [m, setM] = useState('');
      const [d, setD] = useState('');
      const refY = useRef(null);
      const refM = useRef(null);
      const refD = useRef(null);

      useEffect(() => {
        if (!value) { setY(''); setM(''); setD(''); return; }
        const parts = value.split('-');
        setY(parts[0] || ''); setM(parts[1] || ''); setD(parts[2] || '');
      }, [value]);

      const triggerChange = (newY, newM, newD) => {
        let finalStr = `${newY}`;
        if (newM) finalStr += `-${newM}`;
        if (newD) finalStr += `-${newD}`;
        onChange(finalStr);
      };

      const handleYearChange = (e) => {
        const val = e.target.value.slice(0, 4);
        setY(val); triggerChange(val, m, d);
        if (val.length === 4) refM.current.focus();
      };
      
      const handleMonthChange = (e) => {
        let val = e.target.value.slice(0, 2);
        if (val.length === 2 && parseInt(val) > 12) val = '12';
        setM(val); triggerChange(y, val, d);
        if (val.length === 2) refD.current.focus();
      };
      
      const handleDayChange = (e) => {
        let val = e.target.value.slice(0, 2);
        if (val.length === 2 && parseInt(val) > 31) val = '31';
        setD(val); triggerChange(y, m, val);
      };

      const handleKeyDown = (e, currentVal, prevRef) => {
        if (e.key === 'Backspace' && currentVal === '' && prevRef) {
          e.preventDefault(); 
          prevRef.current.focus();
        }
      };

      return (
        <div className="flex items-center gap-1">
          <div className="relative group">
            <input ref={refY} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="YYYY" value={y} onChange={handleYearChange} className="w-14 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">年</span>
          </div>
          <div>
          <span className="text-gray-400 font-bold">-</span>
          </div>
          <div className="relative group">
            <input ref={refM} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="MM" value={m} onChange={handleMonthChange} onKeyDown={(e)=>handleKeyDown(e,m,refY)} className="w-10 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">月</span>
          </div>
          <div>
          <span className="text-gray-400 font-bold">-</span>
          </div>
          <div className="relative group">
            <input ref={refD} type="text" inputMode="numeric" pattern="[0-9]*" placeholder="DD" value={d} onChange={handleDayChange} onKeyDown={(e)=>handleKeyDown(e,d,refM)} className="w-10 h-9 text-center font-bold text-gray-900 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all placeholder-gray-300" />
            <span className="absolute -top-3 left-1 text-[9px] text-gray-400 bg-white px-1">日</span>
          </div>
        </div>
      );
    };

    // === 主應用程式 ===
    const App = () => {
      const [mode, setMode] = useState('view');
      const GRID_COLS = 40;
      const GRID_ROWS = 30;

      // Google Sheet API URL 管理 (資料存取)
      const DEFAULT_GS_URL = "https://script.google.com/macros/s/AKfycbw9P7K5tSHkAI-KOQKEuEqyIYszLUVfLiUOZDcZSTMZr9k96ME2r_NHETo1RgNSpbQZjA/exec";
      const [gsUrl, setGsUrl] = useState(() => localStorage.getItem('gs_url') || DEFAULT_GS_URL);
      const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error
      
      // 郵件相關 State
      const [mailConfig, setMailConfig] = useState(() => {
        const saved = localStorage.getItem('ecart_mail_config');
        return saved ? JSON.parse(saved) : { email: '', apiUrl: '' };
      });
      const [showMailModal, setShowMailModal] = useState(false);
      const [isMailTesting, setIsMailTesting] = useState(false);

      // 系統訊息視窗 State (取代 alert)
      const [modalConfig, setModalConfig] = useState(null);

      // Loading State
      const [isLoading, setIsLoading] = useState(true);

      // 資料層 (預設為空或從 Local 讀取)
      const [trays, setTrays] = useState(() => {
        const saved = localStorage.getItem('ecart_data_cache');
        return saved ? JSON.parse(saved) : [
          { id: '1', name: '第一層', slots: [] }
        ];
      });
      const [activeTrayId, setActiveTrayId] = useState(trays[0].id);

      // App State
      const [selectedSlot, setSelectedSlot] = useState(null);
      const [editForm, setEditForm] = useState(null);
      const [trayMenuOpen, setTrayMenuOpen] = useState(false);
      const [trayEditForm, setTrayEditForm] = useState({ name: '' });
      const [isDeleteConfirming, setIsDeleteConfirming] = useState(false); // 刪除確認狀態
      const [isTraySelectorOpen, setIsTraySelectorOpen] = useState(false); // 藥盤選擇器狀態
      
      const [isDrawing, setIsDrawing] = useState(false);
      const [dragStart, setDragStart] = useState(null);
      const [dragCurrent, setDragCurrent] = useState(null);
      const gridContainerRef = useRef(null);

      const activeTray = trays.find(t => String(t.id) === String(activeTrayId)) || trays[0];

      // === Google Sheet 同步邏輯 ===
      
      const fetchFromSheet = async (url = gsUrl) => {
        if (!url) {
            setIsLoading(false);
            return;
        }
        setSyncStatus('syncing');
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) {
            setTrays(data);
            localStorage.setItem('ecart_data_cache', JSON.stringify(data));
            // 確保 activeTrayId 有效
            if (!data.find(t => String(t.id) === String(activeTrayId))) {
              setActiveTrayId(data[0].id);
            }
            setSyncStatus('success');
          } else {
            setSyncStatus('success');
          }
        } catch (e) {
          console.error("Load failed", e);
          setSyncStatus('error');
        } finally {
          setTimeout(() => setSyncStatus('idle'), 2000);
          // 模擬一點延遲讓動畫跑一下，增加質感
          setTimeout(() => setIsLoading(false), 1500);
        }
      };

      const saveToSheet = async (newData) => {
        setTrays(newData);
        localStorage.setItem('ecart_data_cache', JSON.stringify(newData));
        
        if (!gsUrl) return;
        setSyncStatus('syncing');
        
        try {
          await fetch(gsUrl, {
            method: 'POST',
            body: JSON.stringify(newData),
            headers: { 'Content-Type': 'text/plain' }
          });
          setSyncStatus('success');
        } catch (e) {
          console.error("Save failed", e);
          setSyncStatus('error');
        } finally {
          setTimeout(() => setSyncStatus('idle'), 2000);
        }
      };

      useEffect(() => {
        if (gsUrl) fetchFromSheet();
        else setIsLoading(false);
      }, []);

      // === 輔助邏輯 (狀態計算) ===
      const getStatus = (expiry) => {
        // 修正：強制轉型為字串並去空白，防止 split 報錯
        const strExpiry = String(expiry || '').trim();
        if (!strExpiry) return { type: 'empty', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-400', label: '未設定' };
        
        const parts = strExpiry.split('-');
        // 簡單檢查格式 (至少要有 YYYY-MM)
        if (parts.length < 2) return { type: 'empty', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-400', label: '未設定' };

        const expY = parseInt(parts[0], 10);
        const expM = parseInt(parts[1], 10);
        const expD = parts[2] ? parseInt(parts[2], 10) : null; // 取得日 (如果有)

        if (isNaN(expY) || isNaN(expM)) return { type: 'empty', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-400', label: '未設定' };
        
        const today = new Date();
        today.setHours(0, 0, 0, 0); // 歸零時間，只比對日期

        let isExpired = false;

        // 判斷過期邏輯
        if (expD !== null && !isNaN(expD)) {
            // === 情況 A: 有指定日期 (YYYY-MM-DD) ===
            // 建立效期當日的 Date 物件 (注意月份要 -1)
            const expiryDate = new Date(expY, expM - 1, expD);
            // 如果 效期日期 < 今天，就是過期
            if (expiryDate < today) {
                isExpired = true;
            }
        } else {
            // === 情況 B: 只指定月份 (YYYY-MM) ===
            // 邏輯：該月結束前都算有效。
            // 只有當「現在年份 > 效期年份」或「年份相同但現在月份 > 效期月份」時才算過期
            // 簡單算法：計算月差。如果 (效期 - 現在) < 0 代表過期
            // 注意：today.getMonth() 是 0-11，所以要 +1 變成 1-12 來跟 expM (1-12) 比較
            const currentMonthDiff = (expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1));
            if (currentMonthDiff < 0) {
                isExpired = true;
            }
        }

        if (isExpired) {
            return { type: 'expired', bg: 'bg-rose-50', border: 'border-rose-500', text: 'text-rose-800', label: '過期' };
        }

        // 判斷近效期 (6個月內)
        // 為了保持一致性，近效期檢查統一使用「月份差」來判斷比較直觀
        const diffMonths = (expY - today.getFullYear()) * 12 + (expM - (today.getMonth() + 1));
        
        // 補充：如果有指定日期且還沒過期，但已經是當月了 (diffMonths === 0)，當然也是近效期
        if (diffMonths < 6) {
             return { type: 'warning', bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-800', label: '近效期' };
        }

        return { type: 'ok', bg: 'bg-emerald-50', border: 'border-emerald-500', text: 'text-emerald-800', label: '正常' };
      };

      const getSlotOverallStatus = (batches) => {
        if (!batches || batches.length === 0) return 'border-slate-600 bg-slate-800';
        let worstPriority = 0; 
        let resultClass = 'border-slate-600 bg-slate-800';
        batches.forEach(b => {
          const s = getStatus(b.expiry);
          let p = 0;
          if (s.type === 'expired') p = 3; else if (s.type === 'warning') p = 2; else if (s.type === 'ok') p = 1;
          if (p > worstPriority) {
            worstPriority = p;
            if (s.type === 'expired') resultClass = 'border-rose-500 bg-rose-900/40';
            else if (s.type === 'warning') resultClass = 'border-yellow-500 bg-yellow-900/40';
            else if (s.type === 'ok') resultClass = 'border-emerald-500 bg-slate-700';
          }
        });
        return resultClass;
      };

      // 修正：嚴謹的排序函式，由近到遠 (字串比對)
      const getSortedBatches = (batches) => {
        if (!batches) return [];
        return [...batches].sort((a, b) => {
          const dateA = a.expiry || '9999-99-99';
          const dateB = b.expiry || '9999-99-99';
          if (dateA < dateB) return -1;
          if (dateA > dateB) return 1;
          return 0;
        });
      };

      const getTotalQty = (batches) => batches ? batches.reduce((acc, b) => acc + (parseInt(b.qty)||0), 0) : 0;

      // === 郵件處理邏輯 ===
      const saveMailConfig = () => {
        localStorage.setItem('ecart_mail_config', JSON.stringify(mailConfig));
        setModalConfig({ title: "設定", message: "設定已儲存" });
      };

      const sendMail = async (type = 'test', items = []) => {
        if (!mailConfig.apiUrl || !mailConfig.email) {
          setModalConfig({ title: "設定錯誤", message: "請先完成郵件設定 (URL 與 Email)", type: 'error' });
          return;
        }
        
        setIsMailTesting(true);
        try {
          const response = await fetch(mailConfig.apiUrl, {
            method: 'POST',
            mode: 'no-cors', // Google Script 的特性
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: type,
              to: mailConfig.email,
              items: items
            })
          });
          
          setModalConfig({ 
             title: type === 'test' ? "測試發送" : "警報發送", 
             message: type === 'test' ? "測試請求已發送！\n請檢查您的信箱 (若未收到請檢查垃圾郵件或 Script 部署權限)。" : "警報清單已發送！",
             type: 'success'
          });
          
        } catch (error) {
          console.error("Mail Error:", error);
          setModalConfig({ title: "發送失敗", message: "請檢查 URL 是否正確或網路連線", type: 'error' });
        } finally {
          setIsMailTesting(false);
        }
      };

      const checkAndSendAlert = () => {
        try {
          // 防呆：檢查 trays 資料是否存在
          if (!trays || !Array.isArray(trays)) {
             setModalConfig({ title: "資料異常", message: "無法讀取藥盤資料，請重整頁面後再試。", type: 'error' });
             return;
          }

          let alertItems = [];
          
          // 使用更安全的迴圈方式：層層檢查 null/undefined
          trays.forEach(tray => {
            if (!tray || !tray.slots || !Array.isArray(tray.slots)) return;

            tray.slots.forEach(slot => {
               if (!slot || !slot.batches || !Array.isArray(slot.batches)) return;

               slot.batches.forEach(batch => {
                 // 修正關鍵：如果 batch 本身是 null/undefined，直接跳過，防止存取屬性時崩潰
                 if (!batch) return;

                 const s = getStatus(batch.expiry);
                 if (s.type === 'warning' || s.type === 'expired') {
                   alertItems.push({
                     trayName: tray.name || '未命名藥盤',
                     name: slot.name || '未命名藥品',
                     expiry: batch.expiry || '未知效期',
                     qty: batch.qty || 0,
                     status: s.label
                   });
                 }
               });
            });
          });

          if (alertItems.length > 0) {
            // 使用自定義 Modal 取代 window.confirm
            setModalConfig({
              title: "掃描完成",
              message: `共發現 ${alertItems.length} 項異常藥品 (過期或近效期)。\n是否立即發送清單至 ${mailConfig.email}？`,
              type: 'info',
              onConfirm: () => sendMail('alert', alertItems)
            });
          } else {
            setModalConfig({ title: "掃描完成", message: "目前所有藥品效期皆正常，無需發送警報。", type: 'info' });
          }
        } catch (e) {
          console.error("Check Alert Error:", e);
          setModalConfig({ title: "發生錯誤", message: "檢查過程發生錯誤：" + e.message + "\n請截圖聯繫管理員。", type: 'error' });
        }
      };

      // === 匯出報表功能 (HTML 列印) ===
      const handleExportReport = () => {
        const printContent = document.createElement('div');
        printContent.innerHTML = `
          <html>
            <head>
              <title>${activeTray.name} - 庫存清單</title>
              <style>
                body { font-family: system-ui, sans-serif; padding: 20px; }
                h1 { text-align: center; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                thead { display: table-header-group; }
                tr { page-break-inside: avoid; }
                th { background-color: #f3f4f6; font-weight: bold; }
                .high-alert { color: #e11d48; font-weight: bold; font-size: 10px; border: 1px solid #e11d48; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
                .expired { color: #be123c; font-weight: bold; }
                /* 修改：匯出報表的近效期顏色為黃色/金色 */
                .warning { color: #a16207; font-weight: bold; }
                .text-right { text-align: right; }
                .text-center { text-align: center; }
              </style>
            </head>
            <body>
              <h1>${activeTray.name} - 庫存清單</h1>
              <table>
                <thead>
                  <tr>
                    <th width="40%">藥品名稱</th>
                    <th width="15%" class="text-right">應備量</th>
                    <th width="15%" class="text-right">數量</th>
                    <th width="20%">效期</th>
                    <th width="10%" class="text-center">狀態</th>
                  </tr>
                </thead>
                <tbody>
                  ${activeTray.slots.map(slot => {
                    const sortedBatches = getSortedBatches(slot.batches);
                    const totalQty = getTotalQty(slot.batches);
                    const requiredQty = slot.requiredQty || 0;
                    
                    if (!sortedBatches || sortedBatches.length === 0) {
                      return `
                        <tr>
                          <td>${slot.name} ${slot.highAlert ? '<span class="high-alert">High Alert</span>' : ''}</td>
                          <td class="text-right">${requiredQty}</td>
                          <td class="text-right">0</td>
                          <td>-</td>
                          <td class="text-center">無庫存</td>
                        </tr>
                      `;
                    }
                    
                    return sortedBatches.map((batch, idx) => {
                      const s = getStatus(batch.expiry);
                      const statusClass = s.type === 'expired' ? 'expired' : (s.type === 'warning' ? 'warning' : '');
                      return `
                        <tr>
                          <td>${idx === 0 ? `${slot.name} ${slot.highAlert ? '<span class="high-alert">High Alert</span>' : ''}` : ''}</td>
                          <td class="text-right">${idx === 0 ? requiredQty : ''}</td>
                          <td class="text-right">${batch.qty}</td>
                          <td class="${statusClass}">${batch.expiry || '未設定'}</td>
                          <td class="text-center ${statusClass}">${s.label}</td>
                        </tr>
                      `;
                    }).join('');
                  }).join('')}
                </tbody>
              </table>
              <div style="margin-top: 20px; font-size: 10px; color: #666; text-align: right;">
                列印時間: ${new Date().toLocaleString()}
              </div>
            </body>
          </html>
        `;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(printContent.innerHTML);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };

      // === 藥盤管理功能 (恢復) ===
      const addTray = () => {
        const newId = Date.now().toString();
        const newTray = { id: newId, name: `新藥盤 ${trays.length + 1}`, slots: [] };
        const newData = [...trays, newTray];
        saveToSheet(newData);
        setActiveTrayId(newId);
        setIsTraySelectorOpen(false); // 新增後關閉選單
      };

      const duplicateTrayStructure = () => {
        const newId = Date.now().toString();
        const newSlots = activeTray.slots.map(s => ({
          ...s,
          id: `s-${newId}-${Math.random().toString(36).substr(2, 9)}`,
          batches: [] // 清空庫存
        }));
        const newTray = { id: newId, name: `${activeTray.name} (複製)`, slots: newSlots };
        const newData = [...trays, newTray];
        saveToSheet(newData);
        setActiveTrayId(newId);
        setTrayMenuOpen(false);
      };

      // 修正後的刪除功能：不需要 confirm，改為 UI 切換
      const executeDeleteTray = () => {
        const targetTrayId = activeTray.id;

        if (trays.length <= 1) return; // 防呆

        const newData = trays.filter(t => String(t.id) !== String(targetTrayId));
        saveToSheet(newData);
        
        if (newData.length > 0) {
           setActiveTrayId(newData[0].id);
        }
        
        setIsDeleteConfirming(false);
        setTrayMenuOpen(false);
      };

      const renameActiveTray = () => {
        if (!trayEditForm.name.trim()) return;
        const targetId = String(activeTray.id);
        const newData = trays.map(t => String(t.id) === targetId ? { ...t, name: trayEditForm.name } : t);
        saveToSheet(newData);
        setTrayMenuOpen(false);
      };

      const openTrayMenu = () => {
        setTrayEditForm({ name: activeTray.name });
        setIsDeleteConfirming(false); // 重置確認狀態
        setTrayMenuOpen(true);
      };

      // === 互動處理 ===
      const isOverlapping = (rect1, rect2) => {
        return (rect1.x < rect2.x + rect2.w && rect1.x + rect1.w > rect2.x && rect1.y < rect2.y + rect2.h && rect1.y + rect1.h > rect2.y);
      };

      const getGridCoordinates = (e) => {
        if (!gridContainerRef.current) return null;
        // Fix for Bug 2: Use clientWidth/Height to exclude border, and account for padding
        // This ensures the cell size calculation is precise inside the content box
        const container = gridContainerRef.current;
        const computedStyle = window.getComputedStyle(container);
        const paddingLeft = parseFloat(computedStyle.paddingLeft);
        const paddingTop = parseFloat(computedStyle.paddingTop);
        const contentWidth = container.clientWidth - paddingLeft - parseFloat(computedStyle.paddingRight);
        const contentHeight = container.clientHeight - paddingTop - parseFloat(computedStyle.paddingBottom);
        
        const cellW = contentWidth / GRID_COLS;
        const cellH = contentHeight / GRID_ROWS;
        
        // Fix for Bug 2: Use nativeEvent.offsetX/Y which is relative to the target (the container)
        // This naturally handles scrolling and positioning without complex clientRect math
        // Ensure we subtract padding to get the grid coordinate
        const x = Math.floor((e.nativeEvent.offsetX - paddingLeft) / cellW);
        const y = Math.floor((e.nativeEvent.offsetY - paddingTop) / cellH);
        
        if (x < 0 || x >= GRID_COLS || y < 0 || y >= GRID_ROWS) return null;
        return { x, y };
      };

      const handlePointerDown = (e) => {
        if (mode !== 'admin') return; 
        const coords = getGridCoordinates(e);
        if (!coords) return;
        const clickedSlot = activeTray.slots.find(s => coords.x >= s.x && coords.x < s.x + s.w && coords.y >= s.y && coords.y < s.y + s.h);
        if (clickedSlot) return; 
        e.currentTarget.setPointerCapture(e.pointerId);
        setIsDrawing(true);
        setDragStart(coords);
        setDragCurrent(coords);
        setSelectedSlot(null);
      };

      const handlePointerMove = (e) => {
        if (!isDrawing) return;
        const coords = getGridCoordinates(e);
        if (coords) setDragCurrent(coords);
      };

      const handlePointerUp = (e) => {
        if (!isDrawing) return;
        setIsDrawing(false);
        e.currentTarget.releasePointerCapture(e.pointerId);
        if (!dragStart || !dragCurrent) return;
        const x = Math.min(dragStart.x, dragCurrent.x);
        const y = Math.min(dragStart.y, dragCurrent.y);
        const w = Math.abs(dragStart.x - dragCurrent.x) + 1;
        const h = Math.abs(dragStart.y - dragCurrent.y) + 1;
        const newRect = { x, y, w, h };
        if (activeTray.slots.some(slot => isOverlapping(newRect, slot))) { alert("區域重疊"); return; }
        
        // New slot creation includes requiredQty default to 0
        const newSlot = { id: `s-${Date.now()}`, ...newRect, name: '新區域', highAlert: false, requiredQty: 0, batches: [] };
        
        // Save
        const updatedSlots = [...activeTray.slots, newSlot];
        const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t);
        saveToSheet(newData);
        
        setSelectedSlot(newSlot);
        setEditForm({ ...newSlot });
      };

      const openEditModal = (slot) => {
        setSelectedSlot(slot);
        // Sort batches by expiry date when opening the modal
        const sortedBatches = slot.batches 
          ? [...slot.batches].sort((a, b) => {
              const dateA = a.expiry || '9999';
              const dateB = b.expiry || '9999';
              if (dateA < dateB) return -1;
              if (dateA > dateB) return 1;
              return 0;
            })
          : [];
        setEditForm({ ...slot, batches: sortedBatches.map(b => ({...b})) });
      };

      const saveForm = () => {
        const updatedSlots = activeTray.slots.map(s => s.id === selectedSlot.id ? { ...s, ...editForm } : s);
        const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t);
        saveToSheet(newData);
        setSelectedSlot(null);
      };

      const deleteCurrentSlot = () => {
        const updatedSlots = activeTray.slots.filter(s => s.id !== selectedSlot.id);
        const newData = trays.map(t => String(t.id) === String(activeTrayId) ? { ...t, slots: updatedSlots } : t);
        saveToSheet(newData);
        setSelectedSlot(null);
      };

      const getPreviewStyle = () => {
        if (!isDrawing || !dragStart || !dragCurrent) return {};
        const x = Math.min(dragStart.x, dragCurrent.x);
        const y = Math.min(dragStart.y, dragCurrent.y);
        const w = Math.abs(dragStart.x - dragCurrent.x) + 1;
        const h = Math.abs(dragStart.y - dragCurrent.y) + 1;
        return { gridColumn: `${x+1}/span ${w}`, gridRow: `${y+1}/span ${h}`, backgroundColor: 'rgba(59,130,246,0.5)', border: '1px dashed #60a5fa', zIndex: 20, pointerEvents: 'none' };
      };

      // 批次庫存編輯
      const addBatch = () => setEditForm(prev => ({...prev, batches: [...(prev.batches||[]), {id: Date.now(), expiry: '', qty: 1}]}));
      const removeBatch = (id) => setEditForm(prev => ({...prev, batches: prev.batches.filter(b => b.id !== id)}));
      const updateBatch = (id, field, val) => setEditForm(prev => ({...prev, batches: prev.batches.map(b => b.id === id ? {...b, [field]: val} : b)}));

      if (isLoading) {
        return (
          <div className="h-screen w-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex flex-col items-center justify-center z-50 relative overflow-hidden">
              {/* Decorative background elements */}
              <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-3xl animate-pulse"></div>
              <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-600/10 rounded-full blur-3xl animate-pulse delay-1000"></div>

              {/* Cute Illustration with Glow */}
              <div className="mb-8 animate-bounce relative">
                  <div className="absolute inset-0 bg-rose-500 blur-2xl opacity-20"></div>
                  <Icons.AmbulanceBig />
              </div>
              
              <h2 className="text-2xl font-bold text-white mb-4 tracking-wider relative z-10">臺北榮民總醫院玉里分院 | 急救車效期提醒系統</h2>
              
              {/* Progress Bar Container */}
              <div className="loading-bar-box relative z-10">
                  <div className="loading-bar-fill"></div>
              </div>
              <p className="text-slate-400 text-sm mt-4 relative z-10">系統載入中，請稍候...</p>
          </div>
        )
      }

      return (
        <div className="h-screen w-screen flex flex-col">
          {/* Header */}
          <header className="bg-slate-800 border-b border-slate-700 p-0 flex justify-between items-stretch shrink-0 h-12 z-30 relative">
            <div className="flex-1 flex overflow-hidden px-2 gap-2 items-center">
              <div className="flex items-center text-blue-400 font-bold px-3 select-none mr-2 hidden md:flex shrink-0">
                <Icons.Truck /> <span className="ml-2 text-sm md:text-lg">臺北榮民總醫院玉里分院 | 急救車效期提醒系統</span>
                {syncStatus === 'syncing' && <span className="ml-2 text-[10px] text-yellow-400 animate-pulse">● 同步中</span>}
                {syncStatus === 'success' && <span className="ml-2 text-[10px] text-emerald-400">● 已儲存</span>}
                {syncStatus === 'error' && <span className="ml-2 text-[10px] text-rose-400">● 失敗</span>}
              </div>
              
              {/* Tray Selector Toggle Button */}
              <button 
                onClick={() => setIsTraySelectorOpen(!isTraySelectorOpen)}
                className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold text-sm md:text-base transition-colors border border-slate-600"
              >
                <span>{activeTray.name}</span>
                <Icons.ChevronDown />
              </button>

              {/* Edit Current Tray Button */}
              <button 
                onClick={openTrayMenu} 
                className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-full transition-colors"
                title="編輯目前藥盤"
              >
                <Icons.Edit />
              </button>
            </div>
            
            <div className="flex items-center px-4 bg-slate-900 border-l border-slate-800 shadow-[-10px_0_10px_rgba(0,0,0,0.5)] z-20 gap-2 shrink-0">
               {/* Mail Settings Button - Added to left side */}
               <div className="mr-2 border-r border-slate-700 pr-2">
                 <button onClick={() => setShowMailModal(true)} className="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition text-slate-400 hover:text-white hover:bg-slate-800" title="郵件通知設定">
                    <Icons.Mail />
                    <span className="hidden sm:inline">通知</span>
                 </button>
               </div>
               
               <div className="flex bg-black/40 rounded p-0.5 border border-slate-700">
                <button onClick={()=>{setMode('view');setSelectedSlot(null);}} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='view'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.Layout /> 盤點</button>
                <button onClick={()=>{setMode('list');setSelectedSlot(null);}} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='list'?'bg-purple-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.List /> 清單</button>
                <button onClick={()=>{setMode('admin');setSelectedSlot(null);}} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition ${mode==='admin'?'bg-amber-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.Settings /> 設定</button>
              </div>
            </div>

            {/* Tray Selector Dropdown Overlay */}
            {isTraySelectorOpen && (
              <div className="absolute top-full left-0 w-full bg-slate-800/95 backdrop-blur-md border-b border-slate-600 shadow-2xl z-50 p-4 animate-in fade-in slide-in-from-top-2 duration-200">
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-3">
                    <h3 className="text-slate-300 text-sm font-bold uppercase tracking-wider">切換藥盤</h3>
                    <button onClick={() => setIsTraySelectorOpen(false)} className="text-slate-400 hover:text-white"><Icons.XCircle /></button>
                  </div>
                  {/* 修改處：將 grid-cols-2 改為 grid-cols-4，並縮小 gap 以節省空間 */}
                  <div className="grid grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2">
                    {trays.map(tray => (
                      <button 
                        key={tray.id}
                        onClick={() => { setActiveTrayId(tray.id); setIsTraySelectorOpen(false); }}
                        className={`p-2 rounded-lg border text-center font-bold text-sm transition-all truncate ${String(activeTrayId) === String(tray.id) ? 'bg-blue-600 border-blue-500 text-white shadow-lg scale-[1.02]' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600 hover:text-white'}`}
                        title={tray.name}
                      >
                        {tray.name}
                      </button>
                    ))}
                    <button 
                      onClick={addTray}
                      className="p-2 rounded-lg border border-dashed border-slate-500 text-slate-400 hover:text-white hover:border-slate-300 hover:bg-slate-700/50 flex items-center justify-center gap-1 font-bold text-sm transition-all"
                    >
                      <Icons.PlusCircle /> <span className="hidden sm:inline">新增</span>
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* Backdrop for closing dropdown when clicking outside */}
            {isTraySelectorOpen && (
              <div className="fixed inset-0 top-[48px] z-40" onClick={() => setIsTraySelectorOpen(false)}></div>
            )}
          </header>

          {/* Workspace */}
          <div className="flex-1 overflow-auto bg-slate-950 relative cursor-grab active:cursor-grabbing p-1 md:p-4">
            {mode === 'list' ? (
              <div className="w-full h-full min-w-[800px] flex flex-col bg-slate-900 rounded-lg border-2 border-slate-800 shadow-2xl overflow-hidden relative">
                {/* Top Toolbar for List Mode */}
                <div className="bg-slate-800 border-b border-slate-700 p-3 flex justify-between items-center">
                  <span className="text-slate-300 font-bold text-sm">庫存總覽</span>
                  <button 
                    onClick={handleExportReport}
                    className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold rounded shadow-lg transition-colors border border-emerald-500"
                  >
                    <Icons.Download /> 匯出報表 (PDF)
                  </button>
                </div>

                <div className="overflow-auto flex-1"> 
                  <table className="w-full text-left text-sm text-slate-400">
                    <thead className="text-xs uppercase text-slate-200 sticky top-0 z-10 shadow-md">
                      <tr>
                        {/* Moved sticky styles to th for better browser compatibility */}
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10">藥品名稱</th>
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10 text-right">應備量</th>
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10 text-right">數量</th>
                        <th className="px-4 py-3 font-bold border-b border-slate-700 bg-slate-800 sticky top-0 z-10">效期 (YYYY-MM-DD)</th>
                        <th className="px-4 py-3 font-bold border-b border-slate-700 text-center bg-slate-800 sticky top-0 z-10">狀態</th>
                      </tr>
                    </thead>
                    <tbody className="">
                      {activeTray.slots.map(slot => {
                        const sortedBatches = getSortedBatches(slot.batches);
                        const totalQty = getTotalQty(slot.batches);
                        const requiredQty = slot.requiredQty || 0;
                        const isQtyOk = totalQty === parseInt(requiredQty);
                        const qtyTextColor = isQtyOk ? 'text-emerald-400' : 'text-rose-400';

                        if (!sortedBatches || sortedBatches.length === 0) {
                           return (
                             <tr key={slot.id} className={`hover:bg-slate-800/50 transition-colors border-t border-slate-600`}>
                               <td className="px-4 py-3 font-medium text-white flex items-center gap-2">
                                 {slot.name}
                                 {slot.highAlert && <span className="text-[10px] bg-rose-600 text-white px-1.5 py-0.5 rounded font-bold">High Alert</span>}
                               </td>
                               <td className="px-4 py-3 font-mono text-right text-slate-500">{requiredQty}</td>
                               <td className="px-4 py-3 font-mono text-right text-slate-500">0</td>
                               <td className="px-4 py-3 font-mono text-slate-500">-</td>
                               <td className="px-4 py-3 text-center">
                                 <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-black border-2 tracking-wide bg-slate-800 text-slate-500 border-slate-700 shadow-sm">
                                   無庫存
                                 </span>
                               </td>
                             </tr>
                           );
                        }
                        return sortedBatches.map((batch, index) => {
                          const s = getStatus(batch.expiry);
                          return (
                            <tr key={`${slot.id}-${batch.id}`} className={`hover:bg-slate-800/50 transition-colors ${index === 0 ? 'border-t border-slate-600' : 'border-t border-slate-800'}`}>
                              <td className="px-4 py-3 font-medium text-white">
                                {index === 0 && (
                                  <div className="flex items-center gap-2">
                                    {slot.name}
                                    {slot.highAlert && <span className="text-[10px] bg-rose-600 text-white px-1.5 py-0.5 rounded font-bold">High Alert</span>}
                                  </div>
                                )}
                              </td>
                              <td className="px-4 py-3 font-mono text-right text-white font-bold">{index === 0 ? requiredQty : ''}</td>
                              <td className="px-4 py-3 font-mono text-right text-white font-bold">{batch.qty}</td>
                              <td className="px-4 py-3 font-mono text-slate-300">{batch.expiry || '未設定'}</td>
                              <td className="px-4 py-3 text-center">
                                {/* 修正：使用 font-bold 與 text-sm 加深加粗文字 */}
                                <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-bold border-2 tracking-wide ${s.bg} ${s.text} ${s.border} bg-opacity-10 shadow-sm`}>
                                  {s.type === 'expired' && <Icons.AlertTriangle />}
                                  {s.label}
                                </span>
                              </td>
                            </tr>
                          );
                        });
                      })}
                    </tbody>
                  </table>
                  {activeTray.slots.length === 0 && (
                    <div className="flex flex-col items-center justify-center py-20 text-slate-600">
                      <Icons.Layout />
                      <p className="mt-2 text-sm">此藥盤尚無內容</p>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="w-full h-full min-w-[800px] min-h-[600px] flex flex-col">
                <div ref={gridContainerRef} className={`relative flex-1 bg-slate-900 rounded-lg border-2 border-slate-800 shadow-2xl overflow-hidden ${mode==='admin'?'cursor-crosshair ring-1 ring-amber-500/30':''}`}
                  style={{ 
                    display: 'grid', 
                    // Fix for Bug 1: Use minmax(0, 1fr) to prevent track expansion by content
                    gridTemplateColumns: `repeat(${GRID_COLS}, minmax(0, 1fr))`, 
                    gridTemplateRows: `repeat(${GRID_ROWS}, minmax(0, 1fr))`, 
                    gap: '1px', 
                    padding: '2px', 
                    touchAction: mode === 'admin' ? 'none' : 'auto',
                    // Fix for Bug 3: Use background gradient for grid lines instead of 1200 divs
                    backgroundImage: `
                      linear-gradient(to right, rgba(30, 41, 59, 0.5) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(30, 41, 59, 0.5) 1px, transparent 1px)
                    `,
                    backgroundSize: `calc(100% / ${GRID_COLS}) calc(100% / ${GRID_ROWS})`
                  }}
                  onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp}
                >
                  {/* Fix for Bug 3: Removed Array.from loop creating empty divs */}
                  {isDrawing && <div style={getPreviewStyle()} className="rounded"></div>}

                  {activeTray.slots.map(slot => {
                    const borderClass = getSlotOverallStatus(slot.batches);
                    const totalQty = getTotalQty(slot.batches);
                    const requiredQty = slot.requiredQty || 0;
                    const isQtyMatch = totalQty === parseInt(requiredQty);
                    const qtyColorClass = isQtyMatch ? 'text-emerald-400' : 'text-rose-400';
                    const sortedBatches = getSortedBatches(slot.batches);
                    return (
                      // 修正處：將內嵌 onClick 替換為呼叫 openEditModal
                      <div key={slot.id} onPointerDown={(e)=>e.stopPropagation()} onClick={(e)=>{e.stopPropagation(); openEditModal(slot);}}
                        className={`relative rounded-sm flex flex-col p-1 transition-all group border ${borderClass} ${mode==='admin'?'hover:opacity-80':'hover:brightness-110 hover:z-10 shadow-sm'}`}
                        style={{ gridColumn: `${slot.x+1}/span ${slot.w}`, gridRow: `${slot.y+1}/span ${slot.h}`, overflow: 'hidden' }}
                      >
                        <div className="absolute top-0 right-0 flex flex-col items-end z-10">
                           <div className={`bg-slate-900 ${qtyColorClass} text-xs px-2 py-0.5 rounded-bl font-mono font-bold border-l border-b border-slate-600 shadow-md`}>
                             {totalQty}/{requiredQty}
                           </div>
                           {slot.highAlert && <div className="bg-rose-600 text-white text-[10px] px-1.5 py-0.5 rounded-bl font-bold shadow-sm whitespace-nowrap">高警訊</div>}
                        </div>
                        <div className={`text-slate-200 font-bold leading-tight break-words overflow-hidden mb-1 ${slot.h > 2 ? 'text-xs md:text-sm pt-1' : 'text-[9px] md:text-[10px]'}`}>{slot.name}</div>
                        <div className="flex-1 overflow-hidden flex flex-col gap-0.5">
                          {sortedBatches.map((batch) => {
                            const s = getStatus(batch.expiry);
                            return (
                              <div key={batch.id} className={`flex justify-between items-center text-[8px] md:text-[9px] px-1 rounded-sm ${s.bg} ${s.text} bg-opacity-90`}
                              >
                                <span className="font-mono tracking-tighter truncate">{batch.expiry}</span>
                                <span className="font-bold ml-1">x{batch.qty}</span>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-2 flex justify-between items-center text-[10px] text-slate-500 px-2 h-6 shrink-0">
                  <div>{activeTray.name} - GS模式</div>
                  <div>{mode==='view'?'提示：點擊藥品以管理庫存':'提示：按住並拖曳畫出新格子'}</div>
                </div>
              </div>
            )}
          </div>

          {/* System Message Modal (Replaces Native Alert) */}
          <SystemModal config={modalConfig} onClose={() => setModalConfig(null)} />

          {/* Mail Configuration Modal */}
          {showMailModal && (
             <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
               <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col">
                  <div className="px-5 py-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.Mail /> 郵件通知設定</h3>
                    <button onClick={() => setShowMailModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.XCircle /></button>
                  </div>
                  <div className="p-6 space-y-4 text-gray-800">
                     <p className="text-sm text-gray-500">當藥品過期或接近效期時，可透過 Email 接收通知。</p>
                     
                     <div>
                       <label className="text-xs font-bold text-gray-500 uppercase block mb-1">收件人 Email</label>
                       <input 
                         type="email" 
                         value={mailConfig.email} 
                         onChange={e => setMailConfig({...mailConfig, email: e.target.value})}
                         placeholder="example@hospital.org.tw"
                         className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
                       />
                     </div>

                     <div>
                       <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Google Script 發信程式 URL</label>
                       <textarea 
                         value={mailConfig.apiUrl} 
                         onChange={e => setMailConfig({...mailConfig, apiUrl: e.target.value})}
                         placeholder="請貼上您部署的 Google Apps Script 網址 (https://script.google.com/...)"
                         className="w-full p-2.5 border border-gray-300 rounded text-xs font-mono text-gray-600 h-20 focus:ring-2 focus:ring-blue-500 outline-none resize-none" 
                       />
                     </div>
                     
                     <div className="flex gap-2 pt-2">
                        <button 
                           onClick={() => sendMail('test')}
                           disabled={isMailTesting || !mailConfig.email || !mailConfig.apiUrl}
                           className={`flex-1 py-2 rounded-lg font-bold border flex items-center justify-center gap-2 ${isMailTesting ? 'bg-gray-100 text-gray-400' : 'border-slate-300 text-slate-700 hover:bg-slate-50'}`}
                        >
                           {isMailTesting ? '發送中...' : <><Icons.Send /> 測試發信</>}
                        </button>
                        <button 
                           onClick={saveMailConfig} 
                           className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"
                        >
                           <Icons.Save /> 儲存設定
                        </button>
                     </div>
                     
                     <hr className="border-gray-200" />
                     
                     <button 
                       onClick={checkAndSendAlert}
                       className="w-full py-3 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 flex items-center justify-center gap-2 shadow-sm"
                     >
                       <Icons.AlertTriangle /> 立即檢查並發送異常報告
                     </button>
                  </div>
               </div>
             </div>
          )}

          {/* Tray Menu Modal */}
          {trayMenuOpen && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-sm rounded-xl shadow-xl overflow-hidden">
                <div className="px-4 py-3 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.Settings /> 藥盤設定</h3>
                  <button onClick={() => setTrayMenuOpen(false)} className="text-gray-400 hover:text-gray-600"><Icons.XCircle /></button>
                </div>
                
                {isDeleteConfirming ? (
                  <div className="p-6 text-center space-y-4">
                    <div className="mx-auto w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-600">
                      {/* 使用較大的 SVG 警示圖示 */}
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>
                    </div>
                    <div>
                      <h4 className="text-lg font-bold text-gray-900">確定刪除此藥盤？</h4>
                      <p className="text-sm text-gray-500 mt-1">「{activeTray.name}」將被永久刪除，且無法復原。</p>
                    </div>
                    <div className="flex gap-3 pt-2">
                      <button onClick={() => setIsDeleteConfirming(false)} className="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50">取消</button>
                      <button onClick={executeDeleteTray} className="flex-1 py-2 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700">確認刪除</button>
                    </div>
                  </div>
                ) : (
                  <div className="p-4 space-y-4 text-gray-800">
                    <div>
                      <label className="text-xs font-bold text-gray-500 uppercase block mb-1">藥盤名稱</label>
                      <input type="text" value={trayEditForm.name} onChange={e => setTrayEditForm({...trayEditForm, name: e.target.value})} className="w-full p-2 border rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <hr className="border-gray-100"/>
                    <div className="space-y-2">
                      <button onClick={renameActiveTray} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-2"><Icons.Save /> 儲存名稱</button>
                      <button onClick={duplicateTrayStructure} className="w-full py-2 bg-emerald-600 text-white rounded font-bold hover:bg-emerald-700 flex items-center justify-center gap-2"><Icons.Copy /> 複製結構</button>
                      
                      <button 
                        onClick={() => setIsDeleteConfirming(true)} 
                        disabled={trays.length <= 1}
                        className={`w-full py-2 border rounded font-bold flex items-center justify-center gap-2 ${trays.length <= 1 ? 'border-gray-200 text-gray-300 cursor-not-allowed' : 'border-rose-200 text-rose-600 hover:bg-rose-50'}`}
                      >
                        <Icons.Trash2 /> 刪除
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Slot Edit Modal */}
          {selectedSlot && editForm && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div className="px-5 py-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                   <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                     {editForm.name || '未命名'}
                     {editForm.highAlert && <span className="text-xs bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full border border-rose-200">高警訊</span>}
                   </h3>
                   <button onClick={() => setSelectedSlot(null)} className="p-1.5 hover:bg-gray-200 rounded-full text-gray-500"><Icons.XCircle /></button>
                </div>
                <div className="p-6 overflow-y-auto bg-gray-50 space-y-6 flex-1 text-gray-800">
                  {mode === 'admin' && (
                    <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-4">
                      <div className="flex justify-between items-center"><label className="text-xs font-bold text-gray-500 uppercase">基本設定</label></div>
                      <div className="flex gap-4">
                        <div className="flex-1">
                          <label className="text-xs font-bold text-gray-500 uppercase block mb-1">藥品名稱</label>
                          <input type="text" placeholder="輸入藥品名稱" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        <div className="w-24">
                          <label className="text-xs font-bold text-gray-500 uppercase block mb-1">應備量</label>
                          <input type="number" placeholder="0" value={editForm.requiredQty || 0} onChange={e => setEditForm({...editForm, requiredQty: parseInt(e.target.value) || 0})} className="w-full p-2.5 border border-gray-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none text-center" />
                        </div>
                      </div>
                      <label className="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" checked={editForm.highAlert} onChange={e => setEditForm({...editForm, highAlert: e.target.checked})} className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500" />
                        <span className="text-sm font-medium text-gray-700">標記為 High Alert (高警訊)</span>
                      </label>
                    </div>
                  )}
                  <div className="space-y-3">
                    <div className="flex justify-between items-end">
                      <label className="text-sm font-bold text-gray-700 flex items-center gap-2"><Icons.Layers /> 庫存效期清單</label>
                      <button onClick={addBatch} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full font-bold hover:bg-blue-700 flex items-center gap-1 shadow-sm transition-colors"><Icons.PlusCircle /> 新增效期</button>
                    </div>
                    {(!editForm.batches || editForm.batches.length === 0) ? (
                      <div className="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 text-sm bg-white"><Icons.Calendar /> 點擊上方按鈕新增第一筆庫存</div>
                    ) : (
                      editForm.batches.map((b) => {
                        const s = getStatus(b.expiry);
                        return (
                          <div key={b.id} className={`group relative flex flex-wrap md:flex-nowrap items-end gap-3 p-3 rounded-lg border-2 shadow-sm transition-colors bg-white ${s.border}`}>
                            <div className="flex-none">
                              <label className="text-[10px] font-bold text-gray-400 block mb-3 uppercase">效期 (Year-Month-Day)</label>
                              <SmartExpiryInput value={b.expiry} onChange={val => updateBatch(b.id, 'expiry', val)} />
                            </div>
                            <div className="w-20 flex-none">
                               <label className="text-[10px] font-bold text-gray-400 block mb-3 uppercase">數量</label>
                               <input type="number" value={b.qty} onChange={e => updateBatch(b.id, 'qty', e.target.value)} className="w-full h-9 text-center bg-gray-50 border border-gray-300 rounded font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                            <div className="pb-1 mr-auto">
                              <div className={`px-3 py-1.5 rounded-full text-xs font-black flex items-center gap-1 ${s.bg} ${s.text} border ${s.border}`}>{s.type === 'expired' && <Icons.AlertTriangle />}{s.label}</div>
                            </div>
                            <div className="pb-0.5">
                              <button onClick={() => removeBatch(b.id)} className="p-2 text-gray-400 hover:text-rose-600 hover:bg-rose-50 rounded-full transition-colors"><Icons.Trash2 /></button>
                            </div>
                          </div>
                        )
                      })
                    )}
                  </div>
                </div>
                <div className="p-5 bg-white border-t border-gray-200 flex gap-3">
                  {mode === 'admin' && <button onClick={deleteCurrentSlot} className="px-5 py-2.5 border border-rose-200 text-rose-600 rounded-lg font-bold hover:bg-rose-50 transition-colors"><Icons.Trash2 /></button>}
                  <button onClick={saveForm} className="flex-1 py-2.5 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 flex justify-center items-center gap-2 transition-transform active:scale-[0.98]"><Icons.Save /> {mode === 'admin' ? '儲存設定' : '確認更新'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
