<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ç¤¾ç¾¤åˆ†äº«å„ªåŒ– -->
    <meta property="og:title" content="Neuro-X Pro Ultra | å°ˆæ¥­èªçŸ¥è¨“ç·´ç³»çµ±">
    <meta property="og:description" content="ç”±è¦ä»è—¥å¸«é–‹ç™¼çš„é†«ç™‚ç´šå¤§è…¦è¨“ç·´å·¥å…·ã€‚æŒ‘æˆ°é †åºè¨˜æ†¶ã€åœ–å½¢å»£åº¦èˆ‡ç¥ç¶“åå°„é€Ÿåº¦ã€‚">
    <meta property="og:type" content="game">
    <meta name="theme-color" content="#0f172a">
    
    <!-- ç¶²é åœ–ç¤º -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">

    <title>Neuro-X Pro Ultra</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --primary: #3b82f6;
            --accent: #06b6d4;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --card-bg: #020617;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh; 
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            touch-action: manipulation; 
        }

        /* --- ä¸»é¢æ¿ --- */
        .device-panel {
            background: linear-gradient(165deg, #1e293b 0%, #020617 100%);
            padding: 1.25rem;
            border-radius: 24px;
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.05),
                0 30px 60px -12px rgba(0,0,0,0.7),
                inset 0 1px 0 rgba(255,255,255,0.1);
            width: 100%;
            max-width: 460px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            z-index: 10;
        }

        /* --- æ¨™é¡Œåˆ— --- */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 0.75rem;
        }

        .brand {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: var(--accent);
            font-size: 0.95rem;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--success);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .header-actions { display: flex; gap: 8px; }

        .icon-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }
        .icon-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .icon-btn.muted { color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }

        /* --- è¨˜åˆ†æ¿ --- */
        .score-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #334155;
            position: relative;
        }
        
        .score-board::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent); opacity: 0.5;
        }

        .score-item { display: flex; flex-direction: column; align-items: center; }
        .score-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-family: 'Orbitron', sans-serif; letter-spacing: 1px; margin-bottom: 4px; }
        .score-value { font-size: 1.75rem; font-family: 'Orbitron', sans-serif; color: var(--text-main); font-weight: 700; line-height: 1; }
        .score-value.highlight { color: var(--success); text-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }

        /* --- æ¨¡å¼æŒ‰éˆ• --- */
        .mode-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 12px;
        }

        .mode-btn {
            background: transparent;
            border: 1px solid transparent;
            color: #64748b;
            padding: 10px 4px;
            font-size: 0.85rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.3;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .mode-btn:hover { background: rgba(255,255,255,0.03); }
        .mode-btn.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-color: rgba(59, 130, 246, 0.3);
            font-weight: 700;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.1);
        }
        .mode-btn span { font-size: 0.65em; opacity: 0.7; }

        /* --- è¨­å®šå€åŸŸ --- */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        .group-label { font-size: 0.75rem; color: var(--text-muted); margin-left: 4px; }

        .select-input {
            background: #334155;
            color: white;
            border: 1px solid #475569;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            text-align: center;
            cursor: pointer;
            width: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            appearance: none;
        }

        /* --- éŠæˆ²ç¶²æ ¼ --- */
        .grid-wrapper {
            position: relative;
            background: #020617;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid #334155;
            align-self: center;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.9);
            margin: 5px 0;
            touch-action: none; 
        }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }

        .cell {
            width: 48px; height: 48px;
            background: #1e293b;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #334155;
            transition: transform 0.05s, background-color 0.1s;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 380px) { 
            .cell { width: 40px; height: 40px; } 
            .device-panel { padding: 1rem; }
        }

        .cell.booting { background: #3b82f6; box-shadow: 0 0 10px #3b82f6; border-color: #60a5fa; }
        .cell.active { background: #fbbf24; box-shadow: 0 0 25px #fbbf24, inset 0 0 10px white; border-color: #fef08a; z-index: 2; }
        .cell.active-pattern { background: #8b5cf6; box-shadow: 0 0 25px #8b5cf6, inset 0 0 10px white; border-color: #a78bfa; z-index: 2; }
        .cell.correct { background: #22c55e; box-shadow: 0 0 20px #22c55e; }
        .cell.wrong { background: #ef4444; box-shadow: 0 0 20px #ef4444; animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- åº•éƒ¨æ§åˆ¶ --- */
        .status-bar { text-align: center; color: var(--text-muted); font-size: 0.95rem; min-height: 1.5em; font-weight: 500; }
        .footer-controls { display: flex; gap: 10px; }

        .btn {
            border: none; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; font-size: 1rem; font-family: 'Noto Sans TC', sans-serif;
            position: relative; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        .btn-stop { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); flex: 1; }
        .btn-start { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); border: 1px solid rgba(255,255,255,0.1); }
        .btn-share { background: var(--warning); color: #000; flex: 2; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); display: none; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #475569; cursor: not-allowed; box-shadow: none; color: #94a3b8; }

        .credits-footer { margin-top: 1rem; text-align: center; font-size: 0.75rem; color: #475569; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; width: 100%; }

        /* --- å½ˆçª—ç³»çµ± --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #1e293b; border: 1px solid #475569; border-radius: 16px;
            width: 100%; max-width: 360px; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        @keyframes modalIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0;
        }
        .modal-title { color: var(--primary); font-weight: 700; font-family: 'Orbitron', sans-serif; }
        .modal-close-icon { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }

        /* èªªæ˜å…§å®¹ */
        .feature-item { margin-bottom: 1.25rem; }
        .feature-head { color: var(--accent); font-weight: bold; font-size: 0.95rem; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .feature-desc { color: #cbd5e1; font-size: 0.85rem; line-height: 1.6; text-align: justify; }
        .tag-new { background: var(--purple); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; }

        /* æˆç¸¾å¡ */
        .share-card {
            background: #0f172a; border-radius: 12px; padding: 24px 20px; text-align: center;
            border: 2px solid #334155; position: relative; overflow: hidden;
        }
        .share-card::before {
            content: 'NEURO DIAGNOSTIC REPORT'; position: absolute; top: 10px; left: 0; width: 100%;
            font-size: 0.6rem; color: #334155; font-family: 'Orbitron', sans-serif; letter-spacing: 2px;
        }
        .share-grade { font-size: 3.5rem; color: var(--primary); font-family: 'Orbitron', sans-serif; font-weight: bold; margin: 15px 0 5px 0; text-shadow: 0 0 40px rgba(59, 130, 246, 0.3); }
        .share-label { color: #64748b; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .share-details { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .share-detail-item { background: #1e293b; padding: 10px; border-radius: 8px; }
        .share-detail-val { color: white; font-weight: bold; font-size: 0.9rem; }
        .share-detail-key { color: #64748b; font-size: 0.7rem; margin-top: 2px; }
        
        .modal-btn-row { padding: 15px 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.1); flex-shrink: 0; }
        .modal-action-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-copy { background: #334155; color: white; transition: background 0.2s; }
        .btn-copy:hover { background: #475569; }
        .btn-close { background: transparent; border: 1px solid #475569; color: #94a3b8; }

        .blocker { position: absolute; inset: 0; z-index: 50; display: none; }
        #confettiCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 90; }

    </style>
</head>
<body>

    <div class="device-panel">
        <canvas id="confettiCanvas"></canvas>

        <div class="header-row">
            <div class="brand">
                <div class="status-dot"></div>
                NEURO-X ULTRA
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="muteBtn" onclick="toggleMute()" aria-label="éœéŸ³"><span id="muteIcon">ğŸ”Š</span></button>
                <button class="icon-btn" onclick="openModal('info')" aria-label="èªªæ˜">?</button>
            </div>
        </div>

        <div class="score-board">
            <div class="score-item">
                <span class="score-label" id="scoreLabel">Level</span>
                <span class="score-value highlight" id="currentScoreDisplay">1</span>
            </div>
            <div class="score-item">
                <span class="score-label">Record</span>
                <span class="score-value" id="bestScoreDisplay">0</span>
            </div>
        </div>

        <div class="mode-container">
            <button class="mode-btn active" onclick="setMode('forward', this)">é †åºè¨˜æ†¶<span>Forward</span></button>
            <button class="mode-btn" onclick="setMode('reverse', this)">é€†å‘è¨˜æ†¶<span>Reverse</span></button>
            <button class="mode-btn" onclick="setMode('pattern', this)">åœ–å½¢è¨˜æ†¶<span>Pattern</span></button>
            <button class="mode-btn" onclick="setMode('reaction', this)">åæ‡‰è¨“ç·´<span>Speed</span></button>
        </div>

        <div class="settings-grid">
            <div class="control-group">
                <label class="group-label">é€Ÿåº¦é›£åº¦</label>
                <select class="select-input" id="difficultySelect">
                    <option value="normal">æ™®é€š Normal</option>
                    <option value="fast">å¿«é€Ÿ Fast</option>
                    <option value="pro">æ¥µé™ Pro</option>
                </select>
            </div>
            <div class="control-group">
                <label class="group-label">èµ·å§‹ç­‰ç´š</label>
                <select class="select-input" id="startLevelSelect">
                    <option value="1">Level 1</option>
                    <option value="5">Level 5</option>
                    <option value="7">Level 7</option>
                    <option value="10">Level 10</option>
                </select>
            </div>
        </div>

        <div class="status-bar" id="statusText">ç³»çµ±å·²å°±ç·’</div>

        <div class="grid-wrapper">
            <div class="grid" id="grid"></div>
            <div class="blocker" id="inputBlocker"></div>
        </div>

        <div class="footer-controls">
            <button class="btn btn-stop" onclick="stopGame()">åœæ­¢</button>
            <button class="btn btn-start" id="startBtn" onclick="bootSequence()">é–‹å§‹è¨“ç·´</button>
            <button class="btn btn-share" id="shareBtn" onclick="openShareModal()">åˆ†äº«æˆç¸¾</button>
        </div>

        <div class="credits-footer">
            <span>è£½ä½œè€…ï¼šè¦ä»è—¥å¸«</span> | <span>æ›´æ–°æ—¥æœŸï¼š2026/01/23</span>
        </div>
    </div>

    <!-- èªªæ˜å½ˆçª— -->
    <div class="modal-overlay" id="modal-info">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨“ç·´æ¨¡å¼èªªæ˜</div>
                <button class="modal-close-icon" onclick="closeModal('info')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feature-item">
                    <div class="feature-head">ğŸ¯ é †åºè¨˜æ†¶ (Forward)</div>
                    <div class="feature-desc">åŸºç¤è¦–è¦ºå°ˆæ³¨åŠ›è¨“ç·´ã€‚æ¨¡æ“¬æ—¥å¸¸ç”Ÿæ´»è·¯å¾‘è¨˜æ†¶ï¼Œå¢å¼·å¤§è…¦å°é †åºæ€§è³‡è¨Šçš„æ¥æ”¶å»£åº¦ã€‚</div>
                </div>
                <div class="feature-item">
                    <div class="feature-head">ğŸ§  é€†å‘è¨˜æ†¶ (Reverse)</div>
                    <div class="feature-desc">é«˜éšå·¥ä½œè¨˜æ†¶è¨“ç·´ã€‚éœ€å°‡è¦–è¦ºè³‡è¨Šåœ¨å¤§è…¦ä¸­æš«å­˜ä¸¦ã€Œåè½‰ã€è¼¸å‡ºï¼Œæœ‰æ•ˆæ´»åŒ–å‰é¡è‘‰åŸ·è¡ŒåŠŸèƒ½ã€‚</div>
                </div>
                <div class="feature-item">
                    <div class="feature-head">ğŸ’  åœ–å½¢è¨˜æ†¶ (Pattern) <span class="tag-new">NEW</span></div>
                    <div class="feature-desc">è¦–è¦ºç©ºé–“å»£åº¦è¨“ç·´ã€‚å¤šå€‹ç‡ˆè™Ÿã€ŒåŒæ™‚ã€äº®èµ·ç¬é–“æ¶ˆå¤±ï¼Œè¨“ç·´å¤§è…¦çš„ç¬é–“æ”å–èˆ‡ç©ºé–“å®šä½èƒ½åŠ›ã€‚</div>
                </div>
                <div class="feature-item">
                    <div class="feature-head">âš¡ åæ‡‰è¨“ç·´ (Speed) <span class="tag-new">HARD</span></div>
                    <div class="feature-desc">æ¥µé€Ÿç”Ÿå­˜æ¨¡å¼ï¼ç‡ˆè™Ÿäº®èµ·å¾Œå¿…é ˆåœ¨æ¥µçŸ­æ™‚é–“å…§æŒ‰ä¸‹ï¼Œè¶…æ™‚å³å¤±æ•—ã€‚è¨“ç·´ç¥ç¶“åå°„é€Ÿåº¦ã€‚</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«æˆç¸¾å½ˆçª— -->
    <div class="modal-overlay" id="modal-share">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æˆç¸¾è¨ºæ–·å¡</div>
                <button class="modal-close-icon" onclick="closeModal('share')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-card" id="shareCardContent">
                    <div class="share-label" id="shareModeLabel">FORWARD SPAN</div>
                    <div class="share-grade" id="shareScoreVal">LV.10</div>
                    <div class="share-label" id="shareResultLabel">COMPLETED</div>
                    
                    <div class="share-details">
                        <div class="share-detail-item">
                            <div class="share-detail-key">DIFFICULTY</div>
                            <div class="share-detail-val" id="shareDiffVal">PRO</div>
                        </div>
                        <div class="share-detail-item">
                            <div class="share-detail-key">RATING</div>
                            <div class="share-detail-val" id="shareRatingVal">EXCELLENT</div>
                        </div>
                    </div>
                    <div class="share-footer">Neuro-X Ultra Trainer by è¦ä»è—¥å¸«</div>
                </div>
            </div>
            <div class="modal-btn-row">
                <button class="modal-action-btn btn-close" onclick="closeModal('share')">é—œé–‰</button>
                <button class="modal-action-btn btn-copy" onclick="copyResultText()">ğŸ“‹ è¤‡è£½æˆç¸¾</button>
            </div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 25;
        const SPEEDS = {
            normal: { flash: 500, gap: 200, patternTime: 1200, reactionMax: 1200, reactionMin: 500, name: "æ™®é€š" },
            fast: { flash: 300, gap: 100, patternTime: 800, reactionMax: 900, reactionMin: 400, name: "å¿«é€Ÿ" },
            pro: { flash: 150, gap: 50, patternTime: 500, reactionMax: 700, reactionMin: 300, name: "æ¥µé™" }
        };
        const MODE_NAMES = {
            forward: "é †åºè¨˜æ†¶",
            reverse: "é€†å‘è¨˜æ†¶",
            pattern: "åœ–å½¢è¨˜æ†¶",
            reaction: "åæ‡‰è¨“ç·´"
        };
        
        // é è¨­é›£åº¦é…ç½®
        const DEFAULT_DIFFICULTIES = {
            forward: 'fast',
            reverse: 'fast',
            pattern: 'pro',
            reaction: 'fast'
        };

        let state = {
            mode: 'forward', 
            level: 1,
            startLevel: 1, 
            score: 0,
            active: false,
            gameWon: false, // æ˜¯å¦å®Œç¾é€šé—œ
            sequence: [],
            userSequence: [], 
            patternTarget: new Set(),
            highScores: { forward: 0, reverse: 0, pattern: 0, reaction: 0 },
            muted: false
        };

        let currentReactionTarget = -1;
        let timers = { reaction: null, flash: null, reactionTimeout: null };
        let lastInputTime = 0; 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        const els = {
            grid: document.getElementById('grid'),
            status: document.getElementById('statusText'),
            score: document.getElementById('currentScoreDisplay'),
            best: document.getElementById('bestScoreDisplay'),
            label: document.getElementById('scoreLabel'),
            startBtn: document.getElementById('startBtn'),
            shareBtn: document.getElementById('shareBtn'),
            blocker: document.getElementById('inputBlocker'),
            diff: document.getElementById('difficultySelect'),
            startLvl: document.getElementById('startLevelSelect'),
            muteIcon: document.getElementById('muteIcon')
        };

        // --- Audio ---
        function playTone(type) {
            if (state.muted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'flash') {
                osc.frequency.setValueAtTime(440, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'pattern') {
                osc.frequency.setValueAtTime(330, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'good') {
                osc.frequency.setValueAtTime(660, now);
                osc.type = 'triangle';
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                osc.frequency.setValueAtTime(783.99, now + 0.2);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'bad') {
                osc.frequency.setValueAtTime(120, now);
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        function toggleMute() {
            state.muted = !state.muted;
            els.muteIcon.textContent = state.muted ? "ğŸ”‡" : "ğŸ”Š";
            document.getElementById('muteBtn').classList.toggle('muted');
        }

        function fireConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            let particles = [];
            const colors = ['#3b82f6', '#06b6d4', '#10b981', '#fbbf24', '#f472b6'];
            for(let i=0; i<100; i++) {
                particles.push({
                    x: canvas.width / 2, y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 5 + 2, color: colors[Math.floor(Math.random() * colors.length)], life: 1
                });
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= 0.02;
                        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                        ctx.fillRect(p.x, p.y, p.size, p.size); active = true;
                    }
                });
                if(active) requestAnimationFrame(animate); else ctx.clearRect(0,0, canvas.width, canvas.height);
            }
            animate();
            if(!state.muted) playTone('win');
        }

        // --- Core ---
        function initGrid() {
            els.grid.innerHTML = '';
            for (let i = 0; i < GRID_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.id = i;
                const handleInteraction = (e) => {
                    if (e.cancelable && e.type === 'touchstart') e.preventDefault();
                    if (!state.active) return;
                    const now = Date.now();
                    if (now - lastInputTime < 350) return; 
                    lastInputTime = now;
                    handleInput(i, cell);
                };
                cell.addEventListener('touchstart', handleInteraction, {passive: false});
                cell.addEventListener('mousedown', handleInteraction);
                els.grid.appendChild(cell);
            }
            loadHighScores();
            els.diff.value = DEFAULT_DIFFICULTIES[state.mode];
        }

        function loadHighScores() {
            const saved = localStorage.getItem('neuro_trainer_scores_ultra_v2');
            if (saved) state.highScores = JSON.parse(saved);
            updateScoreUI();
        }

        function saveHighScores() {
            localStorage.setItem('neuro_trainer_scores_ultra_v2', JSON.stringify(state.highScores));
            updateScoreUI();
        }

        async function bootSequence() {
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            stopGame();
            els.startBtn.disabled = true;
            els.status.textContent = "SYSTEM DIAGNOSTIC...";
            els.status.style.color = 'var(--accent)';
            const cells = Array.from(els.grid.children);
            const shuffle = [...cells].sort(() => 0.5 - Math.random()).slice(0, 8);
            for(const cell of shuffle) {
                cell.classList.add('booting'); await sleep(50); cell.classList.remove('booting');
            }
            await sleep(200);
            initGame();
        }

        // --- Game Control ---
        window.setMode = function(mode, btn) {
            if (state.active) stopGame();
            state.mode = mode;
            els.diff.value = DEFAULT_DIFFICULTIES[mode];
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (mode === 'reaction') {
                els.label.textContent = "Score";
                els.startLvl.disabled = true; els.startLvl.style.opacity = '0.3';
            } else {
                els.label.textContent = "Level";
                els.startLvl.disabled = false; els.startLvl.style.opacity = '1';
            }
            updateScoreUI(true);
        };

        window.stopGame = function() {
            state.active = false;
            currentReactionTarget = -1;
            els.startBtn.disabled = false;
            els.startBtn.textContent = "é–‹å§‹è¨“ç·´";
            els.startBtn.style.display = 'inline-block';
            els.shareBtn.style.display = 'none';
            els.status.textContent = "ç³»çµ±å¾…æ©Ÿä¸­";
            els.status.style.color = 'var(--text-muted)';
            clearTimeout(timers.reaction); clearTimeout(timers.reactionTimeout); clearTimeout(timers.flash);
            els.blocker.style.display = 'none';
            Array.from(els.grid.children).forEach(c => c.className = 'cell');
        };

        window.initGame = function() {
            state.active = true;
            state.gameWon = false; // Reset game won state
            els.startBtn.disabled = true;
            els.startBtn.textContent = "è¨“ç·´ä¸­...";
            els.shareBtn.style.display = 'none';
            
            const diff = els.diff.value;
            const startLvl = parseInt(els.startLvl.value);
            state.startLevel = startLvl; // è¨˜éŒ„èµ·å§‹ç­‰ç´š

            if (state.mode === 'reaction') {
                state.score = 0;
                startReactionRound(diff);
            } else {
                state.level = startLvl;
                state.score = state.level;
                if(state.mode === 'pattern') startPatternRound(diff);
                else startMemoryRound(diff);
            }
            updateScoreUI();
        };

        async function startMemoryRound(difficulty) {
            updateScoreUI();
            state.userSequence = [];
            state.sequence = [];
            for (let i = 0; i < state.level; i++) state.sequence.push(Math.floor(Math.random() * GRID_SIZE));
            els.blocker.style.display = 'block';
            els.status.textContent = `Level ${state.level} - è§€å¯Ÿç‡ˆè™Ÿ`;
            els.status.style.color = '#38bdf8';
            const speed = SPEEDS[difficulty];
            await sleep(500);
            for (let i = 0; i < state.sequence.length; i++) {
                if (!state.active) return;
                const cell = els.grid.children[state.sequence[i]];
                cell.classList.add('active'); playTone('flash');
                await sleep(speed.flash);
                cell.classList.remove('active'); await sleep(speed.gap);
            }
            if (!state.active) return;
            els.blocker.style.display = 'none';
            els.status.textContent = state.mode === 'reverse' ? "è«‹å€’åºè¼¸å…¥" : "è«‹ä¾åºè¼¸å…¥";
            els.status.style.color = 'white';
        }

        async function startPatternRound(difficulty) {
            updateScoreUI();
            state.patternTarget.clear();
            const count = state.level + 2; 
            const pool = Array.from({length: GRID_SIZE}, (_, i) => i);
            for(let i=0; i<count; i++) {
                const idx = Math.floor(Math.random() * pool.length);
                state.patternTarget.add(pool[idx]); pool.splice(idx, 1);
            }
            els.blocker.style.display = 'block';
            els.status.textContent = `Level ${state.level} - ç¬é–“è¨˜æ†¶`;
            els.status.style.color = 'var(--purple)';
            const speed = SPEEDS[difficulty];
            await sleep(500);
            state.patternTarget.forEach(idx => { els.grid.children[idx].classList.add('active-pattern'); });
            playTone('pattern');
            await sleep(speed.patternTime);
            Array.from(els.grid.children).forEach(c => c.classList.remove('active-pattern'));
            if (!state.active) return;
            els.blocker.style.display = 'none';
            els.status.textContent = "æŒ‡å‡ºæ‰€æœ‰ä½ç½®";
            els.status.style.color = 'white';
        }

        function startReactionRound(difficulty) {
            if (!state.active) return;
            els.status.textContent = "ç‡ˆäº®å³æŒ‰ï¼(é™æ™‚)";
            els.status.style.color = '#facc15';
            const delay = Math.random() * 1000 + 500; 
            timers.reaction = setTimeout(() => {
                if (!state.active) return;
                if (currentReactionTarget !== -1) els.grid.children[currentReactionTarget].classList.remove('active');
                currentReactionTarget = Math.floor(Math.random() * GRID_SIZE);
                els.grid.children[currentReactionTarget].classList.add('active');
                playTone('flash');
                const speed = SPEEDS[difficulty];
                const reduction = state.score * 20;
                const timeLimit = Math.max(speed.reactionMin, speed.reactionMax - reduction);
                timers.reactionTimeout = setTimeout(() => {
                   if(state.active && currentReactionTarget !== -1) handleFail(els.grid.children[currentReactionTarget]);
                }, timeLimit);
            }, delay);
        }

        function handleInput(index, cell) {
            if (state.mode === 'reaction') {
                if (currentReactionTarget === -1) return;
                if (index === currentReactionTarget) {
                    clearTimeout(timers.reactionTimeout);
                    playTone('good'); cell.classList.remove('active'); flashCell(cell, 'correct');
                    state.score++;
                    updateScoreUI();
                    if (state.score > state.highScores.reaction) {
                        state.highScores.reaction = state.score; saveHighScores(); fireConfetti();
                    }
                    currentReactionTarget = -1;
                    startReactionRound(els.diff.value);
                } else {
                    clearTimeout(timers.reactionTimeout);
                    handleFail(cell);
                }
                return;
            }

            if (state.mode === 'pattern') {
                if (state.patternTarget.has(index)) {
                    if (!cell.classList.contains('correct')) { 
                        playTone('good'); cell.classList.add('correct');
                        state.patternTarget.delete(index);
                        if (state.patternTarget.size === 0) handleLevelComplete();
                    }
                } else if (cell.classList.contains('correct')) {
                    return; 
                } else {
                    handleFail(cell);
                }
                return;
            }

            if (state.userSequence.length >= state.sequence.length) return;
            let expected;
            if (state.mode === 'forward') expected = state.sequence[state.userSequence.length];
            else expected = state.sequence[state.sequence.length - 1 - state.userSequence.length];

            if (index === expected) {
                playTone('good'); flashCell(cell, 'correct');
                state.userSequence.push(index);
                if (state.userSequence.length === state.sequence.length) handleLevelComplete();
            } else {
                handleFail(cell);
            }
        }

        function handleLevelComplete() {
            // åœ–å½¢è¨˜æ†¶æ¥µé™æª¢æŸ¥ï¼šLv.23 = 25æ ¼å…¨äº®
            if (state.mode === 'pattern' && state.level >= 23) {
                gameClearSequence();
                return;
            }

            els.status.textContent = "æ­£ç¢ºï¼";
            els.status.style.color = 'var(--success)';
            els.blocker.style.display = 'block';
            if (state.level > state.highScores[state.mode]) {
                state.highScores[state.mode] = state.level;
                saveHighScores(); fireConfetti();
            } else {
                playTone('win');
            }
            timers.flash = setTimeout(() => {
                state.level++; state.score = state.level;
                Array.from(els.grid.children).forEach(c => c.className = 'cell');
                const diff = els.diff.value;
                if(state.mode === 'pattern') startPatternRound(diff);
                else startMemoryRound(diff);
            }, 800);
        }

        // --- å®Œç¾é€šé—œé‚è¼¯ ---
        function gameClearSequence() {
            state.gameWon = true;
            els.status.textContent = "å®Œç¾é€šé—œï¼(MAX)"; 
            els.status.style.color = 'var(--purple)';
            els.blocker.style.display = 'block';
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (state.level > state.highScores[state.mode]) {
                state.highScores[state.mode] = state.level;
                saveHighScores();
            }
            
            playTone('win');
            fireConfetti();
            
            // å»¶é²å¾Œé¡¯ç¤ºçµç®—
            setTimeout(() => {
                state.active = false;
                els.startBtn.disabled = false;
                els.startBtn.textContent = "å†æ¬¡æŒ‘æˆ°";
                els.startBtn.style.display = 'inline-block';
                els.shareBtn.style.display = 'inline-block';
                openShareModal(); // è‡ªå‹•é–‹å•Ÿåˆ†äº«å¡æ…¶ç¥
            }, 2500);
        }

        function handleFail(cell) {
            playTone('bad'); flashCell(cell, 'wrong');
            els.status.textContent = "ä»»å‹™å¤±æ•—";
            els.status.style.color = 'var(--danger)';
            state.active = false;
            clearTimeout(timers.flash); 
            els.blocker.style.display = 'block';
            els.startBtn.disabled = false;
            els.startBtn.textContent = "é‡æ–°æŒ‘æˆ°";
            els.startBtn.style.display = 'inline-block';
            els.shareBtn.style.display = 'inline-block';
        }

        function flashCell(cell, type) {
            cell.classList.add(type); setTimeout(() => cell.classList.remove(type), 200);
        }

        function updateScoreUI(reset = false) {
            if (reset) {
                const isReaction = state.mode === 'reaction';
                els.score.textContent = isReaction ? 0 : (els.startLvl.disabled ? 1 : els.startLvl.value);
            } else {
                els.score.textContent = state.score;
            }
            els.best.textContent = state.highScores[state.mode] || 0;
        }

        const sleep = ms => new Promise(r => timers.flash = setTimeout(r, ms));

        window.openModal = id => document.getElementById(`modal-${id}`).style.display = 'flex';
        window.closeModal = id => document.getElementById(`modal-${id}`).style.display = 'none';

        window.openShareModal = function() {
            const modeName = MODE_NAMES[state.mode];
            const diffName = SPEEDS[els.diff.value].name;
            
            // è¨ˆç®—ã€Œæœ‰æ•ˆæˆç¸¾ã€
            // é è¨­ç‚ºç•¶å‰åˆ†æ•¸
            let displayScore = state.score;
            
            if (state.mode !== 'reaction') {
                // è¨˜æ†¶/åœ–å½¢æ¨¡å¼
                if (!state.active) {
                    if (state.gameWon) {
                        displayScore = state.level; // å®Œç¾é€šé—œé¡¯ç¤ºæ»¿åˆ†
                    } else if (state.level === state.startLevel && state.startLevel > 1) {
                        displayScore = 0; // è·³ç´šå¤±æ•—
                    } else {
                        // å¦å‰‡æˆç¸¾ç‚ºã€Œä¸Šä¸€é—œã€(å·²å®Œæˆçš„ç­‰ç´š)
                        displayScore = Math.max(0, state.level - 1);
                    }
                }
            }

            document.getElementById('shareModeLabel').textContent = modeName;
            document.getElementById('shareScoreVal').textContent = (state.mode === 'reaction' ? displayScore : `LV.${displayScore}`);
            document.getElementById('shareDiffVal').textContent = diffName;
            
            // çµæœæ¨™ç±¤
            let resultLabel = "COMPLETED";
            if (state.gameWon) resultLabel = "MISSION ACCOMPLISHED";
            else if (state.mode !== 'reaction' && displayScore === 0 && state.startLevel > 1) resultLabel = "ATTEMPT FAILED";
            document.getElementById('shareResultLabel').textContent = resultLabel;

            // è©•ç´šé‚è¼¯
            let rating = "GOOD";
            const s = displayScore;
            if (state.mode === 'reaction') {
                if (s > 25) rating = "LEGENDARY";
                else if (s > 20) rating = "S-TIER";
                else if (s > 15) rating = "ELITE";
                else if (s > 10) rating = "ADVANCED";
            } else {
                if (state.gameWon || s >= 23) rating = "MAXIMUM"; // åœ–å½¢è¨˜æ†¶æ¥µé™
                else if (s >= 12) rating = "LEGENDARY";
                else if (s >= 9) rating = "ELITE";
                else if (s >= 6) rating = "ADVANCED";
                else if (s === 0) rating = "TRY AGAIN";
            }
            
            document.getElementById('shareRatingVal').textContent = rating;
            openModal('share');
        };

        window.copyResultText = function() {
            const modeName = MODE_NAMES[state.mode];
            const diffName = SPEEDS[els.diff.value].name;
            
            // è¤‡è£½æ™‚åŒæ¨£ä½¿ç”¨æœ‰æ•ˆæˆç¸¾é‚è¼¯
            let finalScore = state.score;
            if (state.mode !== 'reaction' && !state.active) {
                if (state.gameWon) finalScore = state.level;
                else if (state.level === state.startLevel && state.startLevel > 1) finalScore = 0;
                else finalScore = Math.max(0, state.level - 1);
            }
            
            const scoreText = state.mode === 'reaction' ? finalScore + "åˆ†" : "Lv." + finalScore + (state.gameWon ? " (MAX)" : "");
            const text = `ğŸ§  Neuro-X Ultra èªçŸ¥è¨“ç·´\n----------------\næ¨¡å¼ï¼š${modeName}\né›£åº¦ï¼š${diffName}\næˆç¸¾ï¼š${scoreText}\n----------------\nå¿«ä¾†æŒ‘æˆ°ï¼ #NeuroXUltra #è¦ä»è—¥å¸«`;
            
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            
            try {
                document.execCommand('copy');
                const btn = document.querySelector('.btn-copy');
                const org = btn.innerHTML;
                btn.innerHTML = "âœ… å·²è¤‡è£½";
                setTimeout(() => btn.innerHTML = org, 2000);
            } catch (err) {
                const btn = document.querySelector('.btn-copy');
                btn.innerHTML = "âŒ è¤‡è£½å¤±æ•—";
                setTimeout(() => btn.innerHTML = "ğŸ“‹ è¤‡è£½æˆç¸¾", 2000);
            }
            document.body.removeChild(textArea);
        };

        initGrid();
    </script>
</body>
</html>