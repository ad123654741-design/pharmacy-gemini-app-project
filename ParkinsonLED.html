<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帕金森氏症藥物LED計算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            overflow-y: auto;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem;
            width: 100%;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-lg {
            max-width: 900px;
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">帕金森氏症藥物LED計算工具</h1>
            <p class="text-sm text-gray-500 mt-1">製作者 : 蝦仁藥師 2025年9月</p>
            <p class="text-gray-500">此工具用於計算常用帕金森氏症藥物的 Levodopa Equivalent Dose (LED)。</p>
            <div id="user-info" class="text-xs text-gray-400 mt-2 break-all">使用者 ID: 載入中...</div>
        </header>
        
        <!-- 請先讀我區塊 -->
        <div class="card">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">請先讀我</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="open-info-modal-btn-1" class="bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm font-semibold py-2 px-4 rounded-full transition-colors duration-200 ease-in-out">
                    使用說明
                </button>
                <button id="open-info-modal-btn-2" class="bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm font-semibold py-2 px-4 rounded-full transition-colors duration-200 ease-in-out">
                    藥物比較
                </button>
                <button id="open-info-modal-btn-3" class="bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm font-semibold py-2 px-4 rounded-full transition-colors duration-200 ease-in-out">
                    臨床建議
                </button>
                <button id="open-info-modal-btn-4" class="bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm font-semibold py-2 px-4 rounded-full transition-colors duration-200 ease-in-out">
                    相關名詞
                </button>
            </div>
        </div>

        <!-- 單一藥物LED等效轉換區塊 -->
        <div class="card">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">單一藥物LED等效轉換</h2>
            <p class="text-gray-500 mb-4">選擇一個藥物並輸入其單次劑量，即可查看其等效於其他藥物的劑量。</p>
            <div class="grid md:grid-cols-4 gap-4 items-end mb-4">
                <div>
                    <label for="single-drug-select" class="block text-sm font-medium text-gray-700 mb-1">選擇藥物</label>
                    <select id="single-drug-select" class="mt-1 block w-full rounded-md shadow-sm"></select>
                </div>
                <div>
                    <label for="single-dosage-input" class="block text-sm font-medium text-gray-700 mb-1">單次劑量 (mg)</label>
                    <input type="number" id="single-dosage-input" class="mt-1 block w-full rounded-md shadow-sm" placeholder="例如: 100">
                </div>
                <div class="flex justify-end md:justify-start">
                    <button id="calculate-single-led-btn" class="btn btn-primary w-full md:w-auto">執行換算</button>
                    <button id="clear-single-led-btn" class="btn btn-secondary w-full md:w-auto ml-2">清除</button>
                </div>
            </div>
            <div id="single-led-results" class="mt-8 space-y-4">
                <!-- 換算結果將在此顯示 -->
            </div>
        </div>

        <!-- 藥物輸入與 LED 換算區塊 -->
        <div class="card">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">計算 LED 總劑量</h2>
            <div class="grid md:grid-cols-4 gap-4 items-end mb-4">
                <div>
                    <label for="drug-select" class="block text-sm font-medium text-gray-700 mb-1">藥物名稱</label>
                    <select id="drug-select" class="mt-1 block w-full rounded-md shadow-sm"></select>
                </div>
                <div>
                    <label for="dosage-input" class="block text-sm font-medium text-gray-700 mb-1">單次劑量 (mg)</label>
                    <input type="number" id="dosage-input" class="mt-1 block w-full rounded-md shadow-sm" placeholder="例如: 100">
                </div>
                <div>
                    <label for="frequency-input" class="block text-sm font-medium text-gray-700 mb-1">給藥頻次 (次/天)</label>
                    <input type="number" id="frequency-input" class="mt-1 block w-full rounded-md shadow-sm" placeholder="例如: 3">
                </div>
                <div class="flex justify-end md:justify-start">
                    <button id="add-drug-btn" class="btn btn-primary w-full">新增藥物</button>
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button id="clear-input-btn" class="btn btn-secondary text-sm">清空欄位</button>
            </div>
            <div id="error-message" class="text-red-500 text-sm mt-2 hidden">請輸入有效的藥物名稱、劑量和頻次。</div>

            <div id="led-list" class="mt-8 space-y-4">
                <!-- 換算後的藥物列表將在此顯示 -->
            </div>

            <div id="total-led" class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-md">
                <span class="font-bold">每日總 LED 劑量:</span> <span id="total-led-value" class="text-2xl font-extrabold ml-2">0</span> mg
            </div>

            <div class="mt-6 flex justify-end space-x-2">
                <button id="copy-btn" class="btn btn-secondary">複製結果</button>
                <button id="open-db-modal-btn" class="btn btn-secondary">管理藥物資料庫</button>
            </div>
        </div>

        <!-- 資料來源區塊 -->
        <div class="card">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">資料來源</h2>
            <div class="text-xs text-gray-600 space-y-2">
                <p>1. Levodopa Equivalent Dose of Safinamide: A Multicenter, Longitudinal, Case–Control Study<br>Mancini F.;Braccia A.;Lazzeri G.;Pinto P.;Eleopra R. <br>2023.</p>
                <p>2. Levodopa Dose Equivalency in Parkinson's Disease: Updated Systematic Review and Proposals.<br>Jost ST, Kaldenbach MA, Antonini A, et al.<br>Movement Disorders : Official Journal of the Movement Disorder Society. 2023;38(7):1236-1252. doi:10.1002/mds.29410.</p>
                <p>3. Comparing the Efficacy and Safety of Safinamide With Rasagiline in China Parkinson's Disease Patients With a Matching Adjusted Indirect Comparison.<br>Tan Y, Wei Q, Xu P, et al.<br>Scientific Reports. 2025;15(1):10502. doi:10.1038/s41598-025-94960-9.</p>
                <p>4. Novel Levodopa Formulations for Parkinson's Disease.<br>Freitas ME, Ruiz-Lopez M, Fox SH.<br>CNS Drugs. 2016;30(11):1079-1095. doi:10.1007/s40263-016-0386-8.</p>
            </div>
        </div>

    </div>

    <!-- 藥物資料庫管理 Modal -->
    <div id="db-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-700">管理藥物資料庫</h3>
                <button id="close-db-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            
            <div class="mb-6">
                <h4 id="form-title" class="text-xl font-bold mb-2">新增藥物</h4>
                <div class="grid sm:grid-cols-2 gap-4">
                    <input type="hidden" id="edit-drug-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">藥品名稱</label>
                        <input type="text" id="db-drug-name" placeholder="例如: Levodopa IR" class="rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">商品名</label>
                        <input type="text" id="db-brand-name" placeholder="例如: Sinemet" class="rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">劑型</label>
                        <input type="text" id="db-formulation" placeholder="例如: 錠劑" class="rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LED 換算因子</label>
                        <input type="number" step="0.01" id="db-led-factor" placeholder="例如: 1" class="rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">建議劑量範例</label>
                        <input type="text" id="db-dosage-example" placeholder="例如: 100mg TID" class="rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">本院品項劑量 (mg, 以逗號分隔)</label>
                        <input type="text" id="db-available-dosages" placeholder="例如: 50, 100, 250" class="rounded-md shadow-sm">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">臨床說明 (選填)</label>
                        <textarea id="db-clinical-notes" rows="3" placeholder="例如: 適應症、UPDRS改善效果等" class="rounded-md shadow-sm"></textarea>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="save-drug-btn" class="btn btn-primary">儲存</button>
                    <button id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">取消</button>
                </div>
            </div>
            
            <div>
                <h4 class="text-xl font-bold mb-2">目前資料庫藥物</h4>
                <div class="relative overflow-x-auto rounded-lg">
                    <table class="w-full text-sm text-left text-gray-500 rounded-lg">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">藥品名稱</th>
                                <th scope="col" class="px-6 py-3">LED 因子</th>
                                <th scope="col" class="px-6 py-3">可用劑量</th>
                                <th scope="col" class="px-6 py-3">操作</th>
                            </tr>
                        </thead>
                        <tbody id="modal-db-table-body">
                            <!-- 藥物資料庫列表將在此顯示 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 訊息提示視窗 -->
    <div id="message-modal" class="modal">
        <div class="modal-content text-center">
            <p id="message-text" class="text-lg text-gray-700 mb-4"></p>
            <button id="close-message-btn" class="btn btn-primary">確定</button>
        </div>
    </div>
    
    <!-- 刪除確認視窗 -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content text-center">
            <p id="confirmation-text" class="text-lg text-gray-700 mb-4">確定要刪除此藥物嗎？</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="btn btn-danger">確定</button>
                <button id="confirm-no" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- 臨床建議 Modal -->
    <div id="advice-modal" class="modal">
        <div class="modal-content modal-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="advice-modal-title" class="text-2xl font-bold text-gray-700"></h3>
                <button id="close-advice-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div id="advice-modal-content" class="text-gray-600 space-y-4">
                <!-- 內容將由 JavaScript 動態生成 -->
            </div>
        </div>
    </div>

    <script type="module">
        // 設定 Firebase 日誌等級以進行偵錯
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        setLogLevel('debug');
        
        // Firebase 服務的模組匯入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 內建藥物資料庫
        const initialDrugDatabase = [
            { id: 'levodopa_ir', name: 'Levodopa IR', brand: 'Sinemet', formulation: '錠劑', factor: 1, example: '100mg TID', availableDosages: [100, 250, 500] },
            { id: 'levodopa_cr', name: 'Levodopa CR', brand: 'Sinemet CR', formulation: '控釋錠', factor: 0.75, example: '200mg BID', availableDosages: [200, 500] },
            { id: 'entacapone', name: 'Entacapone (需與L-dopa併用)', brand: 'Comtan', formulation: '錠劑', factor: 0.33, example: '200mg/dose (與Levodopa併用)', availableDosages: [200] },
            { id: 'pramipexole', name: 'Pramipexole', brand: 'Mirapex', formulation: '錠劑', factor: 100, example: '1mg/day', availableDosages: [0.125, 0.25, 1, 1.5] },
            { id: 'ropinirole', name: 'Ropinirole', brand: 'Requip', formulation: '錠劑', factor: 20, example: '4mg/day', availableDosages: [0.25, 0.5, 1, 2, 4] },
            { id: 'amantadine', name: 'Amantadine', brand: 'Symmetrel', formulation: '錠劑', factor: 1, example: '100mg BID', availableDosages: [100] },
            { id: 'bromocriptine', name: 'Bromocriptine', brand: 'Parlodel', formulation: '錠劑', factor: 10, example: '10mg/day', availableDosages: [2.5] },
            { id: 'rasagiline', name: 'Rasagiline', brand: 'Azilect', formulation: '錠劑', factor: 100, example: '1mg/day', availableDosages: [0.5, 1] },
            { id: 'levodopa_er', name: 'Levodopa ER', brand: 'Rytary, Duopa', formulation: '緩釋膠囊', factor: 0.75, example: '100mg TID', availableDosages: [23.75, 48.75, 95] },
            { id: 'selegiline', name: 'Selegiline', brand: 'Eldepryl', formulation: '錠劑', factor: 10, example: '10mg/day', availableDosages: [5] },
            { id: 'safinamide_50', name: 'Safinamide (50mg)', brand: 'Xadago', formulation: '錠劑', factor: 2, example: '50mg/day', availableDosages: [50] },
            { id: 'safinamide_100', name: 'Safinamide (100mg)', brand: 'Xadago', formulation: '錠劑', factor: 1.25, example: '100mg/day', availableDosages: [100] },
            { id: 'rotigotine_patch', name: 'Rotigotine patch', brand: 'Neupro', formulation: '貼片', factor: 30, example: '4mg/day', availableDosages: [2, 4, 6, 8] },
            { id: 'apomorphine', name: 'Apomorphine', brand: 'Apokyn', formulation: '注射劑', factor: 10, example: '1mg/dose', availableDosages: [1, 5, 10] },
        ];
        
        let firebaseConfig, appId, auth, db, userId;
        let ledEntries = [];
        let drugDatabase = {};
        
        const userInfoEl = document.getElementById('user-info');
        const drugSelectEl = document.getElementById('drug-select');
        const dosageInputEl = document.getElementById('dosage-input');
        const frequencyInputEl = document.getElementById('frequency-input');
        const addDrugBtn = document.getElementById('add-drug-btn');
        const clearInputBtn = document.getElementById('clear-input-btn');
        const errorMsgEl = document.getElementById('error-message');
        const ledListEl = document.getElementById('led-list');
        const totalLedValueEl = document.getElementById('total-led-value');
        const copyBtn = document.getElementById('copy-btn');
        const dbModal = document.getElementById('db-modal');
        const openDbModalBtn = document.getElementById('open-db-modal-btn');
        const closeDbModalBtn = document.getElementById('close-db-modal-btn');
        const saveDrugBtn = document.getElementById('save-drug-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const dbDrugNameEl = document.getElementById('db-drug-name');
        const dbBrandNameEl = document.getElementById('db-brand-name');
        const dbFormulationEl = document.getElementById('db-formulation');
        const dbLedFactorEl = document.getElementById('db-led-factor');
        const dbDosageExampleEl = document.getElementById('db-dosage-example');
        const dbAvailableDosagesEl = document.getElementById('db-available-dosages');
        const dbClinicalNotesEl = document.getElementById('db-clinical-notes');
        const modalDbTableBodyEl = document.getElementById('modal-db-table-body');
        const editDrugIdEl = document.getElementById('edit-drug-id');
        const formTitleEl = document.getElementById('form-title');
        const messageModal = document.getElementById('message-modal');
        const messageTextEl = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        
        // 單一藥物等效轉換功能所需的元素
        const singleDrugSelectEl = document.getElementById('single-drug-select');
        const singleDosageInputEl = document.getElementById('single-dosage-input');
        const calculateSingleLedBtn = document.getElementById('calculate-single-led-btn');
        const clearSingleLedBtn = document.getElementById('clear-single-led-btn');
        const singleLedResultsEl = document.getElementById('single-led-results');
        
        // 請先讀我區塊按鈕
        const openInfoModalBtn1 = document.getElementById('open-info-modal-btn-1');
        const openInfoModalBtn2 = document.getElementById('open-info-modal-btn-2');
        const openInfoModalBtn3 = document.getElementById('open-info-modal-btn-3');
        const openInfoModalBtn4 = document.getElementById('open-info-modal-btn-4');

        // 臨床建議 Modal
        const adviceModal = document.getElementById('advice-modal');
        const closeAdviceModalBtn = document.getElementById('close-advice-modal-btn');
        const adviceModalTitleEl = document.getElementById('advice-modal-title');
        const adviceModalContentEl = document.getElementById('advice-modal-content');

        // 彈出視窗內容
        const modalContents = {
            '使用說明': `<h4 class="text-xl font-bold text-gray-700 mb-2">使用說明</h4>
                <div class="text-gray-600 space-y-4">
                    <p><strong>1. 單一藥物LED等效轉換：</strong><br>
                    此功能用於查詢特定藥物的單次劑量相當於其他藥物的劑量。<br>
                    - 選擇藥物並輸入單次劑量（mg）。<br>
                    - 點擊「執行換算」即可查看等效結果。<br>
                    <span class="text-sm text-red-500">* 注意：Entacapone 因需與 Levodopa 併用才具意義，故不在此清單中。Safinamide 呈現非線性動力學，結果以文字說明。</span></p>
                    
                    <p><strong>2. 計算 LED 總劑量：</strong><br>
                    此功能用於計算病患每日所有帕金森氏症藥物的總 LED。<br>
                    - 依序選擇藥物、輸入單次劑量及每日頻次，點擊「新增藥物」。<br>
                    - 系統會自動加總並顯示於下方。<br>
                    <span class="text-sm text-red-500">* 特殊規則：若清單中包含 Entacapone，系統會自動偵測併用的 Levodopa 總量進行計算 (0.33 x 併用 Levodopa LED)。若無併用 Levodopa，Entacapone 的 LED 為 0。</span></p>
                    
                    <p><strong>3. 管理藥物資料庫：</strong><br>
                    - 您可以點擊「管理藥物資料庫」按鈕，新增、編輯或刪除藥物資料。<br>
                    - 點擊「編輯」時，視窗會自動捲動至頂端，方便您修改資料。</p>
                </div>`,
            '藥物比較': `<h4 class="text-xl font-bold text-gray-700 mb-2">藥物比較</h4>
                <div class="text-gray-600">
                    <p class="mb-4">以下列出常見帕金森氏症藥物的 LED 換算因子（以 Levodopa IR 為基準 1）：</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 rounded-lg border border-gray-200">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 border-b">藥物種類</th>
                                    <th class="px-4 py-2 border-b">藥物名稱</th>
                                    <th class="px-4 py-2 border-b">換算因子</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr><td class="px-4 py-2 font-medium">L-dopa</td><td>Levodopa IR</td><td class="px-4 py-2">1.0</td></tr>
                                <tr><td class="px-4 py-2 font-medium">L-dopa</td><td>Levodopa CR</td><td class="px-4 py-2">0.75</td></tr>
                                <tr><td class="px-4 py-2 font-medium">L-dopa</td><td>Levodopa ER (Rytary)</td><td class="px-4 py-2">0.75</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DA Agonist</td><td>Pramipexole</td><td class="px-4 py-2">100</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DA Agonist</td><td>Ropinirole</td><td class="px-4 py-2">20</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DA Agonist</td><td>Rotigotine</td><td class="px-4 py-2">30</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DA Agonist</td><td>Apomorphine</td><td class="px-4 py-2">10</td></tr>
                                <tr><td class="px-4 py-2 font-medium">DA Agonist</td><td>Bromocriptine</td><td class="px-4 py-2">10</td></tr>
                                <tr><td class="px-4 py-2 font-medium">MAO-B Inhibitor</td><td>Rasagiline</td><td class="px-4 py-2">100</td></tr>
                                <tr><td class="px-4 py-2 font-medium">MAO-B Inhibitor</td><td>Selegiline</td><td class="px-4 py-2">10</td></tr>
                                <tr><td class="px-4 py-2 font-medium">MAO-B Inhibitor</td><td>Safinamide</td><td class="px-4 py-2">非線性</td></tr>
                                <tr><td class="px-4 py-2 font-medium">COMT Inhibitor</td><td>Entacapone</td><td class="px-4 py-2">0.33 (需併用L-dopa)</td></tr>
                                <tr><td class="px-4 py-2 font-medium">NMDA Antagonist</td><td>Amantadine</td><td class="px-4 py-2">1.0</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`,
            '臨床建議': `<h4 class="text-xl font-bold text-gray-700 mb-2">臨床建議</h4>
                <div class="text-gray-600 space-y-3">
                    <p><strong>1. LED 的臨床意義：</strong><br>
                    LED 總量可反映病患目前的藥物治療強度。一般而言，早期帕金森氏症病患的每日 LED 約在 300-600 mg，晚期則可能超過 1000 mg。</p>
                    
                    <p><strong>2. 異動症 (Dyskinesia) 風險：</strong><br>
                    較高的 LED 總量通常與異動症風險增加有關。若病患出現異動症，可考慮減少 L-dopa 劑量或調整其他藥物（如 DA agonists 或 Amantadine）。</p>
                    
                    <p><strong>3. 藥效波動 (Wearing-off)：</strong><br>
                    若病患出現藥效波動，可考慮增加給藥頻次、使用長效型藥物 (如 Levodopa ER, Rotigotine, DA agonists) 或加入 COMT/MAO-B 抑制劑。Safinamide 50mg/100mg 可作為輔助治療，但需注意其非線性 LED 換算特性。</p>
                    
                    <p><strong>4. 藥物轉換原則：</strong><br>
                    當需要轉換藥物時（例如從 Ropinirole 換成 Pramipexole），可利用 LED 進行等效劑量估算，以減少因劑量落差導致的病情波動或副作用。</p>
                </div>`,
            '相關名詞': `<h4 class="text-xl font-bold text-gray-700 mb-2">相關名詞解釋</h4>
                <div class="text-gray-600 space-y-3">
                    <p><strong>LED (Levodopa Equivalent Dose)：</strong><br>
                    左旋多巴等效劑量。將不同機轉、不同強度的帕金森氏症藥物，換算成標準化的左旋多巴劑量，以便於臨床比較與加總。</p>
                    
                    <p><strong>On-Off Phenomenon (開關現象)：</strong><br>
                    病患在「開」(有藥效，活動自如) 與「關」(藥效消失，僵硬、顫抖) 狀態之間出現不可預測的波動。</p>
                    
                    <p><strong>Wearing-off (藥效減退)：</strong><br>
                    藥效持續時間縮短，在下一劑藥物服用前，症狀即開始惡化。</p>
                    
                    <p><strong>Dyskinesia (異動症)：</strong><br>
                    因長期服用左旋多巴或劑量過高引起的不自主運動（如舞蹈樣動作、扭動）。通常發生在藥物濃度高峰期 (Peak-dose dyskinesia)。</p>
                    
                    <p><strong>FOG (Freezing of Gait，步態凍結)：</strong><br>
                    病患在起步或轉彎時，感覺雙腳像被黏在地板上無法移動的現象。</p>
                </div>`
        };

        // Helper function to format numbers for display
        function formatNumber(num) {
            // Format to 2 decimal places and then parse back to a float to remove trailing zeros
            return parseFloat(num.toFixed(2));
        }

        function showMessage(message) {
            messageTextEl.textContent = message;
            messageModal.style.display = 'flex';
        }

        closeMessageBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmation-text').textContent = message;
            confirmationModal.style.display = 'flex';
            
            const handleYes = () => {
                onConfirm();
                confirmationModal.style.display = 'none';
                confirmYesBtn.removeEventListener('click', handleYes);
                confirmNoBtn.removeEventListener('click', handleNo);
            };
            const handleNo = () => {
                confirmationModal.style.display = 'none';
                confirmYesBtn.removeEventListener('click', handleYes);
                confirmNoBtn.removeEventListener('click', handleNo);
            };

            confirmYesBtn.addEventListener('click', handleYes);
            confirmNoBtn.addEventListener('click', handleNo);
        }

        function setupFirebase() {
            try {
                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = __app_id;
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userInfoEl.textContent = `使用者 ID: ${userId}`;
                            
                            const userDrugsRef = collection(db, `artifacts/${appId}/users/${userId}/led_drugs`);
                            const snapshot = await getDocs(userDrugsRef);
                            if (snapshot.empty) {
                                for (const drug of initialDrugDatabase) {
                                    await setDoc(doc(userDrugsRef, drug.id), drug);
                                }
                            }
                            onSnapshot(userDrugsRef, (snapshot) => {
                                drugDatabase = {};
                                snapshot.forEach(doc => {
                                    drugDatabase[doc.id] = { ...doc.data(), id: doc.id };
                                });
                                renderDrugSelect();
                                renderSingleDrugSelect();
                                renderModalDrugDatabaseTable();
                                recalculateAllLed();
                            });
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase auth error:", error);
                                userInfoEl.textContent = "使用者 ID: 登入失敗";
                            }
                        }
                    });
                } else {
                    console.error("Firebase config or app ID is not defined.");
                    userInfoEl.textContent = "使用者 ID: 未設定";
                    initialDrugDatabase.forEach(drug => {
                        drugDatabase[drug.id] = drug;
                    });
                    renderDrugSelect();
                    renderSingleDrugSelect();
                    renderModalDrugDatabaseTable();
                }
            } catch (e) {
                console.error("Error setting up Firebase: ", e);
                userInfoEl.textContent = "使用者 ID: 初始化失敗";
            }
        }
        
        function renderDrugSelect() {
            drugSelectEl.innerHTML = '';
            for (const id in drugDatabase) {
                const drug = drugDatabase[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${drug.name} (${drug.formulation})`;
                drugSelectEl.appendChild(option);
            }
            updateDosageFields();
        }

        function renderSingleDrugSelect() {
            singleDrugSelectEl.innerHTML = '';
            for (const id in drugDatabase) {
                const drug = drugDatabase[id];
                if (id === 'entacapone') {
                    continue;
                }
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${drug.name} (${drug.formulation})`;
                singleDrugSelectEl.appendChild(option);
            }
        }
        
        function renderModalDrugDatabaseTable() {
            modalDbTableBodyEl.innerHTML = '';
            for (const id in drugDatabase) {
                const drug = drugDatabase[id];
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                const availableDosagesText = drug.availableDosages ? drug.availableDosages.join(', ') : '無';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${drug.name}</td>
                    <td class="px-6 py-4">${drug.factor}</td>
                    <td class="px-6 py-4">${availableDosagesText}</td>
                    <td class="px-6 py-4">
                        <button onclick="editDrug('${id}')" class="font-medium text-blue-600 hover:underline mr-2">編輯</button>
                        <button onclick="deleteDrug('${id}')" class="font-medium text-red-600 hover:underline">刪除</button>
                    </td>
                `;
                modalDbTableBodyEl.appendChild(tr);
            }
        }
        
        async function addOrUpdateDrug() {
            const id = editDrugIdEl.value;
            const drugName = dbDrugNameEl.value.trim();
            const brandName = dbBrandNameEl.value.trim();
            const formulation = dbFormulationEl.value.trim();
            const ledFactor = parseFloat(dbLedFactorEl.value);
            const dosageExample = dbDosageExampleEl.value.trim();
            const clinicalNotes = dbClinicalNotesEl.value.trim();
            const availableDosagesString = dbAvailableDosagesEl.value.trim();

            const availableDosages = availableDosagesString.split(',')
                .map(s => parseFloat(s.trim()))
                .filter(n => !isNaN(n) && n > 0);
            
            if (!drugName || !formulation || isNaN(ledFactor)) {
                showMessage('請輸入藥品名稱、劑型和有效的LED換算因子！');
                return;
            }
            
            const drugData = {
                name: drugName,
                brand: brandName,
                formulation: formulation,
                factor: ledFactor,
                example: dosageExample,
                availableDosages: availableDosages,
                notes: clinicalNotes
            };
            
            try {
                const userDrugsRef = collection(db, `artifacts/${appId}/users/${userId}/led_drugs`);
                if (id) {
                    await updateDoc(doc(userDrugsRef, id), drugData);
                    showMessage('藥物資料已更新！');
                } else {
                    const newDocRef = doc(userDrugsRef);
                    await setDoc(newDocRef, drugData);
                    showMessage('新藥物已儲存！');
                }
                clearDrugForm();
            } catch (e) {
                console.error("Error writing document: ", e);
                showMessage('儲存失敗，請重試。');
            }
        }
        
        async function deleteDrug(id) {
            if (!id || !db || !auth.currentUser) return;
            showConfirmation('確定要刪除此藥物嗎？', async () => {
                try {
                    const userDrugsRef = collection(db, `artifacts/${appId}/users/${userId}/led_drugs`);
                    await deleteDoc(doc(userDrugsRef, id));
                    showMessage('藥物已刪除。');
                } catch (e) {
                    console.error("Error removing document: ", e);
                    showMessage('刪除失敗，請重試。');
                }
            });
        }
        
        window.editDrug = (id) => {
            const drug = drugDatabase[id];
            if (!drug) return;
            
            formTitleEl.textContent = '編輯藥物';
            editDrugIdEl.value = id;
            dbDrugNameEl.value = drug.name;
            dbBrandNameEl.value = drug.brand || '';
            dbFormulationEl.value = drug.formulation;
            dbLedFactorEl.value = drug.factor;
            dbDosageExampleEl.value = drug.example || '';
            dbAvailableDosagesEl.value = (drug.availableDosages || []).join(', ');
            dbClinicalNotesEl.value = drug.notes || '';
            cancelEditBtn.style.display = 'inline-block';
            dbModal.style.display = 'flex';
            
            dbModal.querySelector('.modal-content').scrollTop = 0;
        };
        
        function clearDrugForm() {
            formTitleEl.textContent = '新增藥物';
            editDrugIdEl.value = '';
            dbDrugNameEl.value = '';
            dbBrandNameEl.value = '';
            dbFormulationEl.value = '';
            dbLedFactorEl.value = '';
            dbDosageExampleEl.value = '';
            dbAvailableDosagesEl.value = '';
            dbClinicalNotesEl.value = '';
            cancelEditBtn.style.display = 'none';
        }

        function clearInputFields() {
            dosageInputEl.value = '';
            frequencyInputEl.value = '';
            errorMsgEl.classList.add('hidden');
        }

        function updateDosageFields() {
            const selectedDrugId = drugSelectEl.value;
            const drug = drugDatabase[selectedDrugId];
            if (drug && drug.example) {
                const example = drug.example.toLowerCase();
                let dosage = 0;
                let frequency = 1;

                const dosageMatch = example.match(/(\d+)mg/);
                if (dosageMatch && dosageMatch[1]) {
                    dosage = parseInt(dosageMatch[1], 10);
                }

                if (example.includes('bid')) {
                    frequency = 2;
                } else if (example.includes('tid')) {
                    frequency = 3;
                } else if (example.includes('qid')) {
                    frequency = 4;
                } else if (example.includes('/day')) {
                    frequency = 1;
                } else if (example.includes('/dose')) {
                    frequency = 1;
                }
                
                dosageInputEl.value = dosage;
                frequencyInputEl.value = frequency;
            } else {
                dosageInputEl.value = '';
                frequencyInputEl.value = '';
            }
        }
        
        function addDrugEntry() {
            const selectedDrugId = drugSelectEl.value;
            const dosage = parseFloat(dosageInputEl.value);
            const frequency = parseFloat(frequencyInputEl.value);
            
            if (!selectedDrugId || isNaN(dosage) || dosage <= 0 || isNaN(frequency) || frequency <= 0) {
                errorMsgEl.classList.remove('hidden');
                return;
            }
            errorMsgEl.classList.add('hidden');
            
            const drug = drugDatabase[selectedDrugId];
            if (!drug) return;
            
            const dailyDosage = dosage * frequency;
            const led = dailyDosage * drug.factor;
            
            ledEntries.push({
                id: selectedDrugId,
                name: drug.name,
                dosage: dosage,
                frequency: frequency,
                formulation: drug.formulation,
                dailyDosage: dailyDosage,
                led: led,
                factor: drug.factor
            });
            
            recalculateAllLed();
            
            clearInputFields();
        }
        
        function removeDrugEntry(index) {
            ledEntries.splice(index, 1);
            recalculateAllLed();
        }
        
        function recalculateAllLed() {
            let totalLevodopaLed = 0;

            const entacaponeInList = ledEntries.some(entry => entry.id === 'entacapone');
            if (entacaponeInList) {
                ledEntries.forEach(entry => {
                    if (entry.name.includes('Levodopa')) {
                        totalLevodopaLed += entry.led;
                    }
                });
            }

            ledEntries.forEach(entry => {
                if (entry.id === 'entacapone') {
                    if (totalLevodopaLed > 0) {
                        entry.led = totalLevodopaLed * entry.factor;
                    } else {
                        entry.led = 0;
                    }
                }
            });

            renderLedEntries();
            calculateTotalLed();
        }

        function renderLedEntries() {
            ledListEl.innerHTML = '';
            ledEntries.forEach((entry, index) => {
                const dailyDosageFormatted = formatNumber(entry.dailyDosage);
                const ledFormatted = formatNumber(entry.led);
                const formula = (entry.id === 'entacapone') ? `併用 Levodopa 成分藥物之總LED × ${entry.factor} = ${ledFormatted} mg LED` : `(${dailyDosageFormatted} mg/天) × ${entry.factor} = ${ledFormatted} mg LED`;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-md shadow-sm';
                div.innerHTML = `
                    <div>
                        <p class="font-bold">${entry.name} ${entry.formulation}</p>
                        <p class="text-sm text-gray-600">${entry.dosage} mg × ${entry.frequency} 次/天</p>
                        <p class="text-xs text-gray-500 mt-1">LED 換算：${formula}</p>
                    </div>
                    <button onclick="removeDrugEntry(${index})" class="btn btn-danger text-xs">移除</button>
                `;
                ledListEl.appendChild(div);
            });
        }
        
        function calculateTotalLed() {
            const total = ledEntries.reduce((sum, entry) => sum + entry.led, 0);
            totalLedValueEl.textContent = formatNumber(total);
        }
        
        function copyResultsToClipboard() {
            let resultText = `每日總 LED 劑量: ${totalLedValueEl.textContent} mg\n\n`;
            resultText += "詳細換算列表:\n";
            ledEntries.forEach((entry, index) => {
                resultText += `  ${index + 1}. ${entry.name} ${entry.formulation}\n`;
                resultText += `     劑量: ${entry.dosage} mg × ${entry.frequency} 次/天\n`;
                resultText += `     每日總劑量: ${formatNumber(entry.dailyDosage)} mg\n`;
                resultText += `     LED: ${formatNumber(entry.led)} mg\n`;
            });
            
            const textarea = document.createElement('textarea');
            textarea.value = resultText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showMessage('結果已複製到剪貼簿！');
            } catch (err) {
                console.error('複製失敗: ', err);
                showMessage('複製失敗，請手動複製。');
            }
            document.body.removeChild(textarea);
        }

        function calculateSingleLedEquivalent() {
            const selectedDrugId = singleDrugSelectEl.value;
            const singleDosage = parseFloat(singleDosageInputEl.value);

            singleLedResultsEl.innerHTML = '';

            if (isNaN(singleDosage) || singleDosage <= 0) {
                showMessage('請輸入有效的單次劑量！');
                return;
            }

            const selectedDrug = drugDatabase[selectedDrugId];
            if (!selectedDrug) return;

            const baseLed = singleDosage * selectedDrug.factor;
            const baseLedFormatted = formatNumber(baseLed);

            const header = document.createElement('div');
            header.className = 'p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-md mb-4';
            header.innerHTML = `<span class="font-bold">換算基礎：</span>服用 ${singleDosage} mg 的 ${selectedDrug.name}，其 LED 為 ${baseLedFormatted} mg。`;
            singleLedResultsEl.appendChild(header);

            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4';

            for (const id in drugDatabase) {
                const drug = drugDatabase[id];
                if (id !== selectedDrugId && id !== 'entacapone') { 
                    let equivalentText;
                    if (id === 'safinamide_100') {
                        equivalentText = `<div class="p-4 bg-gray-100 rounded-md shadow-sm">
                            <p class="font-bold text-sm mb-1">${drug.name} (${drug.formulation})</p>
                            <p class="text-sm text-red-500">非線性，請人工換算。100mg = LED 125mg。</p>
                        </div>`;
                    } else if (id === 'safinamide_50') {
                        equivalentText = `<div class="p-4 bg-gray-100 rounded-md shadow-sm">
                            <p class="font-bold text-sm mb-1">${drug.name} (${drug.formulation})</p>
                            <p class="text-sm text-red-500">非線性，請人工換算。50mg = LED 100mg。</p>
                        </div>`;
                    } else {
                        const equivalentDosage = baseLed / drug.factor;
                        const equivalentDosageFormatted = formatNumber(equivalentDosage);
                        equivalentText = `<div class="p-4 bg-gray-100 rounded-md shadow-sm">
                            <p class="font-bold text-sm mb-1">${drug.name} (${drug.formulation})</p>
                            <p class="text-sm text-gray-600">等效劑量: ${equivalentDosageFormatted} mg</p>
                        </div>`;
                    }
                    gridContainer.innerHTML += equivalentText;
                }
            }
            singleLedResultsEl.appendChild(gridContainer);
        }

        function clearSingleLedFields() {
            singleDosageInputEl.value = '';
            singleLedResultsEl.innerHTML = '';
        }
        
        addDrugBtn.addEventListener('click', addDrugEntry);
        clearInputBtn.addEventListener('click', clearInputFields);
        copyBtn.addEventListener('click', copyResultsToClipboard);
        openDbModalBtn.addEventListener('click', () => {
            dbModal.style.display = 'flex';
        });
        closeDbModalBtn.addEventListener('click', () => {
            dbModal.style.display = 'none';
            clearDrugForm();
        });
        saveDrugBtn.addEventListener('click', addOrUpdateDrug);
        cancelEditBtn.addEventListener('click', () => {
            clearDrugForm();
        });
        calculateSingleLedBtn.addEventListener('click', calculateSingleLedEquivalent);
        clearSingleLedBtn.addEventListener('click', clearSingleLedFields);
        
        drugSelectEl.addEventListener('change', updateDosageFields);

        // 更新此處的事件監聽器，根據點擊的按鈕顯示對應的內容
        [openInfoModalBtn1, openInfoModalBtn2, openInfoModalBtn3, openInfoModalBtn4].forEach(btn => {
            btn.addEventListener('click', () => {
                const modalTitle = btn.textContent.trim();
                adviceModalTitleEl.textContent = modalTitle;
                adviceModalContentEl.innerHTML = modalContents[modalTitle];
                adviceModal.style.display = 'flex';
            });
        });

        closeAdviceModalBtn.addEventListener('click', () => {
            adviceModal.style.display = 'none';
        });

        window.removeDrugEntry = removeDrugEntry;
        window.deleteDrug = deleteDrug;
        window.editDrug = editDrug;
        window.showMessage = showMessage;
        window.showConfirmation = showConfirmation;

        window.onload = setupFirebase;

    </script>
</body>
</html>
