<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naranjo Score ADR 評估工具</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體作為基礎，並確保中文字體顯示良好 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .score-display {
            transition: all 0.5s ease-in-out;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10 border border-gray-100">

        <!-- 標題與簡介 -->
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-primary mb-2">Naranjo Score ADR 評估工具</h1>
            <!-- 新增製作者註記 -->
            <p class="text-sm font-medium text-gray-500 mb-2">製作者 : 其仁藥師 2025年9月</p>
            <p class="text-gray-600 text-lg">計算藥物不良反應 (ADR) 與藥物關聯性的機率分數</p>
        </header>

        <!-- 說明區塊 -->
        <section class="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
            <h2 class="text-xl font-bold text-indigo-700 mb-2">💡 程式使用說明</h2>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                <li>操作步驟： 請依序填寫下方的 ADR 資訊欄位，並針對 10 個 Naranjo 問題選擇最符合的答案。</li>
                <li>分數計算： 每個問題都有預設的分數（+2, +1, 0, -1, -2）。選擇後，點擊「計算 Naranjo Score」按鈕即可得到總分及關聯性評估。</li>
                <li>匯出存檔： 點擊「匯出紀錄」按鈕，可將填寫的資訊與計算結果儲存為一個純文字 (`.txt`) 檔案，便於存檔備查。</li>
                <li>重設表單： 點擊「重設表單」將清除所有填寫的資料與結果。</li>
            </ul>
            <h2 class="text-xl font-bold text-indigo-700 mt-4 mb-2">🧪 臨床意義 (Naranjo Score 解讀)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-indigo-200 bg-white shadow-sm rounded-lg">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider rounded-tl-lg">總分範圍</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider">關聯性等級</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider rounded-tr-lg">英文名稱</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-indigo-100">
                        <tr class="bg-white hover:bg-indigo-50">
                            <!-- 變更為：9 分或以上 -->
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">9 分或以上</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-green-700 font-semibold">確定 (Definite)</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Definite</td>
                        </tr>
                        <tr class="bg-white hover:bg-indigo-50">
                            <!-- 變更為：5 - 8 分 -->
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">5 - 8 分</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-yellow-700 font-semibold">很可能 (Probable)</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Probable</td>
                        </tr>
                        <tr class="bg-white hover:bg-indigo-50">
                            <!-- 變更為：1 - 4 分 -->
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">1 - 4 分</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-orange-700 font-semibold">可能 (Possible)</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Possible</td>
                        </tr>
                        <tr class="bg-white hover:bg-indigo-50">
                            <!-- 變更為：0 分或以下 -->
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">0 分或以下</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-red-700 font-semibold">存疑 (Doubtful)</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Doubtful</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 基本資訊輸入 -->
        <section class="mb-10 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">📋 ADR 紀錄與病人資訊</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="patientId" class="block text-sm font-medium text-gray-700">病歷號/姓名</label>
                    <input type="text" id="patientId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border" placeholder="輸入病歷號或姓名">
                </div>
                <div>
                    <label for="suspectDrug" class="block text-sm font-medium text-gray-700">懷疑藥物名稱</label>
                    <input type="text" id="suspectDrug" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border" placeholder="輸入藥物商品名或學名">
                </div>
                <div class="md:col-span-2">
                    <label for="adrDescription" class="block text-sm font-medium text-gray-700">不良反應描述</label>
                    <textarea id="adrDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border" placeholder="請詳細描述不良反應的症狀、發生時間等"></textarea>
                </div>
            </div>
        </section>

        <!-- Naranjo 問題區塊 -->
        <form id="naranjoForm" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">❓ Naranjo Score 問卷 (10 題)</h2>

            <!-- 問題列表 -->
            <!-- 每個問題結構 (Q1-Q10) -->
            <div id="questionsContainer" class="space-y-6">
                <!-- Q1 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">1. 以前是否有關於此種不良反應確定的研究報告？</p>
                    <div class="flex flex-wrap gap-4" data-question="q1">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q1" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q1" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q1" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q2 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">2. 不良反應是在給予懷疑藥物之後才出現嗎？</p>
                    <div class="flex flex-wrap gap-4" data-question="q2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q2" value="2" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+2)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q2" value="-1" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (-1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q2" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q3 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">3. 在停用藥物或給予特定拮抗劑後，不良反應是否減輕？</p>
                    <div class="flex flex-wrap gap-4" data-question="q3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q3" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q3" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q3" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q4 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">4. 停藥一段時間再重新服用此藥，同樣的不良反應是否再發生？</p>
                    <div class="flex flex-wrap gap-4" data-question="q4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q4" value="2" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+2)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q4" value="-1" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (-1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q4" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q5 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">5. 有沒有其他原因(此藥物之外)可以引起同樣的不良反應？</p>
                    <div class="flex flex-wrap gap-4" data-question="q5">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q5" value="-1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (-1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q5" value="2" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (+2)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q5" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q6 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">6. 當給予安慰劑時，此項不良反應是否再發生？</p>
                    <div class="flex flex-wrap gap-4" data-question="q6">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q6" value="-1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (-1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q6" value="1" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q6" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q7 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">7. 此藥物的血中濃度是否達到中毒劑量？</p>
                    <div class="flex flex-wrap gap-4" data-question="q7">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q7" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q7" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q7" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q8 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">8. 藥物劑量與不良反應的程度是否成正向關係？</p>
                    <div class="flex flex-wrap gap-4" data-question="q8">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q8" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q8" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q8" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q9 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">9. 病人過去對同樣獲類似藥物是否也發生同樣的不良反應？</p>
                    <div class="flex flex-wrap gap-4" data-question="q9">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q9" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q9" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q9" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

                <!-- Q10 -->
                <div class="p-4 rounded-lg bg-white border border-gray-200 hover:shadow-md transition duration-150">
                    <p class="font-medium text-gray-900 mb-2">10. 此項不良反應是否有客觀的證據證明是藥物引起的？(如：特定實驗室數據、報告等)</p>
                    <div class="flex flex-wrap gap-4" data-question="q10">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q10" value="1" required class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">是 (+1)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q10" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">否 (0)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="q10" value="0" class="form-radio text-primary h-4 w-4 focus:ring-primary">
                            <span class="text-sm text-gray-700">不知道/未評估 (0)</span>
                        </label>
                    </div>
                </div>

            </div>

            <!-- 操作按鈕 -->
            <div class="mt-8 flex flex-col sm:flex-row gap-4">
                <button type="button" id="calculateBtn" class="flex-1 py-3 px-4 bg-secondary text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-[1.02]">
                    計算 Naranjo Score
                </button>
                <button type="button" id="exportBtn" class="flex-1 py-3 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 transform hover:scale-[1.02]">
                    匯出紀錄
                </button>
                <button type="button" id="resetBtn" class="flex-1 py-3 px-4 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-[1.02]">
                    重設表單
                </button>
            </div>
        </form>

        <!-- 結果顯示區塊 -->
        <section id="resultSection" class="mt-10 p-6 bg-primary/10 rounded-xl border-l-4 border-primary hidden">
            <h2 class="text-2xl font-bold text-primary mb-4">✨ 評估結果</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div class="bg-primary text-white p-4 rounded-lg score-display">
                    <p class="text-sm font-light">Naranjo 總分</p>
                    <p id="totalScore" class="text-4xl font-extrabold"></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-inner border border-primary/30">
                    <p class="text-sm font-light text-gray-600">關聯性評估</p>
                    <p id="interpretation" class="text-2xl font-bold text-primary"></p>
                    <p id="interpretationEnglish" class="text-sm text-gray-500 mt-1"></p>
                </div>
            </div>
            <p id="messageBox" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm hidden"></p>
        </section>

    </div>

    <footer class="text-center mt-10 text-gray-500 text-xs">
        &copy; Naranjo Score Tool (中文版) - 僅供臨床參考與教學用途。
    </footer>

    <script>
        // Naranjo 評估工具的 JavaScript 邏輯

        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const exportBtn = document.getElementById('exportBtn');
        const naranjoForm = document.getElementById('naranjoForm');
        const resultSection = document.getElementById('resultSection');
        const totalScoreDisplay = document.getElementById('totalScore');
        const interpretationDisplay = document.getElementById('interpretation');
        const interpretationEnglishDisplay = document.getElementById('interpretationEnglish');
        const messageBox = document.getElementById('messageBox');

        /**
         * @typedef {'確定' | '很可能' | '可能' | '存疑'} InterpretationCN
         * @typedef {'Definite' | 'Probable' | 'Possible' | 'Doubtful'} InterpretationEN
         * @typedef {{cn: InterpretationCN, en: InterpretationEN}} InterpretationResult
         */

        /**
         * 根據總分決定 Naranjo 評估結果。
         * @param {number} score - 總分
         * @returns {InterpretationResult} 評估結果（中文和英文）
         */
        function getInterpretation(score) {
            if (score >= 9) {
                return { cn: '確定', en: 'Definite' };
            } else if (score >= 5) {
                return { cn: '很可能', en: 'Probable' };
            } else if (score >= 1) {
                return { cn: '可能', en: 'Possible' };
            } else {
                return { cn: '存疑', en: 'Doubtful' };
            }
        }

        /**
         * 顯示提示訊息 (取代 alert())
         * @param {string} message - 要顯示的訊息
         * @param {string} type - 訊息類型 ('error', 'success', 'info')
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-3 rounded-lg text-sm';
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                    break;
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-700');
                    break;
            }
            // 訊息會在 5 秒後自動隱藏
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * 執行 Naranjo Score 計算
         */
        function calculateNaranjoScore() {
            try {
                let totalScore = 0;
                let allAnswered = true;
                const questions = 10;

                for (let i = 1; i <= questions; i++) {
                    const selector = `input[name="q${i}"]:checked`;
                    const checkedInput = naranjoForm.querySelector(selector);

                    if (!checkedInput) {
                        allAnswered = false;
                        // 標記未回答的問題以提示使用者
                        const questionDiv = naranjoForm.querySelector(`div[data-question="q${i}"]`).closest('div.p-4');
                        questionDiv.classList.add('border-danger', 'ring-2', 'ring-danger/50');
                        questionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // 移除標記 (5 秒後)
                        setTimeout(() => {
                            questionDiv.classList.remove('border-danger', 'ring-2', 'ring-danger/50');
                        }, 5000);
                        break;
                    }

                    // 累積分數
                    totalScore += parseInt(checkedInput.value, 10);
                }

                if (!allAnswered) {
                    resultSection.classList.add('hidden');
                    showMessage('⚠️ 請回答所有 10 個 Naranjo 問題才能計算總分！');
                    return;
                }

                // 顯示結果
                const result = getInterpretation(totalScore);

                totalScoreDisplay.textContent = totalScore;
                interpretationDisplay.textContent = `${result.cn} (${result.en})`;
                interpretationEnglishDisplay.textContent = `評估結果：${result.cn}`;
                
                resultSection.classList.remove('hidden');
                resultSection.classList.remove('border-primary', 'border-yellow-600', 'border-orange-600', 'border-red-600');
                
                // 根據結果調整顯示顏色
                switch (result.en) {
                    case 'Definite':
                        resultSection.classList.add('border-secondary');
                        totalScoreDisplay.closest('div.score-display').classList.add('bg-secondary');
                        totalScoreDisplay.closest('div.score-display').classList.remove('bg-primary');
                        break;
                    case 'Probable':
                        resultSection.classList.add('border-yellow-600');
                        totalScoreDisplay.closest('div.score-display').classList.add('bg-yellow-600');
                        totalScoreDisplay.closest('div.score-display').classList.remove('bg-primary');
                        break;
                    case 'Possible':
                        resultSection.classList.add('border-orange-600');
                        totalScoreDisplay.closest('div.score-display').classList.add('bg-orange-600');
                        totalScoreDisplay.closest('div.score-display').classList.remove('bg-primary');
                        break;
                    case 'Doubtful':
                        resultSection.classList.add('border-danger');
                        totalScoreDisplay.closest('div.score-display').classList.add('bg-danger');
                        totalScoreDisplay.closest('div.score-display').classList.remove('bg-primary');
                        break;
                }
                
                // 捲動到結果區塊
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error("計算時發生錯誤:", error);
                showMessage('🚫 計算發生系統錯誤，請檢查主控台 (Console)。');
            }
        }

        /**
         * 將評估結果匯出為純文字檔案
         */
        function exportRecord() {
            try {
                // 確保先執行計算
                calculateNaranjoScore();

                // 檢查是否有分數，如果沒有，則不能匯出
                if (resultSection.classList.contains('hidden')) {
                    showMessage('🚫 請先完成所有問題並計算分數才能匯出紀錄。');
                    return;
                }

                const patientId = document.getElementById('patientId').value.trim() || 'N/A';
                const suspectDrug = document.getElementById('suspectDrug').value.trim() || 'N/A';
                const adrDescription = document.getElementById('adrDescription').value.trim() || 'N/A';
                const totalScore = totalScoreDisplay.textContent;
                const interpretationCN = interpretationDisplay.textContent;

                const date = new Date().toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // 收集 Naranjo 問題的答案
                let answersText = "";
                const questionsList = naranjoForm.querySelectorAll('div[data-question]');
                questionsList.forEach((qDiv, index) => {
                    const qNum = index + 1;
                    const questionText = qDiv.previousElementSibling.textContent.split('. ')[1];
                    const selectedInput = qDiv.querySelector(`input[name="q${qNum}"]:checked`);
                    const selectedLabel = selectedInput ? selectedInput.nextElementSibling.textContent : '未作答';
                    const score = selectedInput ? selectedInput.value : 'N/A';
                    answersText += `\n- Q${qNum} (${score}分): ${questionText}\n  > 選擇答案: ${selectedLabel}`;
                });

                const fileContent = `
=============================================
 Naranjo Score ADR 評估紀錄 (中文版)
=============================================

建立時間: ${date}
評估工具版本: Naranjo Score
製作者: 其仁藥師 2025年9月

--- 病人與 ADR 資訊 ---
病歷號/姓名: ${patientId}
懷疑藥物名稱: ${suspectDrug}
不良反應描述:
${adrDescription}
---------------------------------------------

--- 評估結果 ---
Naranjo 總分: ${totalScore} 分
關聯性評估: ${interpretationCN}
---------------------------------------------

--- Naranjo 評分細節 ---
${answersText}
=============================================
`;
                
                // 建立 Blob 和下載連結
                const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                const fileName = `ADR_Naranjo_${patientId}_${new Date().toISOString().slice(0, 10)}.txt`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                
                // 模擬點擊下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('✅ 評估紀錄已成功匯出！', 'success');

            } catch (error) {
                console.error("匯出時發生錯誤:", error);
                showMessage('🚫 匯出檔案時發生錯誤，請重試。');
            }
        }

        /**
         * 重設表單
         */
        function resetForm() {
            naranjoForm.reset();
            resultSection.classList.add('hidden');
            totalScoreDisplay.closest('div.score-display').classList.add('bg-primary');
            totalScoreDisplay.closest('div.score-display').classList.remove('bg-secondary', 'bg-yellow-600', 'bg-orange-600', 'bg-danger');
            showMessage('ℹ️ 表單已重設。', 'info');
            // 清除額外資訊
            document.getElementById('patientId').value = '';
            document.getElementById('suspectDrug').value = '';
            document.getElementById('adrDescription').value = '';
        }

        // 事件監聽器
        calculateBtn.addEventListener('click', calculateNaranjoScore);
        exportBtn.addEventListener('click', exportRecord);
        resetBtn.addEventListener('click', resetForm);
        
        // 初始化時隱藏訊息框
        document.addEventListener('DOMContentLoaded', () => {
            messageBox.classList.add('hidden');
        });

    </script>
</body>
</html>